"use strict";(self["webpackChunkeco_friendly"]=self["webpackChunkeco_friendly"]||[]).push([[2281],{18548:function(e,t,i){i.d(t,{Z:function(){return r}});var s=i(8693);class r{constructor(e){this.size=0,this._start=0,this.maxSize=e,this._buffer=new Array(e)}get entries(){return this._buffer}enqueue(e){if(this.size===this.maxSize){const t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return this._buffer[(this._start+this.size++)%this.maxSize]=e,null}dequeue(){if(0===this.size)return null;const e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}peek(){return 0===this.size?null:this._buffer[this._start]}find(e){if(0===this.size)return null;for(const t of this._buffer)if((0,s.pC)(t)&&e(t))return t;return null}clear(e){let t=this.dequeue();for(;(0,s.pC)(t);)e&&e(t),t=this.dequeue()}}},50857:function(e,t,i){i.d(t,{$7:function(){return u},$e:function(){return a},E0:function(){return l},N5:function(){return c},lW:function(){return o}});i(48675),i(3462),i(37380),i(1118),i(82801),i(81653);var s=i(22130),r=i(8693),n=i(99659);function a(e){const t=l(e);return(0,r.pC)(t)?t.toDataURL():""}async function o(e){const t=l(e);if((0,r.Wi)(t))throw new s.Z("imageToArrayBuffer","Unsupported image type");const i=await h(e),n=await new Promise((e=>t.toBlob(e,i)));if(!n)throw new s.Z("imageToArrayBuffer","Failed to encode image");return{data:await n.arrayBuffer(),type:i}}async function h(e){if(!(e instanceof HTMLImageElement))return"image/png";const t=e.src;if((0,n.HK)(t)){const{mediaType:e}=(0,n.sJ)(t);return"image/jpeg"===e?e:"image/png"}return/\.png$/i.test(t)?"image/png":/\.(jpg|jpeg)$/i.test(t)?"image/jpeg":"image/png"}function l(e){if(e instanceof HTMLCanvasElement)return e;if(e instanceof HTMLVideoElement)return null;const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");return e instanceof HTMLImageElement?i.drawImage(e,0,0,e.width,e.height):e instanceof ImageData&&i.putImageData(e,0,0),t}function c(e){const t=[],i=new Uint8Array(e);for(let s=0;s<i.length;s++)t.push(String.fromCharCode(i[s]));return"data:application/octet-stream;base64,"+btoa(t.join(""))}function u(e){if(e.byteLength<8)return!1;const t=new Uint8Array(e);return 137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]&&13===t[4]&&10===t[5]&&26===t[6]&&10===t[7]}},50405:function(e,t,i){i.d(t,{AM:function(){return _}});var s=i(61445),r=i(92698),n=i(81653),a=i(86232),o=i(93622),h=i(58006),l=(i(94315),i(77623)),c=i(42484),u=i(60289);const d=-1;let _=class extends r.Z{constructor(e){super(e),this._from=null,this._to=null,this._final=null,this._current=[],this._time=0,this.duration=(0,n.Z)("mapview-transitions-duration"),this.effects=[]}set effect(e){if(this._get("effect")!==(e=e||"")){this._set("effect",e);try{this._transitionTo(p(e))}catch(t){this._transitionTo([]),o.Z.getLogger(this.declaredClass).warn("Invalid Effect",{effect:e,error:t})}}}get hasEffects(){return this.transitioning||!!this.effects.length}set scale(e){this._updateForScale(e)}get transitioning(){return null!==this._to}canTransitionTo(e){try{return this.scale>0&&m(this._current,p(e),this.scale)}catch{return!1}}transitionStep(e,t){this._applyTimeTransition(e),this._updateForScale(t)}end(){this._applyTimeTransition(this.duration)}_transitionTo(e){this.scale>0&&m(this._current,e,this.scale)?(this._final=e,this._to=(0,a.d9)(e),f(this._current,this._to,this.scale),this._from=(0,a.d9)(this._current),this._time=0):(this._from=this._to=this._final=null,this._current=e),this._set("effects",this._current[0]?(0,a.d9)(this._current[0].effects):[])}_applyTimeTransition(e){if(!(this._to&&this._from&&this._current&&this._final))return;this._time+=e;const t=Math.min(1,this._time/this.duration);for(let i=0;i<this._current.length;i++){const e=this._current[i],s=this._from[i],r=this._to[i];e.scale=g(s.scale,r.scale,t);for(let i=0;i<e.effects.length;i++){const n=e.effects[i],a=s.effects[i],o=r.effects[i];n.interpolate(a,o,t)}}1===t&&(this._current=this._final,this._set("effects",this._current[0]?(0,a.d9)(this._current[0].effects):[]),this._from=this._to=this._final=null)}_updateForScale(e){if(this._set("scale",e),0===this._current.length)return;const t=this._current,i=this._current.length-1;let s,r,n=1;if(1===t.length||e>=t[0].scale)r=s=t[0].effects;else if(e<=t[i].scale)r=s=t[i].effects;else for(let a=0;a<i;a++){const i=t[a],o=t[a+1];if(i.scale>=e&&o.scale<=e){n=(e-i.scale)/(o.scale-i.scale),s=i.effects,r=o.effects;break}}for(let a=0;a<this.effects.length;a++)this.effects[a].interpolate(s[a],r[a],n)}};function p(e){const t=(0,c.Q)(e)||[];return b(t)?[{scale:d,effects:t}]:t}function m(e,t,i){return!e[0]?.effects||!t[0]?.effects||!((e[0]?.scale===d||t[0]?.scale===d)&&(e.length>1||t.length>1)&&i<=0)&&(0,u.AS)(e[0].effects,t[0].effects)}function f(e,t,i){const s=e.length>t.length?e:t,r=e.length>t.length?t:e,n=r[r.length-1],a=n?.scale??i,o=n?.effects??[];for(let h=r.length;h<s.length;h++)r.push({scale:a,effects:[...o]});for(let h=0;h<s.length;h++)r[h].scale=r[h].scale===d?i:r[h].scale,s[h].scale=s[h].scale===d?i:s[h].scale,(0,u.uF)(r[h].effects,s[h].effects)}function g(e,t,i){return e+(t-e)*i}function b(e){const t=e[0];return!!t&&"type"in t}(0,s._)([(0,h.Cb)()],_.prototype,"_to",void 0),(0,s._)([(0,h.Cb)()],_.prototype,"duration",void 0),(0,s._)([(0,h.Cb)({value:""})],_.prototype,"effect",null),(0,s._)([(0,h.Cb)({readOnly:!0})],_.prototype,"effects",void 0),(0,s._)([(0,h.Cb)({readOnly:!0})],_.prototype,"hasEffects",null),(0,s._)([(0,h.Cb)({value:0})],_.prototype,"scale",null),(0,s._)([(0,h.Cb)({readOnly:!0})],_.prototype,"transitioning",null),_=(0,s._)([(0,l.j)("esri.layers.effects.EffectView")],_)},66544:function(e,t,i){i.d(t,{Z:function(){return h}});i(48675),i(3462),i(37380),i(1118);var s=i(21),r=i(11633),n=i(6640),a=i(79913);const o=512;class h{constructor(e){this._resourceManager=e}dispose(){this._rasterizationCanvas=null}rasterizeJSONResource(e,t,i){if(this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),"simple-fill"===e.type||"esriSFS"===e.type){const[i,r,n]=s.fN.rasterizeSimpleFill(this._rasterizationCanvas,e.style,t);return{size:[r,n],image:new Uint32Array(i.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0}}if("simple-line"===e.type||"esriSLS"===e.type||"line"===e.type&&e.dashTemplate){let t,i;if("simple-line"===e.type||"esriSLS"===e.type)switch(t=(0,s.U1)(e.style,e.cap),e.cap){case"butt":i="Butt";break;case"square":i="Square";break;default:i="Round"}else t=e.dashTemplate,i=e.cim.capStyle;const[r,n,a]=s.fN.rasterizeSimpleLine(t,i);return{size:[n,a],image:new Uint32Array(r.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let a,o,h;if("simple-marker"===e.type||"esriSMS"===e.type||"line-marker"===e.type?(a=s.B$.fromSimpleMarker(e),h=(0,n.Fp)(a)):e.cim&&"CIMHatchFill"===e.cim.type?(a=s.B$.fromCIMHatchFill(e.cim),o=new r.Z(a.frame.xmin,-a.frame.ymax,a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin)):e.cim.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===e.cim.markerPlacement.type?(a=s.B$.fromCIMInsidePolygon(e.cim),o=new r.Z(a.frame.xmin,-a.frame.ymax,a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin)):(a=e.cim,h=(0,n.Fp)(a)),h&&!i){const[e,t,i]=(0,n.RL)(h);return e?{size:[t,i],image:new Uint32Array(e.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}const[l,c,u,d,_]=s.B$.rasterize(this._rasterizationCanvas,a,o,this._resourceManager,!i);return l?{size:[c,u],image:new Uint32Array(l.buffer),sdf:!1,simplePattern:!1,anchorX:d,anchorY:_}:null}rasterizeImageResource(e,t,i,s){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=t;const r=this._rasterizationCanvas.getContext("2d");i instanceof ImageData?r.putImageData(i,0,0):(i.setAttribute("width",`${e}px`),i.setAttribute("height",`${t}px`),r.drawImage(i,0,0,e,t));const n=r.getImageData(0,0,e,t),h=new Uint8Array(n.data);if(s)for(const a of s)if(a&&a.oldColor&&4===a.oldColor.length&&a.newColor&&4===a.newColor.length){const[e,t,i,s]=a.oldColor,[r,n,o,l]=a.newColor;if(e===r&&t===n&&i===o&&s===l)continue;for(let a=0;a<h.length;a+=4)e===h[a]&&t===h[a+1]&&i===h[a+2]&&s===h[a+3]&&(h[a]=r,h[a+1]=n,h[a+2]=o,h[a+3]=l)}let l;for(let a=0;a<h.length;a+=4)l=h[a+3]/255,h[a]=h[a]*l,h[a+1]=h[a+1]*l,h[a+2]=h[a+2]*l;let c=h,u=e,d=t;const _=o;if(u>=_||d>=_){const i=u/d;i>1?(u=_,d=Math.round(_/i)):(d=_,u=Math.round(_*i)),c=new Uint8Array(4*u*d);const s=new Uint8ClampedArray(c.buffer);(0,a.TT)(h,e,t,s,u,d,!1)}return{size:[u,d],image:new Uint32Array(c.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}},32988:function(e,t,i){i.d(t,{W:function(){return a}});var s=i(57409),r=i(50405),n=i(75393);class a extends n.s{constructor(){super(...arguments),this._childrenSet=new Set,this._needsSort=!1,this.children=[],this._effectView=null}get blendMode(){return this._blendMode}set blendMode(e){this._blendMode=e,this.requestRender()}get clips(){return this._clips}set clips(e){this._clips=e,this.children.forEach((t=>t.clips=e))}get computedEffects(){return this._effectView?.effects??null}get effect(){return this._effectView?.effect??""}set effect(e){(this._effectView||e)&&(this._effectView||(this._effectView=new r.AM),this._effectView.effect=e,this.requestRender())}updateTransitionProperties(e,t){super.updateTransitionProperties(e,t),this._effectView&&(this._effectView.transitionStep(e,t),this._effectView.transitioning&&this.requestRender())}doRender(e){const t=this.createRenderParams(e);this.renderChildren(t)}addChild(e){return this.addChildAt(e,this.children.length)}addChildAt(e,t=this.children.length){if(!e)return e;if(this.contains(e))return e;this._needsSort=!0;const i=e.parent;return i&&i!==this&&i.removeChild(e),t>=this.children.length?this.children.push(e):this.children.splice(t,0,e),this._childrenSet.add(e),e.parent=this,e.stage=this.stage,this!==this.stage&&(e.clips=this.clips),this.requestRender(),e}contains(e){return this._childrenSet.has(e)}removeAllChildren(){this._childrenSet.clear(),this._needsSort=!0;for(const e of this.children)this!==this.stage&&(e.clips=null),e.stage=null,e.parent=null;this.children.length=0}removeChild(e){return this.contains(e)?this.removeChildAt(this.children.indexOf(e)):e}removeChildAt(e){if(e<0||e>=this.children.length)return null;this._needsSort=!0;const t=this.children.splice(e,1)[0];return this._childrenSet.delete(t),this!==this.stage&&(t.clips=null),t.stage=null,t.parent=null,t}sortChildren(e){this._needsSort&&(this.children.sort(e),this._needsSort=!1)}_createTransforms(){return{dvs:(0,s.c)()}}onAttach(){super.onAttach();const e=this.stage;for(const t of this.children)t.stage=e}onDetach(){super.onDetach();for(const e of this.children)e.stage=null}renderChildren(e){for(const t of this.children)t.beforeRender(e);for(const t of this.children)t.processRender(e);for(const t of this.children)t.afterRender(e)}createRenderParams(e){return{...e,blendMode:this.blendMode,effects:this.computedEffects,globalOpacity:e.globalOpacity*this.computedOpacity,inFadeTransition:this.inFadeTransition}}}},57914:function(e,t,i){i.d(t,{Z:function(){return n}});var s=i(34150),r=i(21486);class n extends r.Z{renderChildren(e){this.attributeView.bindTextures(e.context,!1),this.children.some((e=>e.hasData))&&(super.renderChildren(e),e.drawPhase===s.jx.MAP&&this._renderChildren(e),this.hasHighlight()&&e.drawPhase===s.jx.HIGHLIGHT&&this._renderHighlight(e),this._boundsRenderer&&this._boundsRenderer.doRender(e))}_renderHighlight(e){const{painter:t}=e,i=t.effects.highlight;i.bind(e),this._renderChildren(e,i.defines),i.draw(e),i.unbind()}}},22281:function(e,t,i){i.r(t),i.d(t,{GraphicContainer:function(){return Ps.Z},GraphicsView2D:function(){return Ss.Z},LabelManager:function(){return Os},MagnifierView2D:function(){return ur},MapViewNavigation:function(){return rr},Stage:function(){return qi}});i(48675),i(3462),i(37380),i(1118);var s=i(22130),r=i(48674),n=i(81653),a=i(8693),o=i(18105),h=i(3047),l=i(57409),c=i(96770),u=i(32988),d=i(34150),_=i(10482),p=i(34984),m=i(68917),f=i(65421);const g={shaders:{vertexShader:(0,f.w)("bitBlit/bitBlit.vert"),fragmentShader:(0,f.w)("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])};var b=i(15625),w=i(17923),y=i(78026),v=i(50659);class x{constructor(){this._initialized=!1}dispose(){this._program=(0,a.O3)(this._program),this._vertexArrayObject=(0,a.O3)(this._vertexArrayObject)}render(e,t,i,s){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA,w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),t.setSamplingMode(i),e.bindTexture(t,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",s),e.drawArrays(w.MX.TRIANGLE_STRIP,0,4),e.bindTexture(null,0),e.bindVAO())}_initialize(e){if(this._initialized)return!0;const t=(0,y.H)(e,g);if(!t)return!1;const i=new Int8Array(16);i[0]=-1,i[1]=-1,i[2]=0,i[3]=0,i[4]=1,i[5]=-1,i[6]=1,i[7]=0,i[8]=-1,i[9]=1,i[10]=0,i[11]=1,i[12]=1,i[13]=1,i[14]=1,i[15]=1;const s=g.attributes,r=new v.U(e,s,m.As,{geometry:b.f.createVertex(e,w.l1.STATIC_DRAW,i)});return this._program=t,this._vertexArrayObject=r,this._initialized=!0,!0}}i(21703);var T=i(38991);const E=e=>{let t="";t+=e[0].toUpperCase();for(let i=1;i<e.length;i++){const s=e[i];s===s.toUpperCase()?(t+="_",t+=s):t+=s.toUpperCase()}return t},M=e=>{const t={};for(const i in e)t[E(i)]=e[i];return(0,T.K)(t)},B=(e,t,i,s)=>{const r=e+e.substring(e.lastIndexOf("/")),n=t+t.substring(t.lastIndexOf("/")),a=M(s);return{attributes:i,shaders:{vertexShader:a+(0,f.w)(`${r}.vert`),fragmentShader:a+(0,f.w)(`${n}.frag`)}}},R=e=>e===d.jx.HITTEST||e===d.jx.LABEL_ALPHA,C=e=>(R(e)?1:0)|(e===d.jx.HIGHLIGHT?2:0),F=({rendererInfo:e,drawPhase:t},i,s,r)=>`${i.getVariationHash()}-${r.join(".")}-${C(t)}-${e.getVariationHash()}-${(0,a.pC)(s)&&s.join(".")}`,O=(e,t,i,s)=>{const r=s.reduce(((t,i)=>({...t,[i]:e.context.driverTest[i]})),{}),n={...t.getVariation(),...e.rendererInfo.getVariation(),highlight:e.drawPhase===d.jx.HIGHLIGHT,id:R(e.drawPhase),...r};if((0,a.pC)(i))for(const a of i)n[a]=!0;return n};class S{constructor(e){this._rctx=e,this._programByKey=new Map}dispose(){this._programByKey.forEach((e=>e.dispose())),this._programByKey.clear()}getProgram(e,t=[],i=[]){const s=e.vsPath+"."+e.fsPath+JSON.stringify(t)+i.join(".");if(this._programByKey.has(s))return this._programByKey.get(s);const r=i.reduce(((e,t)=>({...e,[t]:this._rctx.driverTest[t]})),{}),n={...t.map((e=>"string"==typeof e?{name:e,value:!0}:e)).reduce(((e,t)=>({...e,[t.name]:t.value})),{}),...r},{vsPath:a,fsPath:o,attributes:h}=e,l=B(a,o,h,n),c=this._rctx.programCache.acquire(l.shaders.vertexShader,l.shaders.fragmentShader,l.attributes);if(!c)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(s,c),c}getMaterialProgram(e,t,i,s,r,n=["ignoresSamplerPrecision"]){const a=F(e,t,r,n);if(this._programByKey.has(a))return this._programByKey.get(a);const o=O(e,t,r,n),h=B(i,i,s,o),l=this._rctx.programCache.acquire(h.shaders.vertexShader,h.shaders.fragmentShader,h.attributes);if(!l)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(a,l),l}}i(26699),i(82801);var P=i(21383),A=i(94848),z=i(34658),U=i(93622),I=i(92454),D=i(30524),L=i(47001),N=i(20282),k=i(66544),G=i(19440),H=i(54781),V=i(30638);class Z{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new V.Z(0,0,e,t))}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new V.Z;let i=null,s=-1;for(let r=0;r<this._free.length;++r){const n=this._free[r];e<=n.width&&t<=n.height&&(null===i||n.y<=i.y&&n.x<=i.x)&&(i=n,s=r)}return null===i?new V.Z:(this._free.splice(s,1),i.width<i.height?(i.width>e&&this._free.push(new V.Z(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new V.Z(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new V.Z(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new V.Z(i.x,i.y+t,e,i.height-t))),new V.Z(i.x,i.y,e,t))}release(e){for(let t=0;t<this._free.length;++t){const i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}var q=i(29964);const W=256,j=e=>Math.floor(e/256);function $(e){const t=new Set;for(const i of e)t.add(j(i));return t}function X(e,t,i){return e.has(t)||e.set(t,i().then((()=>{e.delete(t)})).catch((i=>{e.delete(t),(0,I.H9)(i)}))),e.get(t)}const Y=e=>({rect:new V.Z(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:e,sdf:!0});class Q{constructor(e,t,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=e,this.height=t,this._glyphSource=i,this._binPack=new Z(e-4,t-4),this._glyphData.push(new Uint8Array(e*t)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}dispose(){this._binPack=null;for(const e of this._textures)e&&e.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyph(){const e=[117,149,181,207,207,181,149,117],t=[];for(let s=0;s<e.length;s++){const i=e[s];for(let e=0;e<11;e++)t.push(i)}const i={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(t)};this._recordGlyph(i)}async getGlyphItems(e,t,i){const s=this._getGlyphCache(e);return await this._fetchRanges(e,t,i),t.map((t=>this._getMosaicItem(s,e,t)))}bind(e,t,i,s){const r=this._getTexture(e,i);r.setSamplingMode(t),this._dirties[i]&&(r.setData(this._glyphData[i]),this._dirties[i]=!1),e.bindTexture(r,s)}_getGlyphCache(e){return this._glyphCache[e]||(this._glyphCache[e]={}),this._glyphCache[e]}_getTexture(e,t){return this._textures[t]||(this._textures[t]=new q.x(e,{pixelFormat:w.VI.ALPHA,dataType:w.Br.UNSIGNED_BYTE,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[t]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(e,t,i){const s=$(t),r=[];s.forEach((t=>{r.push(this._fetchRange(e,t,i))})),await Promise.all(r)}async _fetchRange(e,t,i){if(t>W)return null;const s=e+t;return X(this._rangePromises,s,(()=>this._glyphSource.getRange(e,t,i)))}_getMosaicItem(e,t,i){if(!e[i]){const s=this._glyphSource.getGlyph(t,i);if(!s||!s.metrics)return Y(i);const r=this._recordGlyph(s),n=this._currentPage,a=s.metrics;e[i]={rect:r,page:n,metrics:a,code:i,sdf:!0},this._invalidate()}return e[i]}_recordGlyph(e){const t=e.metrics;let i;if(0===t.width)i=new V.Z(0,0,0,0);else{const s=3,r=t.width+2*s,a=t.height+2*s;i=this._binPack.allocate(r,a),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new Z(this.width-4,this.height-4),i=this._binPack.allocate(r,a));const o=this._glyphData[this._currentPage],h=e.bitmap;let l,c;if(h)for(let e=0;e<a;e++){l=r*e,c=this.width*(i.y+e)+i.x;for(let e=0;e<r;e++)o[c+e]=h[l+e]}(0,n.Z)("esri-glyph-debug")&&this._showDebugPage(o)}return i}_showDebugPage(e){const t=document.createElement("canvas"),i=t.getContext("2d"),s=new ImageData(this.width,this.height),r=s.data;t.width=this.width,t.height=this.height,t.style.border="1px solid black";for(let n=0;n<e.length;++n)r[4*n+0]=e[n],r[4*n+1]=0,r[4*n+2]=0,r[4*n+3]=255;i.putImageData(s,0,0),document.body.appendChild(t)}}var K=i(46354);class J{constructor(e){for(this._metrics=[],this._bitmaps=[];e.next();)switch(e.tag()){case 1:{const t=e.getMessage();for(;t.next();)switch(t.tag()){case 3:{const e=t.getMessage();let i,s,r,n,a,o,h;for(;e.next();)switch(e.tag()){case 1:i=e.getUInt32();break;case 2:s=e.getBytes();break;case 3:r=e.getUInt32();break;case 4:n=e.getUInt32();break;case 5:a=e.getSInt32();break;case 6:o=e.getSInt32();break;case 7:h=e.getUInt32();break;default:e.skip()}e.release(),i&&(this._metrics[i]={width:r,height:n,left:a,top:o,advance:h},this._bitmaps[i]=s);break}default:t.skip()}t.release();break}default:e.skip()}}getMetrics(e){return this._metrics[e]}getBitmap(e){return this._bitmaps[e]}}class ee{constructor(){this._ranges=[]}getRange(e){return this._ranges[e]}addRange(e,t){this._ranges[e]=t}}class te{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,t,i){const s=this._getFontStack(e);if(s.getRange(t))return Promise.resolve();const r=256*t,n=r+255,a=this._baseURL.replace("{fontstack}",e).replace("{range}",r+"-"+n);return(0,A["default"])(a,{responseType:"array-buffer",...i}).then((e=>{s.addRange(t,new J(new K.Z(new Uint8Array(e.data),new DataView(e.data))))}))}getGlyph(e,t){const i=this._getFontStack(e);if(!i)return;const s=Math.floor(t/256);if(s>256)return;const r=i.getRange(s);return r?{metrics:r.getMetrics(t),bitmap:r.getBitmap(t)}:void 0}_getFontStack(e){let t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new ee),t}}var ie=i(16509);const se=1e20;class re{constructor(e){this.size=e;const t=document.createElement("canvas");t.width=t.height=e,this._context=t.getContext("2d"),this._gridOuter=new Float64Array(e*e),this._gridInner=new Float64Array(e*e),this._f=new Float64Array(e),this._d=new Float64Array(e),this._z=new Float64Array(e+1),this._v=new Int16Array(e)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(e,t,i=31){this._initSVG();const s=this.createSVGString(e);return new Promise(((e,r)=>{const n=new Image;n.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(s),n.onload=()=>{n.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(n,0,0,this.size,this.size);const t=this._context.getImageData(0,0,this.size,this.size),s=new Uint8Array(this.size*this.size*4);for(let e=0;e<this.size*this.size;e++){const i=t.data[4*e+3]/255;this._gridOuter[e]=1===i?0:0===i?se:Math.max(0,.5-i)**2,this._gridInner[e]=1===i?se:0===i?0:Math.max(0,i-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let e=0;e<this.size*this.size;e++){const t=this._gridOuter[e]-this._gridInner[e];(0,ie.I)(.5-t/(2*i),s,4*e)}e(s)};const a=t&&t.signal;a&&(0,I.fu)(a,(()=>r((0,I.zE)())))}))}_initSVG(){if(!this._svg){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("style","position: absolute;"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),document.body.appendChild(e),this._svg=e}}createSVGString(e){this._initSVG();const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d",e),this._svg.appendChild(t);const i=t.getBBox(),s=i.width/i.height,r=this.size/2;let n,a,o,h;if(s>1){a=n=r/i.width;const e=r*(1/s);o=this.size/4,h=r-e/2}else n=a=r/i.height,o=r-r*s/2,h=this.size/4;const l=-i.x*n+o,c=-i.y*a+h;t.setAttribute("style",`transform: matrix(${n}, 0, 0, ${a}, ${l}, ${c})`);const u=`<svg style="fill:red;" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${this._svg.innerHTML}</svg>`;return this._svg.removeChild(t),u}_edt(e,t,i){const s=this._f,r=this._d,n=this._v,a=this._z;for(let o=0;o<t;o++){for(let r=0;r<i;r++)s[r]=e[r*t+o];this._edt1d(s,r,n,a,i);for(let s=0;s<i;s++)e[s*t+o]=r[s]}for(let o=0;o<i;o++){for(let i=0;i<t;i++)s[i]=e[o*t+i];this._edt1d(s,r,n,a,t);for(let i=0;i<t;i++)e[o*t+i]=Math.sqrt(r[i])}}_edt1d(e,t,i,s,r){i[0]=0,s[0]=-se,s[1]=+se;for(let n=1,a=0;n<r;n++){let t=(e[n]+n*n-(e[i[a]]+i[a]*i[a]))/(2*n-2*i[a]);for(;t<=s[a];)a--,t=(e[n]+n*n-(e[i[a]]+i[a]*i[a]))/(2*n-2*i[a]);a++,i[a]=n,s[a]=t,s[a+1]=+se}for(let n=0,a=0;n<r;n++){for(;s[a+1]<n;)a++;t[n]=(n-i[a])*(n-i[a])+e[i[a]]}}}var ne=i(72558);function ae(e){return e&&"static"===e.type}class oe{constructor(e,t,i=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(e<=0||t<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=t,i>0&&(this._maxItemSize=i),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new Z(this._pageWidth,this._pageHeight);const s=Math.floor(this._pageWidth),r=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(s*r)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[0]}getHeight(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[1]}getPageTexture(e){return e<this._mosaicPages.length?this._mosaicPages[e].texture:null}has(e){return this._mosaicRects.has(e)}get itemCount(){return this._mosaicRects.size}getSpriteItem(e){return this._mosaicRects.get(e)}addSpriteItem(e,t,i,s,r,n){if(this._mosaicRects.has(e))return this._mosaicRects.get(e);let a,o,h;if(ae(i))[a,o,h]=this._allocateImage(t[0],t[1]);else{a=new V.Z(0,0,t[0],t[1]),o=this._mosaicPages.length;const e=void 0;this._mosaicPages.push({mosaicsData:i,size:[t[0]+2*G.fL,t[1]+2*G.fL],dirty:!0,texture:e})}if(a.width<=0||a.height<=0)return null;const l={rect:a,width:t[0],height:t[1],sdf:r,simplePattern:n,pixelRatio:1,page:o};return this._mosaicRects.set(e,l),ae(i)&&this._copy({rect:a,spriteSize:t,spriteData:i.data,page:o,pageSize:h,repeat:s,sdf:r}),l}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const e=this._spriteCopyQueue.pop();e&&this._copy(e)}getSpriteItems(e){const t={};for(const i of e)t[i]=this.getSpriteItem(i);return t}getMosaicItemPosition(e){const t=this.getSpriteItem(e),i=t&&t.rect;if(!i)return null;i.width=t.width,i.height=t.height;const s=t.width,r=t.height,n=G.fL,a=this._mosaicPages[t.page];return{size:[t.width,t.height],tl:[(i.x+n)/a[0],(i.y+n)/a[1]],br:[(i.x+n+s)/a[0],(i.y+n+r)/a[1]],page:t.page}}bind(e,t,i=0,s=0){const r=this._mosaicPages[i],n=r.mosaicsData;let a=r.texture;a||(a=he(e,n,r.size),r.texture=a),a.setSamplingMode(t),ae(n)?(e.bindTexture(a,s),r.dirty&&(a.setData(new Uint8Array(n.data.buffer)),a.generateMipmap())):n.data.bindFrame(e,a,s),r.dirty=!1}static _copyBits(e,t,i,s,r,n,a,o,h,l,c){let u=s*t+i,d=o*n+a;if(c){d-=n;for(let a=-1;a<=l;a++,u=((a+l)%l+s)*t+i,d+=n)for(let t=-1;t<=h;t++)r[d+t]=e[u+(t+h)%h]}else for(let _=0;_<l;_++){for(let t=0;t<h;t++)r[d+t]=e[u+t];u+=t,d+=n}}_copy(e){if(e.page>=this._mosaicPages.length)return;const t=this._mosaicPages[e.page],i=t.mosaicsData;if(!ae(t.mosaicsData))throw new s.Z("mapview-invalid-resource","unsuitable data type!");const r=e.spriteData,n=i.data;n&&r||console.error("Source or target images are uninitialized!"),oe._copyBits(r,e.spriteSize[0],0,0,n,e.pageSize[0],e.rect.x+G.fL,e.rect.y+G.fL,e.spriteSize[0],e.spriteSize[1],e.repeat),t.dirty=!0}_allocateImage(e,t){e+=2*G.fL,t+=2*G.fL;const i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){const i=2**Math.ceil((0,ne.k3)(e)),s=2**Math.ceil((0,ne.k3)(t)),r=new V.Z(0,0,e,t);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(i*s)},size:[i,s],dirty:!0,texture:void 0}),[r,this._mosaicPages.length-1,[i,s]]}const s=this._binPack.allocate(e,t);if(s.width<=0){const i=this._mosaicPages[this._currentPage];return!i.dirty&&ae(i.mosaicsData)&&(i.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new Z(this._pageWidth,this._pageHeight),this._allocateImage(e,t)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]}dispose(){this._binPack=null;for(const e of this._mosaicPages){const t=e.texture;t&&t.dispose();const i=e.mosaicsData;ae(i)||i.data.destroy()}this._mosaicPages=null,this._mosaicRects.clear()}}function he(e,t,i){return ae(t)?new q.x(e,{pixelFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,width:i[0],height:i[1]},new Uint8Array(t.data.buffer)):new q.x(e,{pixelFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,samplingMode:w.cw.LINEAR,wrapMode:w.e8.CLAMP_TO_EDGE,width:i[0],height:i[1]},null)}var le=i(1385),ce=i(49682),ue=i(130),de=i(80742),_e=i(40741);function pe(e){return(0,ue.HA)(e.frameDurations.reduce(((e,t)=>e+t),0))}function me(e){const{width:t,height:i}=e;return{frameDurations:e.frameDurations.reverse(),selectFrame:t=>{const i=e.frameDurations.length-1-t;e.selectFrame(i)},width:t,height:i}}function fe(e,t){const{width:i,height:s,selectFrame:r}=e,n=t/pe(e);return{frameDurations:e.frameDurations.map((e=>(0,ue.HA)(e*n))),selectFrame:r,width:i,height:s}}function ge(e,t){const{width:i,height:s,selectFrame:r}=e,n=e.frameDurations.slice(),a=n.shift();return n.unshift((0,ue.HA)(a+t)),{frameDurations:n,selectFrame:r,width:i,height:s}}function be(e,t){const{width:i,height:s,selectFrame:r}=e,n=e.frameDurations.slice(),a=n.pop();return n.push((0,ue.HA)(a+t)),{frameDurations:n,selectFrame:r,width:i,height:s}}class we{constructor(e,t,i){this._animation=e,this._repeatType=i,this._direction=1,this._currentFrame=0,this.timeToFrame=this._animation.frameDurations[this._currentFrame];let s=0;for(;t>s;)s+=this.timeToFrame,this.nextFrame();this._animation.selectFrame(this._currentFrame)}nextFrame(){if(this._currentFrame+=this._direction,this._direction>0){if(this._currentFrame===this._animation.frameDurations.length)switch(this._repeatType){case de.of.None:this._currentFrame-=this._direction;break;case de.of.Loop:this._currentFrame=0;break;case de.of.Oscillate:this._currentFrame-=this._direction,this._direction=-1}}else if(-1===this._currentFrame)switch(this._repeatType){case de.of.None:this._currentFrame-=this._direction;break;case de.of.Loop:this._currentFrame=this._animation.frameDurations.length-1;break;case de.of.Oscillate:this._currentFrame-=this._direction,this._direction=1}this.timeToFrame=this._animation.frameDurations[this._currentFrame],this._animation.selectFrame(this._currentFrame)}}function ye(e,t,i){let s,{repeatType:r}=t;if(null==r&&(r=de.of.Loop),!0===t.reverseAnimation&&(e=me(e)),null!=t.duration&&(e=fe(e,(0,ue.HA)(1e3*t.duration))),null!=t.repeatDelay){const i=1e3*t.repeatDelay;r===de.of.Loop?e=be(e,(0,ue.HA)(i)):r===de.of.Oscillate&&(e=ge(be(e,(0,ue.HA)(i/2)),(0,ue.HA)(i/2)))}if(null!=t.startTimeOffset)s=(0,ue.HA)(1e3*t.startTimeOffset);else if(null!=t.randomizeStartTime){const r=(0,_e.$)(i),n=82749913,a=null!=t.randomizeStartSeed?t.randomizeStartSeed:n,o=(0,_e.f)(r,a);s=(0,ue.HA)(o*pe(e))}else s=(0,ue.HA)(0);return new we(e,s,r)}function ve(e,t,i){const s=null==t.playAnimation||t.playAnimation,r=ye(e,t,i);let n,a=r.timeToFrame;function o(){n=s&&setTimeout((()=>{r.nextFrame(),a=r.timeToFrame,o()}),a)}return o(),{remove:()=>{s&&clearTimeout(n)}}}class xe{constructor(e){this._requestRender=e,this._frameData=null}destroy(){this._playHandle.remove()}bindFrame(e,t,i){e.bindTexture(t,i),(0,a.Wi)(this._frameData)||(t.updateData(0,G.fL,G.fL,this._frameData.width,this._frameData.height,this._frameData),this._frameData=null)}async _load(e,t,i,r){try{const s=e=>{this._frameData=e,this._requestRender.requestRender()},n=await this._loadAnimation(e,s,r);this.frameCount=n.frameDurations.length,this.width=n.width,this.height=n.height,this._playHandle=ve(n,t,i)}catch(S){if(!(0,I.D_)(S))return new s.Z("invalid-resource","Could not parse animated resource.")}}}var Te,Ee={exports:{}};Te=function(){return function(e){var t={};function i(s){if(t[s])return t[s].exports;var r=t[s]={exports:{},id:s,loaded:!1};return e[s].call(r.exports,r,r.exports,i),r.loaded=!0,r.exports}return i.m=e,i.c=t,i.p="",i(0)}([function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.isNotPNG=h,t.isNotAPNG=l,t.default=u;var s=n(i(1)),r=i(2);function n(e){return e&&e.__esModule?e:{default:e}}var a=new Error("Not a PNG"),o=new Error("Not an animated PNG");function h(e){return e===a}function l(e){return e===o}var c=new Uint8Array([137,80,78,71,13,10,26,10]);function u(e){var t=new Uint8Array(e);if(Array.prototype.some.call(c,(function(e,i){return e!==t[i]})))return a;var i=!1;if(d(t,(function(e){return!(i="acTL"===e)})),!i)return o;var s=[],n=[],h=null,l=null,u=0,_=new r.APNG;if(d(t,(function(e,t,i,a){var o=new DataView(t.buffer);switch(e){case"IHDR":h=t.subarray(i+8,i+8+a),_.width=o.getUint32(i+8),_.height=o.getUint32(i+12);break;case"acTL":_.numPlays=o.getUint32(i+8+4);break;case"fcTL":l&&(_.frames.push(l),u++),(l=new r.Frame).width=o.getUint32(i+8+4),l.height=o.getUint32(i+8+8),l.left=o.getUint32(i+8+12),l.top=o.getUint32(i+8+16);var c=o.getUint16(i+8+20),d=o.getUint16(i+8+22);0===d&&(d=100),l.delay=1e3*c/d,l.delay<=10&&(l.delay=100),_.playTime+=l.delay,l.disposeOp=o.getUint8(i+8+24),l.blendOp=o.getUint8(i+8+25),l.dataParts=[],0===u&&2===l.disposeOp&&(l.disposeOp=1);break;case"fdAT":l&&l.dataParts.push(t.subarray(i+8+4,i+8+a));break;case"IDAT":l&&l.dataParts.push(t.subarray(i+8,i+8+a));break;case"IEND":n.push(m(t,i,12+a));break;default:s.push(m(t,i,12+a))}})),l&&_.frames.push(l),0==_.frames.length)return o;var p=new Blob(s),b=new Blob(n);return _.frames.forEach((function(e){var t=[];t.push(c),h.set(g(e.width),0),h.set(g(e.height),4),t.push(f("IHDR",h)),t.push(p),e.dataParts.forEach((function(e){return t.push(f("IDAT",e))})),t.push(b),e.imageData=new Blob(t,{type:"image/png"}),delete e.dataParts,t=null})),_}function d(e,t){var i=new DataView(e.buffer),s=8,r=void 0,n=void 0,a=void 0;do{n=i.getUint32(s),a=t(r=_(e,s+4,4),e,s,n),s+=12+n}while(!1!==a&&"IEND"!=r&&s<e.length)}function _(e,t,i){var s=Array.prototype.slice.call(e.subarray(t,t+i));return String.fromCharCode.apply(String,s)}function p(e){for(var t=new Uint8Array(e.length),i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}function m(e,t,i){var s=new Uint8Array(i);return s.set(e.subarray(t,t+i)),s}var f=function(e,t){var i=e.length+t.length,r=new Uint8Array(i+8),n=new DataView(r.buffer);n.setUint32(0,t.length),r.set(p(e),4),r.set(t,8);var a=(0,s.default)(r,4,i);return n.setUint32(i+4,a),r},g=function(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}},function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=-1,r=t,n=t+(arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length-t);r<n;r++)s=s>>>8^i[255&(s^e[r])];return-1^s};for(var i=new Uint32Array(256),s=0;s<256;s++){for(var r=s,n=0;n<8;n++)r=0!=(1&r)?3988292384^r>>>1:r>>>1;i[s]=r}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Frame=t.APNG=void 0;var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),r=n(i(3));function n(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}t.APNG=function(){function e(){a(this,e),this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[]}return s(e,[{key:"createImages",value:function(){return Promise.all(this.frames.map((function(e){return e.createImage()})))}},{key:"getPlayer",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.createImages().then((function(){return new r.default(t,e,i)}))}}]),e}(),t.Frame=function(){function e(){a(this,e),this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.imageData=null,this.imageElement=null}return s(e,[{key:"createImage",value:function(){var e=this;return this.imageElement?Promise.resolve():new Promise((function(t,i){var s=URL.createObjectURL(e.imageData);e.imageElement=document.createElement("img"),e.imageElement.onload=function(){URL.revokeObjectURL(s),t()},e.imageElement.onerror=function(){URL.revokeObjectURL(s),e.imageElement=null,i(new Error("Image creation error"))},e.imageElement.src=s}))}}]),e}()},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}();function r(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var h=function(e){function t(e,i,s){n(this,t);var r=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.playbackRate=1,r._currentFrameNumber=0,r._ended=!1,r._paused=!0,r._numPlays=0,r._apng=e,r.context=i,r.stop(),s&&r.play(),r}return o(t,e),s(t,[{key:"renderNextFrame",value:function(){this._currentFrameNumber=(this._currentFrameNumber+1)%this._apng.frames.length,this._currentFrameNumber===this._apng.frames.length-1&&(this._numPlays++,0!==this._apng.numPlays&&this._numPlays>=this._apng.numPlays&&(this._ended=!0,this._paused=!0)),this._prevFrame&&1==this._prevFrame.disposeOp?this.context.clearRect(this._prevFrame.left,this._prevFrame.top,this._prevFrame.width,this._prevFrame.height):this._prevFrame&&2==this._prevFrame.disposeOp&&this.context.putImageData(this._prevFrameData,this._prevFrame.left,this._prevFrame.top);var e=this.currentFrame;this._prevFrame=e,this._prevFrameData=null,2==e.disposeOp&&(this._prevFrameData=this.context.getImageData(e.left,e.top,e.width,e.height)),0==e.blendOp&&this.context.clearRect(e.left,e.top,e.width,e.height),this.context.drawImage(e.imageElement,e.left,e.top),this.emit("frame",this._currentFrameNumber),this._ended&&this.emit("end")}},{key:"play",value:function(){var e=this;this.emit("play"),this._ended&&this.stop(),this._paused=!1;var t=performance.now()+this.currentFrame.delay/this.playbackRate,i=function i(s){if(!e._ended&&!e._paused){if(s>=t){for(;s-t>=e._apng.playTime/e.playbackRate;)t+=e._apng.playTime/e.playbackRate,e._numPlays++;do{e.renderNextFrame(),t+=e.currentFrame.delay/e.playbackRate}while(!e._ended&&s>t)}requestAnimationFrame(i)}};requestAnimationFrame(i)}},{key:"pause",value:function(){this._paused||(this.emit("pause"),this._paused=!0)}},{key:"stop",value:function(){this.emit("stop"),this._numPlays=0,this._ended=!1,this._paused=!0,this._currentFrameNumber=-1,this.context.clearRect(0,0,this._apng.width,this._apng.height),this.renderNextFrame()}},{key:"currentFrameNumber",get:function(){return this._currentFrameNumber}},{key:"currentFrame",get:function(){return this._apng.frames[this._currentFrameNumber]}},{key:"paused",get:function(){return this._paused}},{key:"ended",get:function(){return this._ended}}]),t}(r(i(4)).default);t.default=h},function(e,t){function i(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function s(e){return"function"==typeof e}function r(e){return"number"==typeof e}function n(e){return"object"==typeof e&&null!==e}function a(e){return void 0===e}e.exports=i,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.prototype.setMaxListeners=function(e){if(!r(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},i.prototype.emit=function(e){var t,i,r,o,h,l;if(this._events||(this._events={}),"error"===e&&(!this._events.error||n(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}if(a(i=this._events[e]))return!1;if(s(i))switch(arguments.length){case 1:i.call(this);break;case 2:i.call(this,arguments[1]);break;case 3:i.call(this,arguments[1],arguments[2]);break;default:o=Array.prototype.slice.call(arguments,1),i.apply(this,o)}else if(n(i))for(o=Array.prototype.slice.call(arguments,1),r=(l=i.slice()).length,h=0;h<r;h++)l[h].apply(this,o);return!0},i.prototype.addListener=function(e,t){var r;if(!s(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,s(t.listener)?t.listener:t),this._events[e]?n(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,n(this._events[e])&&!this._events[e].warned&&(r=a(this._maxListeners)?i.defaultMaxListeners:this._maxListeners)&&r>0&&this._events[e].length>r&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},i.prototype.on=i.prototype.addListener,i.prototype.once=function(e,t){if(!s(t))throw TypeError("listener must be a function");var i=!1;function r(){this.removeListener(e,r),i||(i=!0,t.apply(this,arguments))}return r.listener=t,this.on(e,r),this},i.prototype.removeListener=function(e,t){var i,r,a,o;if(!s(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(a=(i=this._events[e]).length,r=-1,i===t||s(i.listener)&&i.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(n(i)){for(o=a;o-- >0;)if(i[o]===t||i[o].listener&&i[o].listener===t){r=o;break}if(r<0)return this;1===i.length?(i.length=0,delete this._events[e]):i.splice(r,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},i.prototype.removeAllListeners=function(e){var t,i;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(s(i=this._events[e]))this.removeListener(e,i);else if(i)for(;i.length;)this.removeListener(e,i[i.length-1]);return delete this._events[e],this},i.prototype.listeners=function(e){return this._events&&this._events[e]?s(this._events[e])?[this._events[e]]:this._events[e].slice():[]},i.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(s(t))return 1;if(t)return t.length}return 0},i.listenerCount=function(e,t){return e.listenerCount(t)}}])},Ee.exports=Te();const Me=(0,ce.g)(Ee.exports);class Be extends xe{static async create(e,t,i,r,n){const a=new Be(r);try{await a._load(e,t,i,n)}catch(ve){if(!(0,I.D_)(ve))return new s.Z("invalid-resource",`Could not load PNG: ${ve.message}`)}return a}async _loadAnimation(e,t,i){return Re(e,t,i)}}async function Re(e,t,i){const s=Me(e);if(s instanceof Error)throw s;await s.createImages(),(0,I.k_)(i);const{frames:r,width:n,height:a}=s,o=document.createElement("canvas");o.width=n,o.height=a;const h=o.getContext("2d"),l=[],c=[];for(const u of r){c.push((0,ue.HA)(u.delay));const e=u.imageElement;0===u.blendOp?h.globalCompositeOperation="copy":h.globalCompositeOperation="source-over";const t=2===u.disposeOp&&h.getImageData(u.left,u.top,u.width,u.height);h.drawImage(e,u.left,u.top);const i=h.getImageData(0,0,n,a);l.push(i),0===u.disposeOp||(1===u.disposeOp?h.clearRect(u.left,u.top,u.width,u.height):2===u.disposeOp&&h.putImageData(t,u.left,u.top))}return{frameDurations:c,selectFrame:e=>{const i=l[e];t(i)},width:n,height:a}}const Ce=[137,80,78,71,13,10,26,10];function Fe(e){const t=new Uint8Array(e);return!Ce.some(((e,i)=>e!==t[i]))}function Oe(e){if(!Fe(e))return!1;const t=new DataView(e),i=new Uint8Array(e);let s,r=8;do{const e=t.getUint32(r);if(s=String.fromCharCode.apply(String,Array.prototype.slice.call(i.subarray(r+4,r+8))),"acTL"===s)return!0;r+=12+e}while("IEND"!==s&&r<i.length);return!1}var Se=i(50857),Pe={},Ae={},ze={};Object.defineProperty(ze,"__esModule",{value:!0}),ze.loop=ze.conditional=ze.parse=void 0;var Ue=function e(t,i){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:s;if(Array.isArray(i))i.forEach((function(i){return e(t,i,s,r)}));else if("function"==typeof i)i(t,s,r,e);else{var n=Object.keys(i)[0];Array.isArray(i[n])?(r[n]={},e(t,i[n],s,r[n])):r[n]=i[n](t,s,r,e)}return s};ze.parse=Ue;var Ie=function(e,t){return function(i,s,r,n){t(i,s,r)&&n(i,e,s,r)}};ze.conditional=Ie;var De=function(e,t){return function(i,s,r,n){for(var a=[],o=i.pos;t(i,s,r);){var h={};if(n(i,e,s,h),i.pos===o)break;o=i.pos,a.push(h)}return a}};ze.loop=De;var Le={};Object.defineProperty(Le,"__esModule",{value:!0}),Le.readBits=Le.readArray=Le.readUnsigned=Le.readString=Le.peekBytes=Le.readBytes=Le.peekByte=Le.readByte=Le.buildStream=void 0;var Ne=function(e){return{data:e,pos:0}};Le.buildStream=Ne;var ke=function(){return function(e){return e.data[e.pos++]}};Le.readByte=ke;var Ge=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(t){return t.data[t.pos+e]}};Le.peekByte=Ge;var He=function(e){return function(t){return t.data.subarray(t.pos,t.pos+=e)}};Le.readBytes=He;var Ve=function(e){return function(t){return t.data.subarray(t.pos,t.pos+e)}};Le.peekBytes=Ve;var Ze=function(e){return function(t){return Array.from(He(e)(t)).map((function(e){return String.fromCharCode(e)})).join("")}};Le.readString=Ze;var qe=function(e){return function(t){var i=He(2)(t);return e?(i[1]<<8)+i[0]:(i[0]<<8)+i[1]}};Le.readUnsigned=qe;var We=function(e,t){return function(i,s,r){for(var n="function"==typeof t?t(i,s,r):t,a=He(e),o=new Array(n),h=0;h<n;h++)o[h]=a(i);return o}};Le.readArray=We;var je=function(e,t,i){for(var s=0,r=0;r<i;r++)s+=e[t+r]&&Math.pow(2,i-r-1);return s},$e=function(e){return function(t){for(var i=ke()(t),s=new Array(8),r=0;r<8;r++)s[7-r]=!!(i&1<<r);return Object.keys(e).reduce((function(t,i){var r=e[i];return r.length?t[i]=je(s,r.index,r.length):t[i]=s[r.index],t}),{})}};Le.readBits=$e,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var t=ze,i=Le,s={blocks:function(e){for(var t=0,s=[],r=e.data.length,n=0,a=(0,i.readByte)()(e);a!==t&&a;a=(0,i.readByte)()(e)){if(e.pos+a>=r){var o=r-e.pos;s.push((0,i.readBytes)(o)(e)),n+=o;break}s.push((0,i.readBytes)(a)(e)),n+=a}for(var h=new Uint8Array(n),l=0,c=0;c<s.length;c++)h.set(s[c],l),l+=s[c].length;return h}},r=(0,t.conditional)({gce:[{codes:(0,i.readBytes)(2)},{byteSize:(0,i.readByte)()},{extras:(0,i.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,i.readUnsigned)(!0)},{transparentColorIndex:(0,i.readByte)()},{terminator:(0,i.readByte)()}]},(function(e){var t=(0,i.peekBytes)(2)(e);return 33===t[0]&&249===t[1]})),n=(0,t.conditional)({image:[{code:(0,i.readByte)()},{descriptor:[{left:(0,i.readUnsigned)(!0)},{top:(0,i.readUnsigned)(!0)},{width:(0,i.readUnsigned)(!0)},{height:(0,i.readUnsigned)(!0)},{lct:(0,i.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,t.conditional)({lct:(0,i.readArray)(3,(function(e,t,i){return Math.pow(2,i.descriptor.lct.size+1)}))},(function(e,t,i){return i.descriptor.lct.exists})),{data:[{minCodeSize:(0,i.readByte)()},s]}]},(function(e){return 44===(0,i.peekByte)()(e)})),a=(0,t.conditional)({text:[{codes:(0,i.readBytes)(2)},{blockSize:(0,i.readByte)()},{preData:function(e,t,s){return(0,i.readBytes)(s.text.blockSize)(e)}},s]},(function(e){var t=(0,i.peekBytes)(2)(e);return 33===t[0]&&1===t[1]})),o=(0,t.conditional)({application:[{codes:(0,i.readBytes)(2)},{blockSize:(0,i.readByte)()},{id:function(e,t,s){return(0,i.readString)(s.blockSize)(e)}},s]},(function(e){var t=(0,i.peekBytes)(2)(e);return 33===t[0]&&255===t[1]})),h=(0,t.conditional)({comment:[{codes:(0,i.readBytes)(2)},s]},(function(e){var t=(0,i.peekBytes)(2)(e);return 33===t[0]&&254===t[1]})),l=[{header:[{signature:(0,i.readString)(3)},{version:(0,i.readString)(3)}]},{lsd:[{width:(0,i.readUnsigned)(!0)},{height:(0,i.readUnsigned)(!0)},{gct:(0,i.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,i.readByte)()},{pixelAspectRatio:(0,i.readByte)()}]},(0,t.conditional)({gct:(0,i.readArray)(3,(function(e,t){return Math.pow(2,t.lsd.gct.size+1)}))},(function(e,t){return t.lsd.gct.exists})),{frames:(0,t.loop)([r,o,h,n,a],(function(e){var t=(0,i.peekByte)()(e);return 33===t||44===t}))}];e.default=l}(Ae);var Xe={};Object.defineProperty(Xe,"__esModule",{value:!0}),Xe.deinterlace=void 0;var Ye=function(e,t){for(var i=new Array(e.length),s=e.length/t,r=function(s,r){var n=e.slice(r*t,(r+1)*t);i.splice.apply(i,[s*t,t].concat(n))},n=[0,4,2,1],a=[8,8,4,2],o=0,h=0;h<4;h++)for(var l=n[h];l<s;l+=a[h])r(l,o),o++;return i};Xe.deinterlace=Ye;var Qe={};Object.defineProperty(Qe,"__esModule",{value:!0}),Qe.lzw=void 0;var Ke=function(e,t,i){var s,r,n,a,o,h,l,c,u,d,_,p,m,f,g,b,w=4096,y=-1,v=i,x=new Array(i),T=new Array(w),E=new Array(w),M=new Array(w+1);for(o=1+(r=1<<(d=e)),s=r+2,l=y,n=(1<<(a=d+1))-1,c=0;c<r;c++)T[c]=0,E[c]=c;for(_=p=m=f=g=b=0,u=0;u<v;){if(0===f){if(p<a){_+=t[b]<<p,p+=8,b++;continue}if(c=_&n,_>>=a,p-=a,c>s||c==o)break;if(c==r){n=(1<<(a=d+1))-1,s=r+2,l=y;continue}if(l==y){M[f++]=E[c],l=c,m=c;continue}for(h=c,c==s&&(M[f++]=m,c=l);c>r;)M[f++]=E[c],c=T[c];m=255&E[c],M[f++]=m,s<w&&(T[s]=l,E[s]=m,0==(++s&n)&&s<w&&(a++,n+=s)),l=h}f--,x[g++]=M[f],u++}for(u=g;u<v;u++)x[u]=0;return x};Qe.lzw=Ke,Object.defineProperty(Pe,"__esModule",{value:!0});var Je=Pe.decompressFrames=Pe.decompressFrame=ot=Pe.parseGIF=void 0,et=nt(Ae),tt=ze,it=Le,st=Xe,rt=Qe;function nt(e){return e&&e.__esModule?e:{default:e}}var at=function(e){var t=new Uint8Array(e);return(0,tt.parse)((0,it.buildStream)(t),et.default)},ot=Pe.parseGIF=at,ht=function(e){for(var t=e.pixels.length,i=new Uint8ClampedArray(4*t),s=0;s<t;s++){var r=4*s,n=e.pixels[s],a=e.colorTable[n]||[0,0,0];i[r]=a[0],i[r+1]=a[1],i[r+2]=a[2],i[r+3]=n!==e.transparentIndex?255:0}return i},lt=function(e,t,i){if(e.image){var s=e.image,r=s.descriptor.width*s.descriptor.height,n=(0,rt.lzw)(s.data.minCodeSize,s.data.blocks,r);s.descriptor.lct.interlaced&&(n=(0,st.deinterlace)(n,s.descriptor.width));var a={pixels:n,dims:{top:e.image.descriptor.top,left:e.image.descriptor.left,width:e.image.descriptor.width,height:e.image.descriptor.height}};return s.descriptor.lct&&s.descriptor.lct.exists?a.colorTable=s.lct:a.colorTable=t,e.gce&&(a.delay=10*(e.gce.delay||10),a.disposalType=e.gce.extras.disposal,e.gce.extras.transparentColorGiven&&(a.transparentIndex=e.gce.transparentColorIndex)),i&&(a.patch=ht(a)),a}console.warn("gif frame does not have associated image.")};Pe.decompressFrame=lt;var ct=function(e,t){return e.frames.filter((function(e){return e.image})).map((function(i){return lt(i,e.gct,t)}))};Je=Pe.decompressFrames=ct;class ut extends xe{static async create(e,t,i,r,n){const a=new ut(r);try{await a._load(e,t,i,n)}catch(Ue){if(!(0,I.D_)(Ue))return new s.Z("invalid-resource",`Could not load GIF: ${Ue.message}`)}return a}async _loadAnimation(e,t,i){return dt(e,t)}}async function dt(e,t,i){const s=ot(e),r=Je(s,!0),{width:n,height:a}=s.lsd,o=document.createElement("canvas");o.width=n,o.height=a;const h=o.getContext("2d"),l=[],c=[];for(const u of r){c.push((0,ue.HA)(u.delay));const e=new ImageData(u.patch,u.dims.width,u.dims.height),t=(0,Se.E0)(e),i=3===u.disposalType&&h.getImageData(u.dims.left,u.dims.top,u.dims.width,u.dims.height);h.drawImage(t,u.dims.left,u.dims.top);const s=h.getImageData(0,0,n,a);l.push(s),1===u.disposalType||(2===u.disposalType?h.clearRect(u.dims.left,u.dims.top,u.dims.width,u.dims.height):3===u.disposalType&&h.putImageData(i,u.dims.left,u.dims.top))}return{frameDurations:c,selectFrame:e=>{const i=l[e];t(i)},width:n,height:a}}const _t=[71,73,70];function pt(e){const t=new Uint8Array(e);return!_t.some(((e,i)=>e!==t[i]))}function mt(e){if(!pt(e))return!1;const t=new DataView(e),i=t.getUint8(10);let s=13+(128&i?3*2**(1+(7&i)):0),r=0,n=!1;for(;!n;){switch(t.getUint8(s++)){case 33:if(!a())return!1;break;case 44:o();break;case 59:n=!0;break;default:return!1}if(r>1)return!0}function a(){switch(t.getUint8(s++)){case 249:h();break;case 1:l();break;case 254:c();break;case 255:u();break;default:return!1}return!0}function o(){r++,s+=8;const e=t.getUint8(s++);s+=128&e?3*2**(1+(7&e)):0,s++,d()}function h(){s++,s+=4,d()}function l(){r++,s++,s+=12,d()}function c(){d()}function u(){s++,s+=8,s+=3,d()}function d(){let e;for(;e=t.getUint8(s++);)s+=e}return!1}var ft=i(25481);function gt(e){switch(e.type){case"esriSMS":return`${e.style}.${e.path}`;case"esriSLS":return`${e.style}.${e.cap}`;case"esriSFS":return`${e.style}`;case"esriPFS":case"esriPMS":return e.imageData?`${e.imageData}${e.width}${e.height}`:`${e.url}${e.width}${e.height}`;default:return"mosaicHash"in e?e.mosaicHash:JSON.stringify(e)}}var bt=i(13686);const wt=(0,N.c)(),yt="arial-unicode-ms-regular",vt=126,xt=U.Z.getLogger("esri.views.2d.engine.webgl.TextureManager");async function Tt(e,t){const i=(0,le.Gr)(e);let r;const n=";base64,";if(i.includes(n)){const e=i.indexOf(n)+n.length,t=i.substring(e),s=atob(t),a=new Uint8Array(s.length);for(let i=0;i<s.length;i++)a[i]=s.charCodeAt(i);r=a.buffer}else try{const{data:e}=await(0,A["default"])(i,{responseType:"array-buffer",...t});r=e}catch(R){if(!(0,I.D_)(R))return new s.Z("mapview-invalid-resource",`Could not fetch requested resource at ${i}`)}return r}function Et(e,t){const i=Math.round((0,D.F2)(t)*window.devicePixelRatio),s=i>=128?2:4;return Math.min(e,i*s)}const Mt=(e,t,i)=>xt.error(new s.Z(e,t,i));class Bt{constructor(e,t,i){this.mosaicType=e,this.page=t,this.sdf=i}static fromMosaic(e,t){return new Bt(e,t.page,t.sdf)}}class Rt{constructor(e,t){this._requestRender=e,this.resourceManager=t,this._invalidFontsMap=new Map,this._sdfConverter=new re(vt),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new bt.e({concurrency:10,process:async(e,i)=>{(0,I.k_)(i);try{return await(0,A["default"])(e,{responseType:"image",signal:i})}catch(t){if(!(0,I.D_)(t))throw new s.Z("mapview-invalid-resource",`Could not fetch requested resource at ${e}`,t);throw t}}}),this._spriteMosaic=new oe(2048,2048,500),this._glyphSource=new te(`${P.Z.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new Q(1024,1024,this._glyphSource),this._rasterizer=new k.Z(t)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}async rasterizeItem(e,t,i,s){if((0,a.Wi)(e))return Mt("mapview-null-resource","Unable to rasterize null resource"),null;switch(e.type){case"text":case"esriTS":{const t=await this._rasterizeText(e,i,s);return t.forEach((e=>this._setTextureBinding(d.Un.GLYPH,e))),{glyphMosaicItems:t}}default:{if((0,le.Ll)(e))return Mt("mapview-invalid-type",`MapView does not support symbol type: ${e.type}`,e),null;const i=await this._rasterizeSpriteSymbol(e,t,s);return(0,ft.ok)(i)&&i&&this._setTextureBinding(d.Un.SPRITE,i),{spriteMosaicItem:i}}}}bindTextures(e,t,i,s=!1){if(0===i.textureBinding)return;const r=this._bindingInfos[i.textureBinding-1],n=r.page,a=s?w.cw.LINEAR_MIPMAP_LINEAR:w.cw.LINEAR;switch(r.mosaicType){case d.Un.SPRITE:{const i=this.sprites.getWidth(n),s=this.sprites.getHeight(n),r=(0,L.a)(wt,i,s);return this._spriteMosaic.bind(e,a,n,G.D3),t.setUniform1i("u_texture",G.D3),void t.setUniform2fv("u_mosaicSize",r)}case d.Un.GLYPH:{const i=this.glyphs.width,s=this.glyphs.height,r=(0,L.a)(wt,i,s);return this._glyphMosaic.bind(e,a,n,G.Al),t.setUniform1i("u_texture",G.Al),void t.setUniform2fv("u_mosaicSize",r)}default:xt.error("mapview-texture-manager",`Cannot handle unknown type ${r.mosaicType}`)}}_hashMosaic(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3}_setTextureBinding(e,t){const i=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(i)){const s=Bt.fromMosaic(e,t),r=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,r),this._bindingInfos.push(s)}t.textureBinding=this._hashToBindingIndex.get(i)}async _rasterizeText(e,t,i){let s,r;if("cim"in e){const t=e;s=t.fontName,r=t.text}else{const t=e;s=(0,H.Yc)(t.font),r=t.text}const n=this._invalidFontsMap.has(s),a=t||(0,le.Jq)((0,z.E)(r)[0]);try{return await this._glyphMosaic.getGlyphItems(n?yt:s,a,i)}catch(S){return Mt("mapview-invalid-resource",`Couldn't find font ${s}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(s,!0),this._glyphMosaic.getGlyphItems(yt,a,i)}}async _rasterizeSpriteSymbol(e,t,i){if((0,le.Gg)(e))return null;const r=gt(e);if(this._spriteMosaic.has(r))return this._spriteMosaic.getSpriteItem(r);if((0,le.sG)(e)||(0,le.HX)(e)&&!(0,le.yP)(e))return this._handleAsyncResource(r,e,i);const n=1,a=this._rasterizer.rasterizeJSONResource(e,n);if(a){const{size:t,image:i,sdf:s,simplePattern:n}=a;return this._addItemToMosaic(r,t,{type:"static",data:i},(0,le.js)(e),s,n)}return new s.Z("TextureManager","unrecognized or null rasterized image")}async _handleAsyncResource(e,t,i){if(this._ongoingRasterizations.has(e))return this._ongoingRasterizations.get(e);let s;s=(0,le.sG)(t)?this._handleSVG(t,e,i):this._handleImage(t,e,i),this._ongoingRasterizations.set(e,s);try{await s,this._ongoingRasterizations.delete(e)}catch{this._ongoingRasterizations.delete(e)}return s}async _handleSVG(e,t,i){const s=[vt,vt],r=await this._sdfConverter.draw(e.path,i);return this._addItemToMosaic(t,s,{type:"static",data:new Uint32Array(r.buffer)},!1,!0,!0)}async _handleGIFOrPNG(e,t,i){const r=await Tt(e,i);if((0,ft.ok)(r)){const n=pt(r),a=Fe(r);if(!n&&!a)return new s.Z("mapview-invalid-resource","Image data is neither GIF nor PNG!");let o;try{const t=e.animatedSymbolProperties||{},s=e.objectId;n&&mt(r)?o=await ut.create(r,t,s,this._requestRender,i):a&&Oe(r)&&(o=await Be.create(r,t,s,this._requestRender,i))}catch(W){if(!(0,I.D_)(W))return new s.Z("mapview-invalid-resource","Could not fetch requested resource!")}if(o&&(0,ft.ok)(o))return this._addItemToMosaic(t,[o.width,o.height],{type:"animated",data:o},(0,le.js)(e),!1,!1);const h=new Blob([r],{type:n?"image/gif":"image/png"}),l=await this._imageFromBlob(h);if(l&&l instanceof HTMLImageElement){let i=l.width,s=l.height;"esriPMS"===e.type&&(i=Math.round(Et(l.width,(0,le.Ub)(e))),s=Math.round(l.height*(i/l.width)));const r="cim"in e?e.cim.colorSubstitutions:void 0,{size:n,sdf:a,image:o}=this._rasterizer.rasterizeImageResource(i,s,l,r);return this._addItemToMosaic(t,n,{type:"static",data:o},(0,le.js)(e),a,!1)}}return new s.Z("mapview-invalid-resource","Could not handle resource!")}async _handleImage(e,t,i){if((0,le.DQ)(e)||(0,le.iw)(e))return this._handleGIFOrPNG(e,t,i);const r=(0,le.Gr)(e);try{let s;const n=this.resourceManager.getResource(r);if((0,a.pC)(n))s=n;else{const{data:e}=await this._imageRequestQueue.push(r,{...i});s=e}if((0,le.TB)(r))if("width"in e&&"height"in e)s.width=(0,D.F2)(e.width),s.height=(0,D.F2)(e.height);else if("cim"in e){const t=e.cim;s.width=(0,D.F2)(t.width??t.scaleX*t.size),s.height=(0,D.F2)(t.size)}if(!s.width||!s.height)return null;let o=s.width,h=s.height;"esriPMS"===e.type&&(o=Math.round(Et(s.width,(0,le.Ub)(e))),h=Math.round(s.height*(o/s.width)));const l="cim"in e?e.cim.colorSubstitutions:void 0,{size:c,sdf:u,image:d}=this._rasterizer.rasterizeImageResource(o,h,s,l);return this._addItemToMosaic(t,c,{type:"static",data:d},(0,le.js)(e),u,!1)}catch(W){if(!(0,I.D_)(W))return new s.Z("mapview-invalid-resource",`Could not fetch requested resource at ${r}. ${W.message}`)}}async _imageFromBlob(e){const t=window.URL.createObjectURL(e);try{const{data:e}=await this._imageRequestQueue.push(t);return window.URL.revokeObjectURL(t),e}catch(O){if(window.URL.revokeObjectURL(t),!(0,I.D_)(O))return new s.Z("mapview-invalid-resource",`Could not fetch requested resource at ${t}`);throw O}}_addItemToMosaic(e,t,i,s,r,n){return this._spriteMosaic.addSpriteItem(e,t,i,s,r,n)}}var Ct=i(73288),Ft=i(18037),Ot=i(12686),St=i(65554),Pt=i(74674),At=i(78268);const zt={shaders:{vertexShader:(0,f.w)("stencil/stencil.vert"),fragmentShader:(0,f.w)("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])},Ut=(0,Ot.f)(-.5,-.5);class It{constructor(){this._centerNdc=(0,Pt.c)(),this._pxToNdc=(0,Pt.c)(),this._worldDimensionsPx=(0,Pt.c)(),this._mat3=(0,l.c)(),this._initialized=!1}dispose(){this._program=(0,a.O3)(this._program),this._quad=(0,a.O3)(this._quad)}render(e,t){const{context:i}=e;return!!this._updateGeometry(e,t)&&(this._initialized||this._initialize(i),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setColorMask(!1,!1,!1,!1),i.setBlendingEnabled(!1),i.setStencilOp(w.xS.KEEP,w.xS.KEEP,w.xS.REPLACE),i.setStencilFunction(w.wb.ALWAYS,1,255),i.setStencilTestEnabled(!0),i.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind(),!0)}_initialize(e){if(this._initialized)return;const t=(0,y.H)(e,zt);t&&(this._program=t,this._quad=new At.Z(e,[0,0,1,0,0,1,1,1]),this._initialized=!0)}_updateGeometry(e,t){const{state:i,pixelRatio:s}=e,{size:r,rotation:n}=i,a=Math.round(r[0]*s),o=Math.round(r[1]*s);if(!i.spatialReference.isWrappable)return!1;const h=(0,Ct.t)(n),l=Math.abs(Math.cos(h)),c=Math.abs(Math.sin(h)),u=Math.round(a*l+o*c),d=Math.round(i.worldScreenWidth);if(u<=d)return!1;const _=a*c+o*l,p=d*s,m=(t.left-t.right)*s/a,f=(t.bottom-t.top)*s/o;(0,St.s)(this._worldDimensionsPx,p,_,1),(0,St.s)(this._pxToNdc,2/a,-2/o,1),(0,St.s)(this._centerNdc,m,f,1);const g=this._mat3;return(0,Ft.h)(g,this._centerNdc),(0,Ft.d)(g,g,this._pxToNdc),0!==n&&(0,Ft.r)(g,g,h),(0,Ft.d)(g,g,this._worldDimensionsPx),(0,Ft.c)(g,g,Ut),!0}}class Dt{constructor(){this.name=this.constructor.name}createOptions(e,t){return null}}class Lt extends Dt{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(e,t){if(!t.size)return;const{context:i,renderingOptions:s}=e;this._quad||(this._quad=new At.Z(i,[0,0,1,0,0,1,1,1]));const r=i.getBoundFramebufferObject(),{x:n,y:o,width:h,height:l}=i.getViewport();t.bindTextures(i);const c=t.getBlock(G.xl);if((0,a.Wi)(c))return;const u=c.getFBO(i),d=c.getFBO(i,1);i.setViewport(0,0,t.size,t.size),this._computeDelta(e,d,s.labelsAnimationTime),this._updateAnimationState(e,d,u),i.bindFramebuffer(r),i.setViewport(n,o,h,l)}_computeDelta(e,t,i){const{context:s,painter:r,displayLevel:n}=e,a=r.materialManager.getProgram(this._desc,["delta"]);s.bindFramebuffer(t),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),s.useProgram(a),a.setUniform1i("u_maskTexture",G.iJ),a.setUniform1i("u_sourceTexture",G.nM),a.setUniform1f("u_timeDelta",e.deltaTime),a.setUniform1f("u_animationTime",i),a.setUniform1f("u_zoomLevel",Math.round(10*n)),this._quad.draw()}_updateAnimationState(e,t,i){const{context:s,painter:r}=e,n=r.materialManager.getProgram(this._desc,["update"]);s.bindTexture(t.colorTexture,1),s.useProgram(n),n.setUniform1i("u_sourceTexture",1),s.bindFramebuffer(i),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),this._quad.draw()}}const Nt=e=>e.replace("-","_").toUpperCase(),kt=e=>`#define ${Nt(e)}\n`;function Gt(e){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:kt(e)+(0,f.w)("blend/blend.vert"),fragmentShader:kt(e)+(0,f.w)("blend/blend.frag")}}}const Ht=U.Z.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class Vt{constructor(){this._size=[0,0]}dispose(e){this._backBufferTexture=(0,a.O3)(this._backBufferTexture),this._quad=(0,a.O3)(this._quad)}draw(e,t,i,r,n){const{context:a,drawPhase:o}=e;if(this._setupShader(a),r&&"normal"!==r&&o!==d.jx.LABEL)return void this._drawBlended(e,t,i,r,n);const h=Gt("normal"),l=a.programCache.acquire(h.shaders.vertexShader,h.shaders.fragmentShader,h.attributes);if(!l)return void Ht.error(new s.Z("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));a.useProgram(l),t.setSamplingMode(i),a.bindTexture(t,0),l.setUniform1i("u_layerTexture",0),l.setUniform1f("u_opacity",n),a.setBlendingEnabled(!0),a.setBlendFunction(w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA);const c=this._quad;c.draw(),c.unbind(),l.dispose()}_drawBlended(e,t,i,r,n){const{context:o,state:h,pixelRatio:l,inFadeTransition:c}=e,{size:u}=h,d=o.getBoundFramebufferObject();let _,p;if((0,a.pC)(d)){const e=d.descriptor;_=e.width,p=e.height}else _=Math.round(l*u[0]),p=Math.round(l*u[1]);this._createOrResizeTexture(e,_,p);const m=this._backBufferTexture;d.copyToTexture(0,0,_,p,0,0,m),o.setStencilTestEnabled(!1),o.setStencilWriteMask(0),o.setBlendingEnabled(!0),o.setDepthTestEnabled(!1),o.setDepthWriteEnabled(!1);const f=Gt(r),g=o.programCache.acquire(f.shaders.vertexShader,f.shaders.fragmentShader,f.attributes);if(!g)return void Ht.error(new s.Z("mapview-BlendEffect",`Error creating shader program for blend mode ${r}`));o.useProgram(g),m.setSamplingMode(i),o.bindTexture(m,0),g.setUniform1i("u_backbufferTexture",0),t.setSamplingMode(i),o.bindTexture(t,1),g.setUniform1i("u_layerTexture",1),g.setUniform1f("u_opacity",n),g.setUniform1f("u_inFadeOpacity",c?1:0),o.setBlendFunction(w.zi.ONE,w.zi.ZERO);const b=this._quad;b.draw(),b.unbind(),g.dispose(),o.setBlendFunction(w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA)}_setupShader(e){this._quad||(this._quad=new At.Z(e,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(e,t,i){const{context:s}=e;null!==this._backBufferTexture&&t===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(t,i):this._backBufferTexture=new q.x(s,{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,internalFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,samplingMode:w.cw.LINEAR,flipped:!1,width:t,height:i}),this._size[0]=t,this._size[1]=i)}}class Zt extends Dt{constructor(e){super(),this.name=this.constructor.name,this.defines=[e]}dispose(){}bind({context:e,painter:t}){this._prev=e.getBoundFramebufferObject();const{width:i,height:s}=e.getViewport(),r=t.getFbos(i,s).effect0;e.bindFramebuffer(r),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}draw(e,t){const{context:i,painter:s}=e,r=s.getPostProcessingEffects(t),n=i.getBoundFramebufferObject();for(const{postProcessingEffect:a,effect:o}of r)a.draw(e,n,o);i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),s.blitTexture(i,n.colorTexture,w.cw.NEAREST),i.setStencilTestEnabled(!0)}}const qt=1,Wt=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],jt=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],$t=256,Xt={outlineWidth:1.3,outerHaloWidth:.4,innerHaloWidth:.4,outlinePosition:0},Yt=U.Z.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient");function Qt(e,t){t.fillColor[0]=e.color.r/255,t.fillColor[1]=e.color.g/255,t.fillColor[2]=e.color.b/255,t.fillColor[3]=e.color.a,e.haloColor?(t.outlineColor[0]=e.haloColor.r/255,t.outlineColor[1]=e.haloColor.g/255,t.outlineColor[2]=e.haloColor.b/255,t.outlineColor[3]=e.haloColor.a):(t.outlineColor[0]=t.fillColor[0],t.outlineColor[1]=t.fillColor[1],t.outlineColor[2]=t.fillColor[2],t.outlineColor[3]=t.fillColor[3]),t.fillColor[3]*=e.fillOpacity,t.outlineColor[3]*=e.haloOpacity,t.fillColor[0]*=t.fillColor[3],t.fillColor[1]*=t.fillColor[3],t.fillColor[2]*=t.fillColor[3],t.outlineColor[0]*=t.outlineColor[3],t.outlineColor[1]*=t.outlineColor[3],t.outlineColor[2]*=t.outlineColor[3],t.outlineWidth=Xt.outlineWidth,t.outerHaloWidth=Xt.outerHaloWidth,t.innerHaloWidth=Xt.innerHaloWidth,t.outlinePosition=Xt.outlinePosition}const Kt=[0,0,0,0];class Jt{constructor(){this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:Xt.outlinePosition,outlineWidth:Xt.outlineWidth,innerHaloWidth:Xt.innerHaloWidth,outerHaloWidth:Xt.outerHaloWidth},this.shadeTexChanged=!0,this.texelData=new Uint8Array(4*$t),this.minMaxDistance=[0,0]}setHighlightOptions(e){const t=this._convertedHighlightOptions;Qt(e,t);const i=t.outlinePosition-t.outlineWidth/2-t.outerHaloWidth,s=t.outlinePosition-t.outlineWidth/2,r=t.outlinePosition+t.outlineWidth/2,n=t.outlinePosition+t.outlineWidth/2+t.innerHaloWidth,a=Math.sqrt(Math.PI/2)*qt,o=Math.abs(i)>a?Math.round(10*(Math.abs(i)-a))/10:0,h=Math.abs(n)>a?Math.round(10*(Math.abs(n)-a))/10:0;let l;o&&!h?Yt.error("The outer rim of the highlight is "+o+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!o&&h?Yt.error("The inner rim of the highlight is "+h+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):o&&h&&Yt.error("The highlight is "+Math.max(o,h)+"px away from the edge of the feature; consider reducing some width values.");const c=[void 0,void 0,void 0,void 0];function u(e,t,i){c[0]=(1-i)*e[0]+i*t[0],c[1]=(1-i)*e[1]+i*t[1],c[2]=(1-i)*e[2]+i*t[2],c[3]=(1-i)*e[3]+i*t[3]}const{texelData:d}=this;for(let _=0;_<$t;++_)l=i+_/($t-1)*(n-i),l<i?(c[4*_+0]=0,c[4*_+1]=0,c[4*_+2]=0,c[4*_+3]=0):l<s?u(Kt,t.outlineColor,(l-i)/(s-i)):l<r?[c[0],c[1],c[2],c[3]]=t.outlineColor:l<n?u(t.outlineColor,t.fillColor,(l-r)/(n-r)):[c[4*_+0],c[4*_+1],c[4*_+2],c[4*_+3]]=t.fillColor,d[4*_+0]=255*c[0],d[4*_+1]=255*c[1],d[4*_+2]=255*c[2],d[4*_+3]=255*c[3];this.minMaxDistance[0]=i,this.minMaxDistance[1]=n,this.shadeTexChanged=!0}applyHighlightOptions(e,t){this.shadeTex||(this.shadeTex=new q.x(e,{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,width:$t,height:1,samplingMode:w.cw.LINEAR})),this.shadeTexChanged&&(this.shadeTex.updateData(0,0,0,$t,1,this.texelData),this.shadeTexChanged=!1),e.bindTexture(this.shadeTex,G.Jw),t.setUniform2fv("u_minMaxDistance",this.minMaxDistance)}destroy(){this.shadeTex&&(this.shadeTex.dispose(),this.shadeTex=null)}}const ei={shaders:{vertexShader:(0,f.w)("highlight/textured.vert"),fragmentShader:(0,f.w)("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},ti={shaders:{vertexShader:(0,f.w)("highlight/textured.vert"),fragmentShader:(0,f.w)("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])};var ii=i(64816);class si{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(e,t){e.bindTexture(t,G.QU),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Wt),e.bindVAO(this._resources.quadVAO),e.drawArrays(w.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}finalBlur(e,t){e.bindTexture(t,G.QU),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",jt),e.bindVAO(this._resources.quadVAO),e.drawArrays(w.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}renderHighlight(e,t,i){e.bindTexture(t,G.QU),e.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA),e.drawArrays(w.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}_initialize(e,t,i){this._width=t,this._height=i;const s=b.f.createVertex(e,w.l1.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),r=new v.U(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new ii.G("a_position",2,w.g.BYTE,0,4),new ii.G("a_texcoord",2,w.g.UNSIGNED_BYTE,2,4)]},{geometry:s}),n=(0,y.H)(e,ei),a=(0,y.H)(e,ti);e.useProgram(n),n.setUniform1i("u_texture",G.QU),n.setUniform1i("u_shade",G.Jw),n.setUniform1f("u_sigma",qt),e.useProgram(a),a.setUniform1i("u_texture",G.QU),a.setUniform1f("u_sigma",qt),this._resources={quadGeometry:s,quadVAO:r,highlightProgram:n,blurProgram:a}}setup(e,t,i){this._resources?(this._width=t,this._height=i):this._initialize(e,t,i)}}var ri=i(98473);function ni(e,t,i){const s=new q.x(e,{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,width:t,height:i,samplingMode:w.cw.LINEAR});return[s,new ri.X(e,{colorTarget:w.Lm.TEXTURE,depthStencilTarget:w.OU.STENCIL_RENDER_BUFFER},s)]}class ai{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(e,t,i){this._width=t,this._height=i;const[s,r]=ni(e,t,i),[n,a]=ni(e,t,i);this._resources={sharedBlur1Tex:s,sharedBlur1Fbo:r,sharedBlur2Tex:n,sharedBlur2Fbo:a}}setup(e,t,i){!this._resources||this._width===t&&this._height===i||this.dispose(),this._resources||this._initialize(e,t,i)}get sharedBlur1Tex(){return this._resources.sharedBlur1Tex}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Tex}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}const oi=4,hi=4/oi;class li extends Dt{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new si,this._hlGradient=new Jt,this._width=void 0,this._height=void 0,this._hlSurfaces=new ai,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new x}dispose(){this._hlSurfaces&&this._hlSurfaces.dispose(),this._hlRenderer&&this._hlRenderer.dispose(),this._hlGradient&&this._hlGradient.destroy(),this._boundFBO=null}bind(e){const{context:t,painter:i}=e,{width:s,height:r}=t.getViewport(),n=i.getFbos(s,r).effect0;this.setup(e,s,r),t.bindFramebuffer(n),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:e},t,i){this._width=t,this._height=i;const s=t%oi,r=i%oi;t+=s<oi/2?-s:oi-s,i+=r<oi/2?-r:oi-r,this._adjustedWidth=t,this._adjustedHeight=i,this._boundFBO=e.getBoundFramebufferObject();const n=Math.round(t*hi),a=Math.round(i*hi);this._hlRenderer.setup(e,n,a),this._hlSurfaces.setup(e,n,a)}draw({context:e}){const t=e.getBoundFramebufferObject();e.setViewport(0,0,this._adjustedWidth*hi,this._adjustedHeight*hi),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setStencilTestEnabled(!1),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(e,t.colorTexture,w.cw.NEAREST,1),e.setStencilTestEnabled(!1),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!0),e.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(e,this._hlSurfaces.sharedBlur1Tex),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(e,this._hlSurfaces.sharedBlur2Tex),e.bindFramebuffer(this._boundFBO),e.setBlendingEnabled(!0),e.setColorMask(!0,!0,!0,!0),e.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(e,this._hlSurfaces.sharedBlur1Tex,this._hlGradient),this._boundFBO=null}setHighlightOptions(e){this._hlGradient.setHighlightOptions(e)}}class ci extends Dt{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){(0,a.pC)(this._fbo)&&this._fbo.dispose()}createOptions({pixelRatio:e},t,i=G.dn){if(!t.length)return null;const s=t.shift(),r=s.point.x,n=s.point.y;return this._outstanding=s,{type:"hittest",distance:i*e,position:[r,n]}}bind(e){const{context:t,attributeView:i}=e;if(!i.size)return;const s=i.getBlock(G.pU);if((0,a.Wi)(s))return;const r=s.getFBO(t);t.setViewport(0,0,i.size,i.size),t.bindFramebuffer(r),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT)}unbind(e){}draw(e){const{context:t,attributeView:i}=e,s=i.getBlock(G.pU);if((0,a.Wi)(this._outstanding))return;const r=this._outstanding.resolver;if((0,a.Wi)(s))return r.resolve([]),void(this._outstanding=null);const n=s.getFBO(t),o=new Uint8Array(n.width*n.height*4);n.readPixels(0,0,n.width,n.height,w.VI.RGBA,w.Br.UNSIGNED_BYTE,o);const h=[];for(let a=0;a<o.length;a+=4){const e=o[a],t=o[a+3];e&&h.push({id:a/4,directHits:t})}this._outstanding=null,h.sort(((e,t)=>t.directHits===e.directHits?t.id-e.id:t.directHits-e.directHits)),r.resolve(h.map((e=>e.id)))}}class ui extends Dt{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0}dispose(){(0,a.pC)(this._fbo)&&this._fbo.dispose()}bind({context:e,painter:t}){const{width:i,height:s}=e.getViewport();this._boundFBO=e.getBoundFramebufferObject();const r=t.getFbos(i,s).effect0;e.bindFramebuffer(r),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind({context:e}){e.bindFramebuffer(this._boundFBO),this._boundFBO=null}draw({context:e,state:t,pixelRatio:i},s,r=2*G.dn){const n=e.getBoundFramebufferObject(),a=t.size[1]*i,o=Math.round(r*i),h=o/2,l=o/2;this._ensureBuffer(o),s.forEach(((e,t)=>{const r=new Map,c=Math.floor(t.x*i-o/2),u=Math.floor(a-t.y*i-o/2);n.readPixels(c,u,o,o,w.VI.RGBA,w.Br.UNSIGNED_BYTE,this._buf);for(let i=0;i<this._buf32.length;i++){const e=this._buf32[i];if(4294967295!==e&&0!==e){const t=i%o,s=o-Math.floor(i/o),n=(h-t)*(h-t)+(l-s)*(l-s),a=r.has(e)?r.get(e):4294967295;r.set(e,Math.min(n,a))}}const d=Array.from(r).sort(((e,t)=>e[1]-t[1])).map((e=>e[0]));e.resolve(d),s.delete(t)}))}_ensureBuffer(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}const di=5,_i=[1,0],pi=[0,1],mi=[1,.8,.6,.4,.2],fi=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class gi{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(di),this._nMips=di,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad&&(this._quad.dispose(),this._quad=null),this._intensityFBO&&(this._intensityFBO.dispose(),this._intensityFBO=null),this._compositeFBO&&(this._compositeFBO.dispose(),this._compositeFBO=null),this._mipsFBOs){for(let e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}draw(e,t,i){const{width:s,height:r}=t,{context:n,painter:a}=e,{materialManager:o}=a,h=n.gl,l=this._programDesc,{strength:c,radius:u,threshold:d}=i;this._quad||(this._quad=new At.Z(n,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,s,r),n.setStencilTestEnabled(!1),n.setBlendingEnabled(!0),n.setBlendFunction(w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA),n.setStencilWriteMask(0);const _=this._quad;_.bind(),n.bindFramebuffer(this._intensityFBO);const p=o.getProgram(l.luminosityHighPass);n.useProgram(p),n.bindTexture(t.colorTexture,0),p.setUniform1i("u_texture",0),p.setUniform3fv("u_defaultColor",[0,0,0]),p.setUniform1f("u_defaultOpacity",0),p.setUniform1f("u_luminosityThreshold",d),p.setUniform1f("u_smoothWidth",.01);const m=[Math.round(s/2),Math.round(r/2)];n.setViewport(0,0,m[0],m[1]),n.setClearColor(0,0,0,0),n.clear(h.COLOR_BUFFER_BIT),_.draw(),n.setBlendingEnabled(!1);let f=this._intensityFBO.colorTexture;for(let w=0;w<this._nMips;w++){const e=o.getProgram(l.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[w]}]);n.useProgram(e),n.bindTexture(f,w+1),e.setUniform1i("u_colorTexture",w+1),e.setUniform2fv("u_texSize",m),e.setUniform2fv("u_direction",_i),n.setViewport(0,0,m[0],m[1]);const t=this._mipsFBOs[w];n.bindFramebuffer(t.horizontal),_.draw(),f=t.horizontal.colorTexture,n.bindFramebuffer(t.vertical),n.bindTexture(f,w+1),e.setUniform2fv("u_direction",pi),_.draw(),f=t.vertical.colorTexture,m[0]=Math.round(m[0]/2),m[1]=Math.round(m[1]/2)}n.setViewport(0,0,s,r);const g=o.getProgram(l.composite,[{name:"nummips",value:di}]);n.bindFramebuffer(this._compositeFBO),n.useProgram(g),g.setUniform1f("u_bloomStrength",c),g.setUniform1f("u_bloomRadius",u),g.setUniform1fv("u_bloomFactors",mi),g.setUniform3fv("u_bloomTintColors",fi),n.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),g.setUniform1i("u_blurTexture1",1),n.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),g.setUniform1i("u_blurTexture2",2),n.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),g.setUniform1i("u_blurTexture3",3),n.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),g.setUniform1i("u_blurTexture4",4),n.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),g.setUniform1i("u_blurTexture5",5),_.draw(),n.bindFramebuffer(t),n.setBlendingEnabled(!0);const b=o.getProgram(l.blit);n.useProgram(b),n.bindTexture(this._compositeFBO.colorTexture,6),b.setUniform1i("u_texture",6),n.setBlendFunction(w.zi.ONE,w.zi.ONE),_.draw(),_.unbind(),n.setBlendFunction(w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA),n.setStencilTestEnabled(!0)}_createOrResizeResources(e,t,i){const{context:s}=e;if(this._compositeFBO&&this._size[0]===t&&this._size[1]===i)return;this._size[0]=t,this._size[1]=i;const r=[Math.round(t/2),Math.round(i/2)];this._compositeFBO?this._compositeFBO.resize(t,i):this._compositeFBO=new ri.X(s,{colorTarget:w.Lm.TEXTURE,depthStencilTarget:w.OU.NONE,width:t,height:i}),this._intensityFBO?this._intensityFBO.resize(r[0],r[1]):this._intensityFBO=new ri.X(s,{colorTarget:w.Lm.TEXTURE,depthStencilTarget:w.OU.NONE,width:r[0],height:r[1]},{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,internalFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,samplingMode:w.cw.LINEAR,flipped:!1,width:r[0],height:r[1]});for(let n=0;n<this._nMips;n++)this._mipsFBOs[n]?(this._mipsFBOs[n].horizontal.resize(r[0],r[1]),this._mipsFBOs[n].vertical.resize(r[0],r[1])):this._mipsFBOs[n]={horizontal:new ri.X(s,{colorTarget:w.Lm.TEXTURE,depthStencilTarget:w.OU.NONE,width:r[0],height:r[1]},{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,internalFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,samplingMode:w.cw.LINEAR,flipped:!1,width:r[0],height:r[1]}),vertical:new ri.X(s,{colorTarget:w.Lm.TEXTURE,depthStencilTarget:w.OU.NONE,width:r[0],height:r[1]},{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,internalFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,samplingMode:w.cw.LINEAR,flipped:!1,width:r[0],height:r[1]})},r[0]=Math.round(r[0]/2),r[1]=Math.round(r[1]/2)}}const bi=[1,0],wi=[0,1];class yi{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(e,t,i){const{context:s}=e,{type:r,radius:n}=i;if(0===n)return;this._createOrResizeResources(e),this._quad||(this._quad=new At.Z(s,[-1,-1,1,-1,-1,1,1,1]));const a=this._quad;a.bind(),"blur"===r?this._gaussianBlur(e,t,n):this._radialBlur(e,t),a.unbind()}_gaussianBlur(e,t,i){const{context:s,state:r,painter:n,pixelRatio:a}=e,{size:o}=r,{materialManager:h}=n,l=this._programDesc,c=this._quad,u=[Math.round(a*o[0]),Math.round(a*o[1])],d=this._blurFBO,_=h.getProgram(l.gaussianBlur,[{name:"radius",value:Math.ceil(i)}]);s.useProgram(_),s.setBlendingEnabled(!1),s.bindFramebuffer(d),s.bindTexture(t.colorTexture,4),_.setUniform1i("u_colorTexture",4),_.setUniform2fv("u_texSize",u),_.setUniform2fv("u_direction",bi),_.setUniform1f("u_sigma",i),c.draw(),s.bindFramebuffer(t),s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.bindTexture(d.colorTexture,5),_.setUniform1i("u_colorTexture",5),_.setUniform2fv("u_direction",wi),c.draw(),s.setBlendingEnabled(!0),s.setBlendFunction(w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA),s.setStencilTestEnabled(!0)}_radialBlur(e,t){const{context:i,painter:s}=e,{materialManager:r}=s,n=this._programDesc,a=this._quad,o=this._blurFBO;i.bindFramebuffer(o);const h=r.getProgram(n.radialBlur);i.useProgram(h),i.setBlendingEnabled(!1),i.bindTexture(t.colorTexture,4),h.setUniform1i("u_colorTexture",4),a.draw(),i.bindFramebuffer(t),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setBlendingEnabled(!0);const l=r.getProgram(n.blit);i.useProgram(l),i.bindTexture(o.colorTexture,5),l.setUniform1i("u_texture",5),i.setBlendFunction(w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA),a.draw()}_createOrResizeResources(e){const{context:t,state:i,pixelRatio:s}=e,{size:r}=i,n=Math.round(s*r[0]),a=Math.round(s*r[1]);this._blurFBO&&this._size[0]===n&&this._size[1]===a||(this._size[0]=n,this._size[1]=a,this._blurFBO?this._blurFBO.resize(n,a):this._blurFBO=new ri.X(t,{colorTarget:w.Lm.TEXTURE,depthStencilTarget:w.OU.NONE,width:n,height:a},{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,internalFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,samplingMode:w.cw.LINEAR,flipped:!1,width:n,height:a}))}}class vi{constructor(){this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}draw(e,t,i){const{width:s,height:r}=t;this._createOrResizeResources(e,s,r);const{context:n,painter:a}=e,{materialManager:o}=a,h=this._programDesc,l=this._quad,c=i.colorMatrix;l.bind();const u=this._layerFBOTexture;n.bindFramebuffer(t),t.copyToTexture(0,0,s,r,0,0,u),n.setBlendingEnabled(!1),n.setStencilTestEnabled(!1);const d=o.getProgram(h);n.useProgram(d),n.bindTexture(u,2),d.setUniformMatrix4fv("u_coefficients",c),d.setUniform1i("u_colorTexture",2),l.draw(),n.setBlendingEnabled(!0),n.setBlendFunction(w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA),n.setStencilTestEnabled(!0),l.unbind()}_createOrResizeResources(e,t,i){const{context:s}=e;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new q.x(s,{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,internalFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,samplingMode:w.cw.LINEAR,flipped:!1,width:t,height:i}),this._quad||(this._quad=new At.Z(s,[-1,-1,1,-1,-1,1,1,1])))}}const xi=[1,0],Ti=[0,1];class Ei{constructor(){this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null),this._horizontalBlurFBO&&(this._horizontalBlurFBO.dispose(),this._horizontalBlurFBO=null),this._verticalBlurFBO&&(this._verticalBlurFBO.dispose(),this._verticalBlurFBO=null)}draw(e,t,i){const{context:s,state:r,painter:n}=e,{materialManager:a}=n,o=this._programDesc,h=t.width,l=t.height,c=[Math.round(h/2),Math.round(l/2)],{blurRadius:u,offsetX:d,offsetY:_,color:p}=i,m=[(0,D.F2)(d/2),(0,D.F2)(_/2)];this._createOrResizeResources(e,h,l,c);const f=this._horizontalBlurFBO,g=this._verticalBlurFBO;s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1);const b=this._layerFBOTexture;t.copyToTexture(0,0,h,l,0,0,b),this._quad||(this._quad=new At.Z(s,[-1,-1,1,-1,-1,1,1,1])),s.setViewport(0,0,c[0],c[1]);const y=this._quad;y.bind(),s.setBlendingEnabled(!1);const v=a.getProgram(o.blur,[{name:"radius",value:Math.ceil(u)}]);s.useProgram(v),s.bindFramebuffer(f),s.bindTexture(t.colorTexture,4),v.setUniform1i("u_colorTexture",4),v.setUniform2fv("u_texSize",c),v.setUniform2fv("u_direction",xi),v.setUniform1f("u_sigma",u),y.draw(),s.bindFramebuffer(g),s.bindTexture(f.colorTexture,5),v.setUniform1i("u_colorTexture",5),v.setUniform2fv("u_direction",Ti),y.draw(),s.bindFramebuffer(t),s.setViewport(0,0,h,l);const x=a.getProgram(o.composite);s.useProgram(x),s.bindTexture(g.colorTexture,2),x.setUniform1i("u_blurTexture",2),s.bindTexture(b,3),x.setUniform1i("u_layerFBOTexture",3),x.setUniform4fv("u_shadowColor",[p[3]*(p[0]/255),p[3]*(p[1]/255),p[3]*(p[2]/255),p[3]]),x.setUniformMatrix3fv("u_displayViewMat3",r.displayMat3),x.setUniform2fv("u_shadowOffset",m),y.draw(),s.setBlendingEnabled(!0),s.setStencilTestEnabled(!0),s.setBlendFunction(w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA),y.unbind()}_createOrResizeResources(e,t,i,s){const{context:r}=e;this._horizontalBlurFBO&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._horizontalBlurFBO?this._horizontalBlurFBO.resize(s[0],s[1]):this._horizontalBlurFBO=new ri.X(r,{colorTarget:w.Lm.TEXTURE,depthStencilTarget:w.OU.NONE,width:s[0],height:s[1]},{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,internalFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,samplingMode:w.cw.LINEAR,flipped:!1,width:s[0],height:s[1]}),this._verticalBlurFBO?this._verticalBlurFBO.resize(s[0],s[1]):this._verticalBlurFBO=new ri.X(r,{colorTarget:w.Lm.TEXTURE,depthStencilTarget:w.OU.NONE,width:s[0],height:s[1]},{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,internalFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,samplingMode:w.cw.LINEAR,flipped:!1,width:s[0],height:s[1]}),this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new q.x(r,{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,internalFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,samplingMode:w.cw.LINEAR,flipped:!1,width:t,height:i}))}}class Mi{constructor(){this._size=[0,0]}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}draw(e,t,i){const{width:s,height:r}=t;this._createOrResizeResources(e,s,r);const{context:n,painter:a}=e,{amount:o}=i,h=n.gl,l=this._layerFBOTexture;n.bindFramebuffer(t),t.copyToTexture(0,0,s,r,0,0,l),n.setBlendingEnabled(!0),n.setStencilTestEnabled(!1),n.setDepthTestEnabled(!1),n.setClearColor(0,0,0,0),n.clear(h.COLOR_BUFFER_BIT),a.blitTexture(n,l,w.cw.NEAREST,o)}_createOrResizeResources(e,t,i){const{context:s}=e;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new q.x(s,{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,internalFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,samplingMode:w.cw.NEAREST,flipped:!1,width:t,height:i}))}}function Bi(e){switch(e){case"bloom":case"blur":case"opacity":case"drop-shadow":return e;default:return"colorize"}}const Ri={colorize:()=>new vi,blur:()=>new yi,bloom:()=>new gi,opacity:()=>new Mi,"drop-shadow":()=>new Ei};class Ci{constructor(){this._effectMap=new Map}dispose(){this._effectMap.forEach((e=>e.dispose())),this._effectMap.clear()}getPostProcessingEffects(e){if(!e||0===e.length)return[];const t=[];for(const i of e){const e=Bi(i.type);let s=this._effectMap.get(e);s||(s=Ri[e](),this._effectMap.set(e,s)),t.push({postProcessingEffect:s,effect:i})}return t}}var Fi=i(15055);class Oi{constructor(e,t){this.brushes=e,this.name=t.name,this.drawPhase=t.drawPhase||d.jx.MAP,this._targetFn=t.target,this.effects=t.effects||[],this.enableDefaultDraw=t.enableDefaultDraw??(()=>!0)}render(e){const{context:t,profiler:i}=e,s=this._targetFn(),r=this.drawPhase&e.drawPhase;if(i.recordPassStart(this.name),r){this.enableDefaultDraw()&&this._doRender(e,s),i.recordPassEnd();for(const r of this.effects){if(!r.enable())continue;const n=r.apply;i.recordPassStart(this.name+"."+n.name),i.recordBrushStart(n.name);const a=r.args&&r.args(),{x:o,y:h,width:l,height:c}=t.getViewport(),u=t.getBoundFramebufferObject();n.bind(e,a);const d=n.createOptions(e,a),_=e.passOptions;e.passOptions=d,this._doRender(e,s,n.defines),e.passOptions=_,n.draw(e,a),n.unbind(e,a),t.bindFramebuffer(u),t.setViewport(o,h,l,c),i.recordBrushEnd(),i.recordPassEnd()}}}_doRender(e,t,i){if(!(0,a.Wi)(t))if((0,Fi.zG)(t)){for(const s of t)if(s.visible)for(const t of this.brushes)e.profiler.recordBrushStart(t.name),t.prepareState(e,s,i),t.draw(e,s,i),e.profiler.recordBrushEnd()}else for(const s of this.brushes)e.profiler.recordBrushStart(s.name),s.prepareState(e,t,i),s.draw(e,t,i),e.profiler.recordBrushEnd()}}var Si=i(5802);function Pi(e,t){switch(e){case d.LW.LINE:return _.U.line;case d.LW.TEXT:return _.U.text;case d.LW.LABEL:return _.U.label;case d.LW.FILL:return t===d.mD.DOT_DENSITY?_.U.dotDensity:_.U.fill;case d.LW.MARKER:switch(t){case d.mD.HEATMAP:return _.U.heatmap;case d.mD.PIE_CHART:return _.U.pieChart;default:return _.U.marker}}}class Ai{constructor(e,t,i){this.context=e,this._blitRenderer=new x,this._worldExtentClipRenderer=new It,this._isClippedToWorldExtent=!1,this._brushCache=new Map,this._vtlMaterialManager=new p.Z,this._blendEffect=new Vt,this._fboPool=[],this.effects={highlight:new li,hittest:new ci,hittestVTL:new ui,integrate:new Lt,insideEffect:new Zt("inside"),outsideEffect:new Zt("outside")},this.materialManager=new S(e),this.textureManager=new Rt(t,i),this._effectsManager=new Ci}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getRenderTarget(){return this._renderTarget}setRenderTarget(e){this._renderTarget=e}getFbos(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(const i in this._fbos)this._fbos[i].resize(e,t);return this._fbos}const i={target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,samplingMode:w.cw.NEAREST,wrapMode:w.e8.CLAMP_TO_EDGE,width:e,height:t},s={colorTarget:w.Lm.TEXTURE,depthStencilTarget:w.OU.DEPTH_STENCIL_RENDER_BUFFER},r=new Si.r(this.context,{width:e,height:t,internalFormat:w.Tg.DEPTH_STENCIL});this._stencilBuf=r,this._fbos={output:new ri.X(this.context,s,i,r),blend:new ri.X(this.context,s,i,r),effect0:new ri.X(this.context,s,i,r)}}return this._fbos}acquireFbo(e,t){let i;i=this._fboPool.length>0?this._fboPool.pop():new ri.X(this.context,{colorTarget:w.Lm.TEXTURE,depthStencilTarget:w.OU.DEPTH_STENCIL_RENDER_BUFFER},{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,samplingMode:w.cw.NEAREST,wrapMode:w.e8.CLAMP_TO_EDGE,width:e,height:t},this._stencilBuf);const s=i.descriptor;return s.width===e&&s.height===t||i.resize(e,t),i}releaseFbo(e){this._fboPool.push(e)}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderLayers(e,t=null){const{width:i,height:s}=e.getViewport();this._prevFBO=e.getBoundFramebufferObject();const r=this.getFbos(i,s);if(e.bindFramebuffer(r.output),e.setColorMask(!0,!0,!0,!0),(0,a.pC)(t)){const{r:i,g:s,b:r,a:n}=t.color;e.setClearColor(n*i/255,n*s/255,n*r/255,n)}else e.setClearColor(0,0,0,0);e.setDepthWriteEnabled(!0),e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)}beforeRenderLayer(e,t,i){const{context:s,blendMode:r,effects:n,requireFBO:a,drawPhase:o}=e;if(a||zi(o,r,n,i))s.bindFramebuffer(this._fbos.blend),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.setDepthWriteEnabled(!0),s.setClearDepth(1),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT),s.setDepthWriteEnabled(!1);else{const e=this._getOutputFBO();s.bindFramebuffer(e)}s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!0),s.setClearStencil(t),s.setStencilWriteMask(255),s.clear(s.gl.STENCIL_BUFFER_BIT)}compositeLayer(e,t){const{context:i,blendMode:s,effects:r,requireFBO:n,drawPhase:o}=e;if(n||zi(o,s,r,t)){(0,a.pC)(r)&&r.length>0&&o===d.jx.MAP&&this._applyEffects(e,r);const n=this._getOutputFBO();i.bindFramebuffer(n),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA,w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA),i.setColorMask(!0,!0,!0,!0);const h=(0,a.Wi)(s)||o===d.jx.HIGHLIGHT?"normal":s;this._blendEffect.draw(e,this._fbos.blend.colorTexture,w.cw.NEAREST,h,t)}}renderLayers(e){if(e.bindFramebuffer(this._prevFBO),!this._fbos)return;const t=this._getOutputFBO();e.setDepthTestEnabled(!1),e.setStencilWriteMask(0),this._isClippedToWorldExtent?(e.setStencilTestEnabled(!0),e.setStencilFunction(w.wb.EQUAL,1,255)):e.setStencilTestEnabled(!1),this.blitTexture(e,t.colorTexture,w.cw.NEAREST)}prepareDisplay(e,t,i){const{context:s}=e;if(s.bindFramebuffer(this._prevFBO),s.setColorMask(!0,!0,!0,!0),(0,a.pC)(t)){const{r:e,g:i,b:r,a:n}=t.color;s.setClearColor(n*e/255,n*i/255,n*r/255,n)}else s.setClearColor(0,0,0,0);s.setStencilWriteMask(255),s.setClearStencil(0),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.STENCIL_BUFFER_BIT),this._isClippedToWorldExtent=this._worldExtentClipRenderer.render(e,i)}dispose(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer=(0,a.O3)(this._blitRenderer),this._worldExtentClipRenderer=(0,a.O3)(this._worldExtentClipRenderer),this._brushCache&&(this._brushCache.forEach((e=>e.dispose())),this._brushCache.clear(),this._brushCache=null),this._fbos)for(const e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();for(const e of this._fboPool)e.dispose();if(this._fboPool.length=0,this.effects)for(const e in this.effects)this.effects[e]&&this.effects[e].dispose();this._effectsManager.dispose(),this._vtlMaterialManager=(0,a.O3)(this._vtlMaterialManager),this._prevFBO=null}getBrush(e,t){const i=Pi(e,t);let s=this._brushCache.get(i);return void 0===s&&(s=new i,this._brushCache.set(i,s)),this._brushCache.get(i)}renderObject(e,t,i,s){const r=_.U[i];if(!r)return null;let n=this._brushCache.get(r);void 0===n&&(n=new r,this._brushCache.set(r,n)),n.prepareState(e,t,s),n.draw(e,t,s)}renderObjects(e,t,i,s){const r=_.U[i];if(!r)return null;let n=this._brushCache.get(r);void 0===n&&(n=new r,this._brushCache.set(r,n)),n.drawMany(e,t,s)}registerRenderPass(e){const t=e.brushes.map((e=>(this._brushCache.has(e)||this._brushCache.set(e,new e),this._brushCache.get(e))));return new Oi(t,e)}setHighlightOptions(e){this.effects.highlight.setHighlightOptions(e)}blitTexture(e,t,i,s=1){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA,w.zi.ONE,w.zi.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,i,s)}getPostProcessingEffects(e){return this._effectsManager.getPostProcessingEffects(e)}_getOutputFBO(){return null!=this._renderTarget?this._renderTarget:this._fbos.output}_applyEffects(e,t){const{context:i}=e,s=this._effectsManager.getPostProcessingEffects(t);for(const{postProcessingEffect:r,effect:n}of s)i.bindFramebuffer(this._fbos.blend),r.draw(e,this._fbos.blend,n)}}function zi(e,t,i,s){return e!==d.jx.HIGHLIGHT&&(1!==s||(0,a.pC)(t)&&"normal"!==t||(0,a.pC)(i)&&i.length>0)}var Ui=i(18548),Ii=i(96545),Di=i(61073);const Li=(0,n.Z)("esri-2d-profiler");class Ni{constructor(e,t){if(this._events=new Ii.Z,this._entries=new Map,this._timings=new Ui.Z(10),!Li)return;this._ext=(0,Di.m)(e.gl,{}),this._debugOutput=t;const i=e.gl;if(this.enableCommandLogging)for(const s in i)if("function"==typeof i[s]){const e=i[s],t=s.includes("draw");i[s]=(...r)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:s,args:r,isDrawCommand:t}),this._currentSummary&&(this._currentSummary.commands++,t&&this._currentSummary.drawCommands++),e.apply(i,r))}}get enableCommandLogging(){return!("object"==typeof Li&&Li.disableCommands)}recordContainerStart(e){Li&&(this._currentContainer=e)}recordContainerEnd(){Li&&(this._currentContainer=null)}recordPassStart(e){Li&&(this._currentPass=e,this._initSummary())}recordPassEnd(){Li&&(this._currentPass=null,this._emitSummary())}recordBrushStart(e){Li&&(this._currentBrush=e)}recordBrushEnd(){Li&&(this._currentBrush=null)}recordStart(e){if(Li&&(0,a.pC)(this._ext)){if(this._entries.has(e)){const t=this._entries.get(e),i=this._ext.resultAvailable(t.query),s=this._ext.disjoint();if(i&&!s){const i=this._ext.getResult(t.query)/1e6;let s=0;if((0,a.pC)(this._timings.enqueue(i))){const e=this._timings.entries,t=e.length;let i=0;for(const s of e)i+=s;s=i/t}const r=i.toFixed(2),n=s?s.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${e}, ${r} ms (${n} last 10 avg)\n${t.commandsLen} Commands (${t.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(t.summaries),console.log("Commands: ",t.commands),console.groupEnd()):console.log(`Frame report for ${e}, ${r} ms (${n} last 10 avg)`),this._debugOutput.innerHTML=`${r} (${n})`}for(const e of t.handles)e.remove();this._entries.delete(e)}const t={name:e,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(t.handles.push(this._events.on("command",(e=>{t.commandsLen++,t.commands.push(e),e.isDrawCommand&&t.drawCommands++}))),t.handles.push(this._events.on("summary",(e=>{t.summaries.push(e)})))),this._ext.beginTimeElapsed(t.query),this._entries.set(e,t)}}recordEnd(e){Li&&(0,a.pC)(this._ext)&&this._entries.has(e)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._events.emit("summary",this._currentSummary)}}var ki=i(61736),Gi=i(80886),Hi=i(24522),Vi=i(33485);const Zi=2e3;class qi extends u.W{constructor(e,t){super(),this._trash=new Set,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this.renderRequested=!1,this.stage=this,this._stationary=!0;const{canvas:i=document.createElement("canvas"),alpha:o=!0,stencil:l=!0,contextOptions:u={}}=t;this._canvas=i;const d=(0,Hi.sj)("2d",i,{alpha:o,antialias:!1,depth:!0,stencil:l});this.context=new Vi.x((0,a.pC)(d)?d:null,u),this.resourceManager=new c.Z,this.painter=new Ai(this.context,this,this.resourceManager),(0,n.Z)("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(this._debugOutput)),this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:t.timeline||new ki.T,renderingOptions:t.renderingOptions,requestRender:()=>this.requestRender(),requireFBO:!1,profiler:new Ni(this.context,this._debugOutput),dataUploadCounter:0},this._taskHandle=(0,h.A)({render:e=>this.renderFrame(e)}),this._taskHandle.pause(),this._lostWebGLContextHandle=(0,r.on)(i,"webglcontextlost",(()=>{this.emit("webgl-error",{error:new s.Z("webgl-context-lost")})})),i.setAttribute("style","width: 100%; height:100%; display:block;"),e.appendChild(i)}destroy(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get highlightOptions(){return this._highlightOptions}set highlightOptions(e){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=(0,o.YP)((()=>this._highlightOptions?.version),(()=>{this.painter.setHighlightOptions(e),this.requestRender()}),o.nn))}get renderingOptions(){return this._renderingOptions}set renderingOptions(e){this._renderingOptions=e,this.requestRender()}get state(){return this._state}set state(e){this._state=e,this.requestRender()}get stationary(){return this._stationary}set stationary(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}trashDisplayObject(e){this._trash.add(e),this.requestRender()}untrashDisplayObject(e){return this._trash.delete(e)}requestRender(){this._renderRemainingTime=Zi,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}renderFrame(e){const t=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=t,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}_createTransforms(){return{dvs:(0,l.c)()}}renderChildren(e){for(const t of this.children)t.beforeRender(e);this._renderChildren(this.children,e);for(const t of this.children)t.afterRender(e)}_renderChildren(e,t){const i=this.context;i.resetInfo(),t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,t.drawPhase=d.jx.MAP,this.painter.beforeRenderLayers(i,this.background);for(const s of e)s.processRender(t);this.painter.prepareDisplay(t,this.background,this.state.padding),this.painter.renderLayers(i),t.drawPhase=d.jx.HIGHLIGHT,this.painter.beforeRenderLayers(i);for(const s of e)s.processRender(t);if(this.painter.renderLayers(i),this._isLabelDrawPhaseRequired(e)){t.drawPhase=d.jx.LABEL,this.painter.beforeRenderLayers(i);for(const i of e)i.processRender(t);this.painter.renderLayers(i)}if((0,n.Z)("esri-tiles-debug")){t.drawPhase=d.jx.DEBUG,this.painter.beforeRenderLayers(i);for(const i of e)i.processRender(t);this.painter.renderLayers(i)}t.profiler.recordEnd("drawLayers"),i.logInfo()}doRender(e){const t=this.context,{state:i,pixelRatio:s}=e;this._resizeCanvas(e),t.setViewport(0,0,s*i.size[0],s*i.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),super.doRender(e)}async takeScreenshot(e){const{framebufferWidth:t,framebufferHeight:i}={framebufferWidth:Math.round(this.state.size[0]*e.resolutionScale),framebufferHeight:Math.round(this.state.size[1]*e.resolutionScale)},s=1,r=this.context,n=this._state.clone();if(null!=e.rotation){const t=n.viewpoint;n.viewpoint.rotation=e.rotation,n.viewpoint=t}const a={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:n,pixelRatio:s,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1},o=new ri.X(r,{colorTarget:w.Lm.TEXTURE,depthStencilTarget:w.OU.DEPTH_STENCIL_RENDER_BUFFER,width:t,height:i}),h=r.getBoundFramebufferObject(),l=r.getViewport();r.bindFramebuffer(o),r.setViewport(0,0,t,i),this._renderChildren(e.children,a);const c=this._readbackScreenshot(o,{...e.cropArea,y:i-(e.cropArea.y+e.cropArea.height)});r.bindFramebuffer(h),r.setViewport(l.x,l.y,l.width,l.height),this.requestRender();const u=await c;let d;return 1===e.outputScale?d=u:(d=new ImageData(Math.round(u.width*e.outputScale),Math.round(u.height*e.outputScale)),(0,Gi.TT)(u,d,!0)),d}async _readbackScreenshot(e,t){const i=(0,Gi.r7)(t.width,t.height,document.createElement("canvas"));return await e.readPixelsAsync(t.x,t.y,t.width,t.height,w.VI.RGBA,w.Br.UNSIGNED_BYTE,new Uint8Array(i.data.buffer)),i}_resizeCanvas(e){const t=this._canvas,i=t.style,{state:{size:s},pixelRatio:r}=e,n=s[0],a=s[1],o=Math.round(n*r),h=Math.round(a*r);t.width===o&&t.height===h||(t.width=o,t.height=h),i.width=n+"px",i.height=a+"px"}_emptyTrash(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const t of e)t.processDetach()}}_isLabelDrawPhaseRequired(e){let t=!1;for(const i of e){if(!(i instanceof u.W)){t=t||!1;break}if(i.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(i.children)}return t}}var Wi=i(61445),ji=i(92698),$i=i(30374),Xi=i(89572),Yi=i(58006),Qi=(i(94315),i(77623)),Ki=i(67752),Ji=i(49701);const es=2,ts=1,is=0,ss=1,rs=2;class ns{constructor(e,t){this.width=e,this.height=t;const i=Math.ceil(e/ts),s=Math.ceil(t/ts);this._cols=i,this._rows=s,this._cells=Ji.p.create(i*s)}insertMetrics(e){const t=this._hasCollision(e);return t===is&&this._markMetrics(e),t}getCellId(e,t){return e+t*this._cols}has(e){return this._cells.has(e)}hasRange(e,t){return this._cells.hasRange(e,t)}set(e){this._cells.set(e)}setRange(e,t){this._cells.setRange(e,t)}_hasCollision(e){const t=e.id;let i=0,s=0;e.save();do{const t=e.boundsCount;i+=t;for(let i=0;i<t;i++){const t=e.boundsComputedAnchorX(i),r=e.boundsComputedAnchorY(i),n=e.boundsWidth(i)+es,a=e.boundsHeight(i)+es;switch(this._collide(t,r,n,a)){case rs:return rs;case ss:s++}}}while(e.peekId()===t&&e.next());return e.restore(),i===s?ss:is}_collide(e,t,i,s){const r=e-i/2,n=t-s/2,a=r+i,o=n+s;if(a<0||o<0||r>this.width||n>this.height)return ss;const h=(0,Ki.uZ)(Math.floor(r/ts),0,this._cols),l=(0,Ki.uZ)(Math.floor(n/ts),0,this._rows),c=(0,Ki.uZ)(Math.ceil(a/ts),0,this._cols),u=(0,Ki.uZ)(Math.ceil(o/ts),0,this._rows);for(let d=l;d<=u;d++)for(let e=h;e<=c;e++){const t=this.getCellId(e,d);if(this.has(t))return rs}return is}_mark(e,t,i,s){const r=e-i/2,n=t-s/2,a=r+i,o=n+s,h=(0,Ki.uZ)(Math.floor(r/ts),0,this._cols),l=(0,Ki.uZ)(Math.floor(n/ts),0,this._rows),c=(0,Ki.uZ)(Math.ceil(a/ts),0,this._cols),u=(0,Ki.uZ)(Math.ceil(o/ts),0,this._rows);for(let d=l;d<=u;d++)for(let e=h;e<=c;e++){const t=this.getCellId(e,d);this.set(t)}return!1}_markMetrics(e){const t=e.id;do{const t=e.boundsCount;for(let i=0;i<t;i++){const t=e.boundsComputedAnchorX(i),s=e.boundsComputedAnchorY(i),r=e.boundsWidth(i)+es,n=e.boundsHeight(i)+es;this._mark(t,s,r,n)}}while(e.peekId()===t&&e.next())}}var as=i(77495),os=i(19675);const hs=Math.PI;function ls(e,t){switch(t.transformationType){case os.hL.Additive:return us(e,t);case os.hL.Constant:return ds(t,e);case os.hL.ClampedLinear:return _s(e,t);case os.hL.Proportional:return ps(e,t);case os.hL.Stops:return ms(e,t);case os.hL.RealWorldSize:return fs(e,t);case os.hL.Identity:return e;case os.hL.Unknown:return null}}function cs(e,t){return"number"==typeof e?e:ls(t,e)}function us(e,t){return e+(cs(t.minSize,e)||t.minDataValue)}function ds(e,t){const i=e.stops;let s=i&&i.length&&i[0].size;return null==s&&(s=e.minSize),cs(s,t)}function _s(e,t){const i=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),s=cs(t.minSize,e),r=cs(t.maxSize,e);return e<=t.minDataValue?s:e>=t.maxDataValue?r:s+i*(r-s)}function ps(e,t){const i=e/t.minDataValue,s=cs(t.minSize,e),r=cs(t.maxSize,e);let n=null;return n=i*s,(0,Ki.uZ)(n,s,r)}function ms(e,t){const[i,s,r]=gs(e,t.cache.ipData);if(i===s)return cs(t.stops[i].size,e);{const n=cs(t.stops[i].size,e);return n+(cs(t.stops[s].size,e)-n)*r}}function fs(e,t){const i=as.a[t.valueUnit],s=cs(t.minSize,e),r=cs(t.maxSize,e),{valueRepresentation:n}=t;let a=null;return a="area"===n?2*Math.sqrt(e/hs)/i:"radius"===n||"distance"===n?2*e/i:e/i,(0,Ki.uZ)(a,s,r)}function gs(e,t){if(!t)return;let i=0,s=t.length-1;return t.some(((t,r)=>e<t?(s=r,!0):(i=r,!1))),[i,s,(e-t[i])/(t[s]-t[i])]}const bs=254,ws=255,ys=0;function vs(e,t){const i=[];e.forEachTile((e=>i.push(e))),i.sort(((e,t)=>e.instanceId-t.instanceId)),i.forEach((e=>{(0,a.pC)(e.labelMetrics)&&e.isReady&&t(e,e.labelMetrics.getCursor())}))}function xs(e){return e.layer&&("feature"===e.layer.type||"csv"===e.layer.type||"geojson"===e.layer.type||"ogc-feature"===e.layer.type||"stream"===e.layer.type||"subtype-group"===e.layer.type||"wfs"===e.layer.type)}function Ts(e){return t=>(0,D.F2)(ls(t,e))}function Es(e){const t="visualVariables"in e&&e.visualVariables;if(!t)return null;for(const i of t)if("size"===i.type)return Ts(i);return null}function Ms(e){for(const t of e){const e="featureReduction"in t&&t.featureReduction&&"labelingInfo"in t.featureReduction&&t.featureReduction,i=[...t.labelingInfo||[],...e?.labelingInfo||[]];if(t.labelsVisible&&i.length&&i.some((e=>"none"===e.deconflictionStrategy)))return!0}return!1}function Bs(e,t){if(!xs(t))return;const i="subtype-group"===t.layer.type?t.layer.sublayers.items:[t.layer],s=t.layer.geometryType,r=!Ms(i),n={};if("subtype-group"!==t.layer.type){if("heatmap"===t.tileRenderer?.type)return;const e=Es(t.layer.renderer);n[0]=e}const o=t.tileRenderer;if((0,a.Wi)(o))return;const h=t.layer.visible&&!t.suspended;e.push({tileRenderer:o,vvEvaluators:n,deconflictionEnabled:r,geometryType:s,visible:h})}class Rs{run(e,t,i){const s=[];for(let r=e.length-1;r>=0;r--)Bs(s,e[r]);this._transformMetrics(s,t),this._runCollision(s,t,i)}_runCollision(e,t,i){const[s,r]=t.state.size,n=new ns(s*t.pixelRatio,r*t.pixelRatio);for(const{tileRenderer:a,deconflictionEnabled:o,visible:h}of e){const e=a.featuresView.attributeView;o?h?(this._prepare(a),this._collideVisible(n,a,i),this._collideInvisible(n,a)):vs(a,((t,i)=>{for(;i.nextId();)e.setLabelMinZoom(i.id,ws)})):vs(a,((t,i)=>{for(;i.nextId();)e.setLabelMinZoom(i.id,ys)}))}}_isFiltered(e,t,i){const s=t.getFilterFlags(e),r=!i.hasFilter||!!(s&G.Zd),n=(0,a.Wi)(i.featureEffect)||i.featureEffect.excludedLabelsVisible||!!(s&G.iV);return!(r&&n)}_prepare(e){const t=e.featuresView.attributeView,i=new Set;vs(e,((s,r)=>{for(;r.nextId();)i.has(r.id)||(i.add(r.id),this._isFiltered(r.id,t,e.layerView)?t.setLabelMinZoom(r.id,bs):t.getLabelMinZoom(r.id)!==ys?t.setLabelMinZoom(r.id,ws):t.setLabelMinZoom(r.id,ys))}))}_collideVisible(e,t,i){const s=t.featuresView.attributeView,r=new Set;vs(t,((t,n)=>{for(;n.nextId();)if(!r.has(n.id))if(t.key.level===i){if(0===s.getLabelMinZoom(n.id))switch(e.insertMetrics(n)){case ss:break;case rs:s.setLabelMinZoom(n.id,bs),r.add(n.id);break;case is:s.setLabelMinZoom(n.id,ys),r.add(n.id)}}else s.setLabelMinZoom(n.id,bs)}))}_collideInvisible(e,t){const i=t.featuresView.attributeView,s=new Set;vs(t,((t,r)=>{for(;r.nextId();)if(!s.has(r.id)&&i.getLabelMinZoom(r.id)===ws)switch(e.insertMetrics(r)){case ss:break;case rs:i.setLabelMinZoom(r.id,ws),s.add(r.id);break;case is:i.setLabelMinZoom(r.id,ys),s.add(r.id)}}))}_transformMetrics(e,t){for(const{tileRenderer:i,geometryType:s,vvEvaluators:r}of e)vs(i,((e,n)=>{const o=i.featuresView.attributeView,h=e.transforms.labelMat2d;h[4]=Math.round(h[4]),h[5]=Math.round(h[5]);const l=h[4],c=h[5],u="polyline"===s;for(;n.next();){const e=n.boundsCount,i=n.anchorX,s=n.anchorY;let d=n.size;const _=r[0];if((0,a.pC)(_)){const e=_(o.getVVSize(n.id));d=isNaN(e)||null==e||e===1/0?d:e}const p=n.directionX*(d/2),m=n.directionY*(d/2);for(let r=0;r<e;r++){let e=i,a=n.anchorY;if(u){let i=e+n.boundsX(r)+p,s=a+n.boundsY(r)+m;t.state.rotation?(i=h[0]*i+h[2]*s+h[4],s=h[1]*i+h[3]*s+h[5]):(i+=l,s+=c),n.setBoundsComputedAnchorX(r,Math.floor(i)),n.setBoundsComputedAnchorY(r,Math.floor(s))}else{t.state.rotation?(e=h[0]*i+h[2]*s+h[4],a=h[1]*i+h[3]*s+h[5]):(e+=l,a+=c);const o=e+n.boundsX(r)+p,u=a+n.boundsY(r)+m;n.setBoundsComputedAnchorX(r,o),n.setBoundsComputedAnchorY(r,u)}}}}))}}const Cs=32;U.Z.getLogger("esri.views.2d.layers.labels.LabelManager");let Fs=class extends((0,$i.p)(ji.Z)){constructor(e){super(e),this._applyVisibilityPassThrottled=(0,Xi.P)(this._applyVisibilityPass,Cs,this),this.lastUpdateId=-1,this.updateRequested=!1,this.view=null}initialize(){this.collisionEngine=new Rs}destroy(){this.collisionEngine=null,this._applyVisibilityPassThrottled.remove(),this._applyVisibilityPassThrottled=null}get updating(){return this.updateRequested}update(e){this._applyVisibilityPassThrottled(e)}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}processUpdate(e){this._set("updateParameters",e),this.updateRequested&&(this.updateRequested=!1,this.update(e))}_applyVisibilityPass(e){try{const t=this.view.featuresTilingScheme.getClosestInfoForScale(e.state.scale).level;this.collisionEngine.run(this.view.allLayerViews.items,e,t)}catch(Dt){}}};(0,Wi._)([(0,Yi.Cb)()],Fs.prototype,"updateRequested",void 0),(0,Wi._)([(0,Yi.Cb)({readOnly:!0})],Fs.prototype,"updateParameters",void 0),(0,Wi._)([(0,Yi.Cb)()],Fs.prototype,"updating",null),(0,Wi._)([(0,Yi.Cb)()],Fs.prototype,"view",void 0),Fs=(0,Wi._)([(0,Qi.j)("esri.views.2d.layers.labels.LabelManager")],Fs);const Os=Fs;var Ss=i(7839),Ps=i(57914),As=i(34492),zs=i(49304),Us=i(25063),Is=i(3107);const Ds={container:"esri-zoom-box__container",overlay:"esri-zoom-box__overlay",background:"esri-zoom-box__overlay-background",box:"esri-zoom-box__outline"},Ls={zoom:"Shift",counter:"Ctrl"};let Ns=class extends ji.Z{constructor(e){super(e),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(e){this._handles&&this._handles.forEach((e=>{e.remove()})),this._handles=null,this._destroyOverlay(),this._set("view",e),e&&(e.on("drag",[Ls.zoom],(e=>this._handleDrag(e,1)),Is.f.INTERNAL),e.on("drag",[Ls.zoom,Ls.counter],(e=>this._handleDrag(e,-1)),Is.f.INTERNAL))}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(e,t,i,s){this._box.x=e,this._box.y=t,this._box.width=i,this._box.height=s,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(e,t,i,s,r){const n=this.view,a=n.toMap((0,D.vW)(e+.5*i,t+.5*s));let o=Math.max(i/n.width,s/n.height);-1===r&&(o=1/o),this._destroyOverlay(),this.navigation.end(),n.goTo({center:a,scale:n.scale*o})}_updateBox(e,t,i,s){const r=this._boxShape;r.setAttributeNS(null,"x",""+e),r.setAttributeNS(null,"y",""+t),r.setAttributeNS(null,"width",""+i),r.setAttributeNS(null,"height",""+s),r.setAttributeNS(null,"class",Ds.box)}_updateBackground(e,t,i,s){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(e,t,i,s,this.view.width,this.view.height))}_createContainer(){const e=document.createElement("div");e.className=Ds.container,this.view.root.appendChild(e),this._container=e}_createOverlay(){const e=this.view.width,t=this.view.height,i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttributeNS(null,"d","M 0 0 L "+e+" 0 L "+e+" "+t+" L 0 "+t+" Z"),i.setAttributeNS(null,"class",Ds.background);const s=document.createElementNS("http://www.w3.org/2000/svg","rect"),r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),r.setAttributeNS(null,"class",Ds.overlay),r.appendChild(i),r.appendChild(s),this._container.appendChild(r),this._backgroundShape=i,this._boxShape=s,this._overlay=r}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(e,t,i,s,r,n){const a=e+i,o=t+s;return"M 0 0 L "+r+" 0 L "+r+" "+n+" L 0 "+n+" ZM "+e+" "+t+" L "+e+" "+o+" L "+a+" "+o+" L "+a+" "+t+" Z"}_handleDrag(e,t){const i=e.x,s=e.y,r=e.origin.x,n=e.origin.y;let a,o,h,l;switch(i>r?(a=r,h=i-r):(a=i,h=r-i),s>n?(o=n,l=s-n):(o=s,l=n-s),e.action){case"start":this._start();break;case"update":this._update(a,o,h,l);break;case"end":this._end(a,o,h,l,t)}e.stopPropagation()}_redraw(){if(!this._rafId)return;if(this._rafId=null,!this._overlay)return;const{x:e,y:t,width:i,height:s}=this._box;this._updateBox(e,t,i,s),this._updateBackground(e,t,i,s),this._rafId=requestAnimationFrame(this._redraw)}};(0,Wi._)([(0,Yi.Cb)()],Ns.prototype,"navigation",void 0),(0,Wi._)([(0,Yi.Cb)()],Ns.prototype,"view",null),Ns=(0,Wi._)([(0,Qi.j)("esri.views.2d.navigation.ZoomBox")],Ns);const ks=Ns;i(80388);var Gs=i(85194);let Hs=class extends ji.Z{constructor(e){super(e),this.animationTime=0,this.momentumEstimator=new Gs.G(500,6,.92),this.momentum=null,this.tmpMomentum=(0,Pt.c)(),this.momentumFinished=!1,this.viewpoint=new As.Z({targetGeometry:new zs.Z,scale:0,rotation:0}),(0,o.gx)((()=>this.momentumFinished),(()=>this.navigation.stop()))}begin(e,t){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(t),this.previousDrag=t}update(e,t){this.addToEstimator(t);let i=t.center.x,s=t.center.y;const r=this.previousDrag;i=r?r.center.x-i:-i,s=r?s-r.center.y:s,e.viewpoint=(0,Us.Rx)(this.viewpoint,e.viewpoint,[i||0,s||0]),this.previousDrag=t}end(e,t){this.addToEstimator(t);const i=e.navigation.momentumEnabled;this.momentum=i?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(e),this.previousDrag=null,this.navigation.end()}addToEstimator(e){const t=e.center.x,i=e.center.y,s=(0,D.s1)(-t,i),r=(0,Pt.f)(-t,i,0);this.momentumEstimator.add(s,r,.001*e.timestamp)}onAnimationUpdate(e){this.navigation.animationManager.animateContinous(e.viewpoint,((t,i)=>{this.momentumFinished=!this.momentum||this.momentum.isFinished(this.animationTime);const s=.001*i;if(!this.momentumFinished){const i=this.momentum.valueDelta(this.animationTime,s);(0,St.g)(this.tmpMomentum,this.momentum.direction,i),(0,Us.Rx)(t,t,this.tmpMomentum),e.constraints.constrainByGeometry(t)}this.animationTime+=s}))}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};(0,Wi._)([(0,Yi.Cb)()],Hs.prototype,"momentumFinished",void 0),(0,Wi._)([(0,Yi.Cb)()],Hs.prototype,"viewpoint",void 0),(0,Wi._)([(0,Yi.Cb)()],Hs.prototype,"navigation",void 0),Hs=(0,Wi._)([(0,Qi.j)("esri.views.2d.navigation.actions.Pan")],Hs);const Vs=Hs;var Zs=i(41565),qs=i(60844);let Ws=class extends ji.Z{constructor(e){super(e),this._animationTime=0,this._momentumFinished=!1,this._rotationMomentumEstimator=new Zs.y(.6,.15,.95),this._rotationDirection=1,this._zoomDirection=1,this._zoomMomentumEstimator=new qs.D,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new As.Z({targetGeometry:new zs.Z,scale:0,rotation:0}),this.own((0,o.gx)((()=>this._momentumFinished),(()=>this.navigation.stop())))}begin(e,t){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=t.angle,this._previousRadius=this._startRadius=t.radius,this._previousCenter=t.center,this._updateTimestamp=null,e.constraints.rotationEnabled&&this.addToRotateEstimator(0,t.timestamp),this.addToZoomEstimator(t,1)}update(e,t){null===this._updateTimestamp&&(this._updateTimestamp=t.timestamp);const i=t.angle,s=t.radius,r=t.center,n=Math.abs(180*(i-this._startAngle)/Math.PI),a=Math.abs(s-this._startRadius),o=this._startRadius/s;if(this._previousRadius){const h=s/this._previousRadius;let l=180*(i-this._previousAngle)/Math.PI;this._rotationDirection=l>=0?1:-1,this._zoomDirection=h>=1?1:-1,e.constraints.rotationEnabled?(null===this._zoomOnly&&t.timestamp-this._updateTimestamp>200&&(this._zoomOnly=a-n>0),null===this._zoomOnly||this._zoomOnly?l=0:this.addToRotateEstimator(i-this._startAngle,t.timestamp)):l=0,this.addToZoomEstimator(t,o),this.navigation.setViewpoint([r.x,r.y],1/h,l,[this._previousCenter.x-r.x,r.y-this._previousCenter.y])}this._previousAngle=i,this._previousRadius=s,this._previousCenter=r}end(e){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(e),this.navigation.end()}addToRotateEstimator(e,t){this._rotationMomentumEstimator.add(e,.001*t)}addToZoomEstimator(e,t){this._zoomMomentumEstimator.add(t,.001*e.timestamp)}canZoomIn(e){const t=e.scale,i=e.constraints.effectiveMaxScale;return 0===i||t>i}canZoomOut(e){const t=e.scale,i=e.constraints.effectiveMinScale;return 0===i||t<i}onAnimationUpdate(e){this.navigation.animationManager.animateContinous(e.viewpoint,((t,i)=>{const s=!this.canZoomIn(e)&&this._zoomDirection>1||!this.canZoomOut(e)&&this._zoomDirection<1,r=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),n=s||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),a=.001*i;if(this._momentumFinished=r&&n,!this._momentumFinished){const i=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,a))*this._rotationDirection*180/Math.PI:0;let s=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,a)):1;const r=(0,Ot.a)(),n=(0,Ot.a)();if(this._previousCenter){(0,L.a)(r,this._previousCenter.x,this._previousCenter.y),(0,Us.Dq)(n,e.size,e.padding),(0,L.b)(r,r,n);const{constraints:a,scale:o}=e,h=o*s;s<1&&!a.canZoomInTo(h)?(s=o/a.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):s>1&&!a.canZoomOutTo(h)&&(s=o/a.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),(0,Us.UZ)(t,e.viewpoint,s,i,r,e.size),e.constraints.constrainByGeometry(t)}}this._animationTime+=a}))}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};(0,Wi._)([(0,Yi.Cb)()],Ws.prototype,"_momentumFinished",void 0),(0,Wi._)([(0,Yi.Cb)()],Ws.prototype,"viewpoint",void 0),(0,Wi._)([(0,Yi.Cb)()],Ws.prototype,"navigation",void 0),Ws=(0,Wi._)([(0,Qi.j)("esri.views.2d.navigation.actions.Pinch")],Ws);const js=Ws,$s=(0,Ot.a)(),Xs=(0,Ot.a)();let Ys=class extends ji.Z{constructor(e){super(e),this._previousCenter=(0,Ot.a)(),this.viewpoint=new As.Z({targetGeometry:new zs.Z,scale:0,rotation:0})}begin(e,t){this.navigation.begin(),(0,L.a)(this._previousCenter,t.center.x,t.center.y)}update(e,t){const{state:{size:i,padding:s}}=e;(0,L.a)($s,t.center.x,t.center.y),(0,Us.ni)(Xs,i,s),e.viewpoint=(0,Us.$H)(this.viewpoint,e.state.paddedViewState.viewpoint,(0,Us.dI)(Xs,this._previousCenter,$s)),(0,L.c)(this._previousCenter,$s)}end(){this.navigation.end()}};(0,Wi._)([(0,Yi.Cb)()],Ys.prototype,"viewpoint",void 0),(0,Wi._)([(0,Yi.Cb)()],Ys.prototype,"navigation",void 0),Ys=(0,Wi._)([(0,Qi.j)("esri.views.2d.actions.Rotate")],Ys);const Qs=Ys,Ks=10,Js=1,er=new As.Z({targetGeometry:new zs.Z}),tr=[0,0],ir=250;let sr=class extends ji.Z{constructor(e){super(e),this._endTimer=null,this.animationManager=null}initialize(){this.pan=new Vs({navigation:this}),this.rotate=new Qs({navigation:this}),this.pinch=new js({navigation:this}),this.zoomBox=new ks({view:this.view,navigation:this})}destroy(){this.pan.destroy(),this.rotate.destroy(),this.pinch.destroy(),this.zoomBox.destroy(),this.pan=this.rotate=this.pinch=this.zoomBox=this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(ir)}async zoom(e,t=this._getDefaultAnchor()){if(this.stop(),this.begin(),this.view.constraints.snapToZoom&&this.view.constraints.effectiveLODs)return e<1?this.zoomIn(t):this.zoomOut(t);this.setViewpoint(t,e,0,[0,0])}async zoomIn(e){const t=this.view,i=t.constraints.snapToNextScale(t.scale);return this._zoomToScale(i,e)}async zoomOut(e){const t=this.view,i=t.constraints.snapToPreviousScale(t.scale);return this._zoomToScale(i,e)}setViewpoint(e,t,i,s){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,e,t,i,s),this.end()}setViewpointImmediate(e,t=0,i=[0,0],s=this._getDefaultAnchor()){this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,s,e,t,i)}continousRotateClockwise(){const e=this.get("view.viewpoint");this.animationManager.animateContinous(e,(e=>{(0,Us.$H)(e,e,-Js)}))}continousRotateCounterclockwise(){const e=this.get("view.viewpoint");this.animationManager.animateContinous(e,(e=>{(0,Us.$H)(e,e,Js)}))}resetRotation(){this.view.rotation=0}continousPanLeft(){this._continuousPan([-Ks,0])}continousPanRight(){this._continuousPan([Ks,0])}continousPanUp(){this._continuousPan([0,Ks])}continousPanDown(){this._continuousPan([0,-Ks])}stop(){this.pan.stopMomentumNavigation(),this.animationManager.stop(),this.end(),null!==this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(e){const t=this.view.viewpoint;this.animationManager.animateContinous(t,(t=>{(0,Us.Rx)(t,t,e),this.view.constraints.constrainByGeometry(t)}))}_startTimer(e){return null!==this._endTimer||(this._endTimer=setTimeout((()=>{this._endTimer=null;const e=performance.now()-this._lastEventTimestamp;e<ir?this._endTimer=this._startTimer(e):this._set("interacting",!1)}),e)),this._endTimer}_getDefaultAnchor(){const{size:e,padding:{left:t,right:i,top:s,bottom:r}}=this.view;return tr[0]=.5*(e[0]-i+t),tr[1]=.5*(e[1]-r+s),tr}async _zoomToScale(e,t=this._getDefaultAnchor()){const{view:i}=this,{constraints:s,scale:r,viewpoint:n,size:a,padding:o}=i,h=s.canZoomInTo(e),l=s.canZoomOutTo(e);if(!(e<r&&!h||e>r&&!l))return(0,Us.gG)(er,n,e/r,0,t,a,o),s.constrainByGeometry(er),i.goTo(er,{animate:!0})}_scaleRotateTranslateViewpoint(e,t,i,s,r){const{view:n}=this,{size:a,padding:o,constraints:h,scale:l,viewpoint:c}=n,u=l*i,d=h.canZoomInTo(u),_=h.canZoomOutTo(u);return(i<1&&!d||i>1&&!_)&&(i=1),(0,Us.Rx)(c,c,r),(0,Us.gG)(e,c,i,s,t,a,o),h.constrainByGeometry(e)}};(0,Wi._)([(0,Yi.Cb)()],sr.prototype,"animationManager",void 0),(0,Wi._)([(0,Yi.Cb)({type:Boolean,readOnly:!0})],sr.prototype,"interacting",void 0),(0,Wi._)([(0,Yi.Cb)()],sr.prototype,"pan",void 0),(0,Wi._)([(0,Yi.Cb)()],sr.prototype,"pinch",void 0),(0,Wi._)([(0,Yi.Cb)()],sr.prototype,"rotate",void 0),(0,Wi._)([(0,Yi.Cb)()],sr.prototype,"view",void 0),(0,Wi._)([(0,Yi.Cb)()],sr.prototype,"zoomBox",void 0),sr=(0,Wi._)([(0,Qi.j)("esri.views.2d.navigation.MapViewNavigation")],sr);const rr=sr;var nr=i(50816),ar=i(99659),or=i(75393);const hr={shaders:{vertexShader:(0,f.w)("magnifier/magnifier.vert"),fragmentShader:(0,f.w)("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};function lr(e){return(0,y.H)(e,hr)}var cr=i(93426);class ur extends or.s{constructor(){super(),this._handles=new nr.Z,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(e){this._magnifier=e,this._handles.removeAll(),this._handles.add([(0,o.YP)((()=>e.version),(()=>{this.visible=e.visible&&(0,a.pC)(e.position)&&e.size>0,this.requestRender()}),o.nn),(0,o.YP)((()=>[e.maskUrl,e.overlayUrl]),(()=>this._reloadResources())),(0,o.YP)((()=>e.size),(()=>{this._disposeRenderResources(),this.requestRender()}))])}_createTransforms(){return{dvs:(0,l.c)()}}doRender(e){const t=e.context;if(!this._resourcesTask)return void this._reloadResources();if(e.drawPhase!==d.jx.MAP||!this._canRender())return;this._updateResources(e);const i=this._magnifier;if((0,a.Wi)(i.position))return;const s=e.pixelRatio,r=i.size*s,n=1/i.factor,o=Math.ceil(n*r);this._readbackTexture.resize(o,o);const{size:h}=e.state,l=s*h[0],c=s*h[1],u=.5*o,_=.5*o,p=(0,Ki.uZ)(s*i.position.x,u,l-u-1),m=(0,Ki.uZ)(c-s*i.position.y,_,c-_-1);t.setBlendingEnabled(!0);const f=p-u,g=m-_,b=this._readbackTexture;t.bindTexture(b,0),t.gl.copyTexImage2D(b.descriptor.target,0,b.descriptor.pixelFormat,f,g,o,o,0);const y=this.background?.color,v=y?[y.a*y.r/255,y.a*y.g/255,y.a*y.b/255,y.a]:[1,1,1,1],x=(p+i.offset.x*s)/l*2-1,T=(m-i.offset.y*s)/c*2-1,E=r/l*2,M=r/c*2,B=this._program;t.bindVAO(this._vertexArrayObject),t.bindTexture(this._overlayTexture,6),t.bindTexture(this._maskTexture,7),t.useProgram(B),B.setUniform4fv("u_background",v),B.setUniform1i("u_readbackTexture",0),B.setUniform1i("u_overlayTexture",6),B.setUniform1i("u_maskTexture",7),B.setUniform4f("u_drawPos",x,T,E,M),B.setUniform1i("u_maskEnabled",i.maskEnabled?1:0),B.setUniform1i("u_overlayEnabled",i.overlayEnabled?1:0),t.setStencilTestEnabled(!1),t.setColorMask(!0,!0,!0,!0),t.drawArrays(w.MX.TRIANGLE_STRIP,0,4),t.bindVAO()}_canRender(){return this.mask&&this.overlay&&null!=this._magnifier}_reloadResources(){this._resourcesTask&&this._resourcesTask.abort();const e=(0,a.pC)(this._magnifier)?this._magnifier.maskUrl:null,t=(0,a.pC)(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=(0,I.vr)((async i=>{const s=(0,a.Wi)(e)||(0,a.Wi)(t)?(0,cr.e)(i):null,r=(0,a.pC)(e)?(0,A["default"])(e,{responseType:"image",signal:i}).then((e=>e.data)):s.then((e=>e.mask)),n=(0,a.pC)(t)?(0,A["default"])(t,{responseType:"image",signal:i}).then((e=>e.data)):s.then((e=>e.overlay)),[o,h]=await Promise.all([r,n]);this.mask=o,this.overlay=h,this._disposeRenderResources(),this.requestRender()}))}_disposeRenderResources(){this._readbackTexture=(0,a.O3)(this._readbackTexture),this._overlayTexture=(0,a.O3)(this._overlayTexture),this._maskTexture=(0,a.O3)(this._maskTexture),this._vertexArrayObject=(0,a.O3)(this._vertexArrayObject),this._program=(0,a.O3)(this._program)}_updateResources(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const t=e.context;this._resourcePixelRatio=e.pixelRatio;const i=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=lr(t);const s=new Uint16Array([0,1,0,0,1,1,1,0]),r=hr.attributes;this._vertexArrayObject=new v.U(t,r,m.cD,{geometry:b.f.createVertex(t,w.l1.STATIC_DRAW,s)}),this.overlay.width=i,this.overlay.height=i,this._overlayTexture=new q.x(t,{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,internalFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,samplingMode:w.cw.NEAREST,flipped:!0,preMultiplyAlpha:!(0,ar.zd)(this.overlay.src)||!e.context.driverTest.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=i,this.mask.height=i,this._maskTexture=new q.x(t,{target:w.No.TEXTURE_2D,pixelFormat:w.VI.ALPHA,internalFormat:w.VI.ALPHA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,samplingMode:w.cw.NEAREST,flipped:!0},this.mask);const n=1/this._magnifier.factor;this._readbackTexture=new q.x(t,{target:w.No.TEXTURE_2D,pixelFormat:w.VI.RGBA,internalFormat:w.VI.RGBA,dataType:w.Br.UNSIGNED_BYTE,wrapMode:w.e8.CLAMP_TO_EDGE,samplingMode:w.cw.LINEAR,flipped:!1,width:Math.ceil(n*i),height:Math.ceil(n*i)})}}}}]);
//# sourceMappingURL=2281.ee395210.js.map