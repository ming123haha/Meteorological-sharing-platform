"use strict";(self["webpackChunkeco_friendly"]=self["webpackChunkeco_friendly"]||[]).push([[926],{11237:function(e,r,t){t.d(r,{Z:function(){return f}});var i,s=t(61445),n=t(86662),l=t(11536),o=t(81431),a=t(58006),u=(t(15055),t(81653),t(94315),t(77623)),d=t(4170),p=t(10224);const y={type:n.Z,readOnly:!0,json:{origins:{service:{read:{source:"sublayers",reader:h}}},read:!1}};function h(e,r,t){if(e&&Array.isArray(e))return new n.Z(e.map((e=>{const r=g(e);if(r){const i=new r;return i.read(e,t),i}t&&t.messages&&e&&t.messages.push(new o.Z("building-scene-layer:unsupported-sublayer-type","Building scene sublayer of type '"+(e.type||"unknown")+"' are not supported",{definition:e,context:t}))})))}let c=i=class extends p.Z{constructor(e){super(e),this.type="building-group",this.listMode="show",this.sublayers=null}loadAll(){return(0,l.w)(this,(e=>i.forEachSublayer(this.sublayers,(r=>{"building-group"!==r.type&&e(r)}))))}};function g(e){return"group"===e.layerType?c:d.Z}(0,s._)([(0,a.Cb)({type:["hide","show","hide-children"],json:{write:!0}})],c.prototype,"listMode",void 0),(0,s._)([(0,a.Cb)(y)],c.prototype,"sublayers",void 0),c=i=(0,s._)([(0,u.j)("esri.layers.buildingSublayers.BuildingGroupSublayer")],c),function(e){function r(e,t){e.forEach((e=>{t(e),"building-group"===e.type&&r(e.sublayers,t)}))}e.sublayersProperty=y,e.readSublayers=h,e.forEachSublayer=r}(c||(c={}));const f=c},98406:function(e,r,t){t.d(r,{T:function(){return l}});var i=t(94848),s=t(22130),n=t(8693);async function l(e,r,t,l,o,a){let u=null;if((0,n.pC)(t)){const r=`${e}/nodepages/`,s=r+Math.floor(t.rootIndex/t.nodesPerPage);try{return{type:"page",rootPage:(await(0,i["default"])(s,{query:{f:"json",token:l},responseType:"json",signal:a})).data,rootIndex:t.rootIndex,pageSize:t.nodesPerPage,lodMetric:t.lodSelectionMetricType,urlPrefix:r}}catch(y){(0,n.pC)(o)&&o.warn("#fetchIndexInfo()","Failed to load root node page. Falling back to node documents.",s,y),u=y}}if(!r)return null;const d=`${e}/nodes/`,p=d+(r&&r.split("/").pop());try{return{type:"node",rootNode:(await(0,i["default"])(p,{query:{f:"json",token:l},responseType:"json",signal:a})).data,urlPrefix:d}}catch(y){throw new s.Z("sceneservice:root-node-missing","Root node missing.",{pageError:u,nodeError:y,url:p})}}},55904:function(e,r,t){t.r(r),t.d(r,{default:function(){return ie}});var i=t(61445),s=t(39264),n=t(92698),l=t(86662),o=t(2323),a=t(93622),u=t(8693),d=t(92454),p=t(18105),y=t(58006),h=(t(15055),t(81653),t(94315),t(77623)),c=(t(11237),t(22130)),g=t(64441),f=(t(4170),t(42531)),b=t(10523),w=t(21755),_=t(96545),v=t(30374),F=t(68650),m=t(66144);const E=(e,r)=>{let t=class extends((0,m.v)((0,v.p)((0,F.IG)(_.Z.EventedMixin(e))))){constructor(e){super(e),this.sublayer=null,this.parent=null,this.view=null}initialize(){}get suspended(){return!this.canResume()}get updating(){return!this.suspended&&this.isUpdating()}get visible(){return!0===this.get("sublayer.visible")}set visible(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")}get fullOpacity(){const e=e=>null!=e?e:1;return e(this.get("sublayer.opacity"))*e(this.get("parent.fullOpacity"))}canResume(){return!this.get("parent.suspended")&&this.get("view.ready")&&this.visible||!1}isUpdating(){return!1}};return(0,i._)([(0,y.Cb)()],t.prototype,"sublayer",void 0),(0,i._)([(0,y.Cb)()],t.prototype,"parent",void 0),(0,i._)([(0,y.Cb)({readOnly:!0})],t.prototype,"suspended",null),(0,i._)([(0,y.Cb)({type:Boolean,readOnly:!0})],t.prototype,"updating",null),(0,i._)([(0,y.Cb)()],t.prototype,"view",void 0),(0,i._)([(0,y.Cb)()],t.prototype,"visible",null),(0,i._)([(0,y.Cb)()],t.prototype,"fullOpacity",null),t=(0,i._)([(0,h.j)("esri.views.3d.layers.BuildingSublayerView3D")],t),t};var C,x=t(65057),S=t(19177),I=t(85381),V=t(905),M=t(7738);!function(e){e[e.Solid=0]="Solid",e[e.WireFrame=1]="WireFrame",e[e.XRay=2]="XRay"}(C||(C={}));const A=.15,L=.5*A;function P(e){switch(e.filterMode.type){case"solid":return{mode:C.Solid};case"wire-frame":return{mode:C.WireFrame,edgeMaterial:(0,V.C8)(e.filterMode.edges,{})};case"x-ray":return{mode:C.XRay}}}function O(e,r){if((0,u.Wi)(r))return e.color[3]=0,e.edgeMaterial=null,void(e.pickable=!1);switch(r.mode){case C.Solid:return;case C.WireFrame:return e.color[3]=0,e.edgeMaterial=r.edgeMaterial,void(e.pickable=!1);case C.XRay:return e.color[0]=1,e.color[1]=1,e.color[2]=1,e.color[3]*=A,e.colorMixMode=M.a9.Replace,e.castShadows=!1,e.pickable=!1,void(e.edgeMaterial=R(e.edgeMaterial))}}function R(e){return(0,u.Wi)(e)?null:(Q.lastMaterial!==e&&(Q.cachedMaterial=q(e),Q.lastMaterial=e),Q.cachedMaterial)}function q(e){const r=(0,I.d)(e.color);return r[3]*=L,{...e,color:r}}const Q={cachedMaterial:null,lastMaterial:null};var Z=t(9078),N=t(36970),G=t(72244),j=t(16439),k=t(11095),B=t(9048),W=t(34741);t(21703),t(61343),t(76513),t(43009),t(11476);class T extends n.Z{constructor(){super(...arguments),this.sublayer=null}get updating(){return!1}get suspended(){return!1}get availableFields(){return[]}get filter(){return null}set filter(e){throw new Error("Not implemented")}queryFeatures(e,r){throw new Error("Not implemented")}queryObjectIds(e,r){throw new Error("Not implemented")}queryFeatureCount(e,r){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,r){throw new Error("Not implemented")}highlight(e){throw new Error("Not implemented")}}(0,i._)([(0,y.Cb)()],T.prototype,"sublayer",void 0),(0,i._)([(0,y.Cb)()],T.prototype,"availableFields",null),(0,i._)([(0,y.Cb)()],T.prototype,"filter",null);var U=t(23319),z=t(36298);const D=a.Z.getLogger("esri.views.3d.layers.BuildingComponentSublayerView3D");let X=class extends((0,W.l)((0,x.N)(E(T)))){constructor(){super(...arguments),this.type="building-component-sublayer-3d",this.layerView=null,this._elevationContext="scene",this._isIntegratedMesh=!1,this._supportsLabeling=!1,this.lodFactor=1,this.progressiveLoadFactor=1,this._queryEngine=null}get layerUid(){return this.sublayer.layer.uid}get sublayerUid(){return this.sublayer.uid}initialize(){this.updatingHandles.add((()=>[this.sublayer.renderer,this.definitionExpressionFields,this.filterExpressionFields]),(()=>this._updateRequiredFields())),this.updatingHandles.add((()=>this.sublayer.renderer),(e=>this._rendererChange(e)),p.nn),this.updatingHandles.add((()=>[this.parsedDefinitionExpression,this.filter,(0,u.yw)(this._filter,(({parsedWhereClause:e,parsedGeometry:r,sortedObjectIds:t})=>[e,r,t]))]),(()=>this._filterChange())),this.updatingHandles.add((()=>this.parsedFilterExpressions),(()=>this._updateSymbologyOverride()),p.nn),this.addResolvingPromise(this._updateRequiredFields())}get parsedFilterExpressions(){return"Overview"===this.sublayer.modelName?[]:this.layerView.filterExpressions.map((([e,r])=>{let t;try{t=g.WhereClause.create(e,this.sublayer.fieldsIndex)}catch(E){return D.error("Failed to parse filterExpression: "+E),null}if(!t.isStandardized)return D.error("filterExpression is using non standard function"),null;const i=[],s=t.fieldNames;return(0,B.e8)(s,this.sublayer.fields,{missingFields:i}),i.length>0?(D.error(`filterExpression references unknown fields: ${i.join(", ")}`),null):[t,r]})).filter((e=>null!=e))}get filter(){return(0,u.pC)(this._filter)?this._filter.viewFilter:null}set filter(e){!(0,u.Wi)(e)&&N.z.checkSupport(e)?(0,u.pC)(this._filter)?this._filter.viewFilter=e:this._filter=new N.z({viewFilter:e,layerFieldsIndex:this.sublayer.fieldsIndex,loadAsyncModule:e=>this._loadAsyncModule(e),applyFilters:()=>this._applyFilters(!0),addSqlFilter:(e,r)=>this.addSqlFilter(e,r,this.logError)}):this._filter=null}_updateSymbologyOverride(){const e=this.parsedFilterExpressions;e.length>0?this._setSymbologyOverride(((r,t)=>{for(const[i,s]of e)try{if(i.testFeature(r))return O(t,s)}catch(L){this.logError(L)}return O(t,null)}),this.filterExpressionFields):this._setSymbologyOverride(null,null)}get filterExpressionFields(){return(0,b.Q0)(this.sublayer.fieldsIndex,this.parsedFilterExpressions.reduce(((e,[r])=>e.concat(r.fieldNames)),[]))}get availableFields(){const e=this.sublayer,r=e.fieldsIndex;let t=this.requiredFields;if(e.outFields||e.layer.outFields){const i=[...e.outFields||[],...e.layer.outFields||[]];t=[...(0,b.Lk)(r,i),...t]}return(0,b.Q0)(r,t)}_createLayerGraphic(e){const r=new s.Z(null,null,e);return r.layer=this.sublayer.layer,r.sourceLayer=this.sublayer,r}canResume(){return super.canResume()&&(!this._controller||this._controller.rootNodeVisible)}async fetchPopupFeatures(e,r){const t=this._validateFetchPopupFeatures(r);if(t)throw t;if((0,u.Wi)(r)||!r.clientGraphics||0===r.clientGraphics.length)return[];const i=[],s=[],n=(0,u.pC)(this.sublayer.associatedLayer)?await this.sublayer.associatedLayer.load():this.sublayer,l=(0,b.Lk)(this.sublayer.fieldsIndex,await(0,U.e)(n,(0,U.V)(this.sublayer,r))),o=new Set;for(const a of r.clientGraphics)(0,b.Gm)(l,a,o)?s.push(a):i.push(a);return 0===s.length?i:((0,u.pC)(this.sublayer.associatedLayer)&&await this.sublayer.associatedLayer.load().catch((()=>D.warn("Failed to load associated feature layer. Displaying popup attributes from cached attributes."))),this.whenGraphicAttributes(s,Array.from(o)).catch((()=>s)).then((e=>i.concat(e))))}async _updateRequiredFields(){const e=(0,b.Q0)(this.sublayer.fieldsIndex,[...this.sublayer.renderer?await this.sublayer.renderer.getRequiredFields(this.sublayer.fieldsIndex):[],...this.definitionExpressionFields||[],...this.filterExpressionFields||[]]);this._set("requiredFields",e)}_validateFetchPopupFeatures(e){const{sublayer:r}=this,{popupEnabled:t}=r;return t?(0,U.V)(r,e)?void 0:new c.Z("buildingscenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{sublayer:r}):new c.Z("buildingscenelayerview3d:fetchPopupFeatures","Popups are disabled",{sublayer:r})}getFilters(){const e=super.getFilters();return this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),(0,u.pC)(this._filter)&&this._filter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e}createQuery(){const e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return(0,u.pC)(this.filter)?this.filter.createQuery(e):new w.Z(e)}queryExtent(e,r){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),r?.signal)}queryFeatureCount(e,r){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),r?.signal)}queryFeatures(e,r){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),r?.signal).then((e=>{if(!e?.features)return e;const r=this.sublayer,t=r.layer;for(const i of e.features)i.layer=t,i.sourceLayer=r;return e}))}queryObjectIds(e,r){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),r?.signal)}_ensureQueryEngine(){return(0,u.Wi)(this._queryEngine)&&(this._queryEngine=this._createQueryEngine()),this._queryEngine}_createQueryEngine(){const e=(0,Z.gz)(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new G.u({layerView:this,priority:z.T8.FEATURE_QUERY_ENGINE,spatialIndex:new k.I({featureAdapter:new j.u({objectIdField:this.sublayer.objectIdField,attributeStorageInfo:this.sublayer.attributeStorageInfo,getFeatureExtent:e}),toArray:()=>{const e=new Array;return this._forAllFeatures(((r,t,i)=>(e.push({id:r,index:t,meta:i}),S.K.CONTINUE)),null,S.u.ALL_IN_CLIPPING_AREA),e},forAllFeatures:(e,r)=>this._forAllFeatures(((r,t,i)=>e({id:r,index:t,meta:i})),r,S.u.ALL_IN_CLIPPING_AREA),getFeatureExtent:e,sourceSpatialReference:(0,B.tp)(this.sublayer),viewSpatialReference:this.view.spatialReference})})}_ensureQuery(e){return this._addDefinitionExpressionToQuery((0,u.Wi)(e)?this.createQuery():w.Z.from(e))}};(0,i._)([(0,y.Cb)({aliasOf:"sublayer"})],X.prototype,"i3slayer",void 0),(0,i._)([(0,y.Cb)()],X.prototype,"layerView",void 0),(0,i._)([(0,y.Cb)()],X.prototype,"suspended",void 0),(0,i._)([(0,y.Cb)({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],X.prototype,"lodFactor",void 0),(0,i._)([(0,y.Cb)({readOnly:!0})],X.prototype,"parsedFilterExpressions",null),(0,i._)([(0,y.Cb)({type:f.Z})],X.prototype,"filter",null),(0,i._)([(0,y.Cb)()],X.prototype,"_filter",void 0),(0,i._)([(0,y.Cb)({type:[String],readOnly:!0})],X.prototype,"filterExpressionFields",null),(0,i._)([(0,y.Cb)({type:[String],readOnly:!0})],X.prototype,"requiredFields",void 0),(0,i._)([(0,y.Cb)({type:[String],readOnly:!0})],X.prototype,"availableFields",null),X=(0,i._)([(0,h.j)("esri.views.3d.layers.BuildingComponentSublayerView3D")],X);const $=X;var H=t(19134),Y=t(4343),J=t(31698);class K extends J.Z{constructor(){super(...arguments),this.layer=null,this.sublayerViews=null}highlight(e){throw new Error("Not implemented")}}(0,i._)([(0,y.Cb)()],K.prototype,"layer",void 0),(0,i._)([(0,y.Cb)()],K.prototype,"sublayerViews",void 0);const ee=a.Z.getLogger("esri.views.3d.layers.BuildingSceneLayerView3D"),re=E(n.Z);let te=class extends((0,H.A)(K)){constructor(){super(...arguments),this.type="building-scene-3d",this.sublayerViews=new l.Z,this._abortController=new AbortController,this._loadingComponents=0}get filterExpression(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((r=>r.id===e)):null,t=null!=r?r.filterBlocks.find((e=>"solid"===e.filterMode.type)):null;return t?t.filterExpression:null}get filterExpressions(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((r=>r.id===e)):null;return r&&r.filterBlocks?r.filterBlocks.toArray().map((e=>[e.filterExpression,P(e)])):[]}get updatingProgressValue(){const e=this.sublayerViews,r=this._loadingComponents+(e?e.length:0);return e.reduce(((e,r)=>e+r.updatingProgress),0)/r}isUpdating(){return this._loadingComponents>0||this.sublayerViews&&this.sublayerViews.some((e=>e.updating))}initialize(){(0,B.Jf)(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode),this._initializeSubLayerViews(this.layer.sublayers,this)}destroy(){this.sublayerViews&&(this.sublayerViews.forEach((e=>e.destroy())),this.sublayerViews=null),this._abortController.abort(),this._abortController=null}_initializeSubLayerViews(e,r){const t=this,i=this.view;e.forEach((e=>{if(!e.isEmpty)if("building-group"===e.type){const t=new re({sublayer:e,view:i,parent:r});this._initializeSubLayerViews(e.sublayers,t)}else"mesh"===e.geometryType&&(this._loadingComponents++,e.load({signal:this._abortController.signal}).then((()=>{const s=new $({sublayer:e,layerView:t,view:i,parent:r});this.sublayerViews.push(s),this.handles.add([(0,p.YP)((()=>s.updating),(()=>this.notifyChange("updating")),p.tX),(0,p.YP)((()=>s.updatingProgress),(()=>this.notifyChange("updatingProgressValue")),p.tX)])})).catch((r=>{(0,d.D_)(r)||ee.error(`Error while creating view for sublayer ${e.id}\nLayer: ${this.layer.url}\n`,r)})).then((()=>{this._loadingComponents--,this.notifyChange("updating"),this.notifyChange("updatingProgressValue")})))}))}getGraphicFromIntersectorTarget(e){for(const r of this.sublayerViews.items)if(r.sublayer.uid===e.sublayerUid)return r.getGraphicFromIntersectorTarget(e);return null}async fetchPopupFeatures(e,r){if((0,u.Wi)(r)||!r.clientGraphics||0===r.clientGraphics.length)return;const t=this._findComponent(r.clientGraphics[0].sourceLayer);return(0,u.Wi)(t)?void 0:t.fetchPopupFeatures(e,r)}whenGraphicBounds(e){const r=this._findComponent(e.sourceLayer);return(0,u.Wi)(r)?Promise.reject():r.whenGraphicBounds(e)}getAABBFromIntersectorTarget(e){for(const r of this.sublayerViews.items)if(r.sublayer.uid===e.sublayerUid)return r.getAABBFromIntersectorTarget(e);return null}_findComponent(e){return this.sublayerViews.find((r=>e===r.sublayer))}highlight(e){e instanceof s.Z?e=[e]:e instanceof l.Z&&(e=e.toArray());const r=[];if(Array.isArray(e)&&e.length>0&&e[0]instanceof s.Z){const t=e,i=new Map;for(const e of t){let r=i.get(e.sourceLayer);null==r&&(r=[],i.set(e.sourceLayer,r)),r.push(e)}this.sublayerViews.forEach((e=>{const t=i.get(e.sublayer);t&&r.push(e.highlight(t))}))}return(0,o.AL)(r)}getUsedMemory(){return this.sublayerViews.reduce(((e,r)=>e+r.getUsedMemory()),0)}getUnloadedMemory(){return this.sublayerViews.reduce(((e,r)=>e+r.getUnloadedMemory()),0)}ignoresMemoryFactor(){return!1}};(0,i._)([(0,y.Cb)()],te.prototype,"sublayerViews",void 0),(0,i._)([(0,y.Cb)({readOnly:!0})],te.prototype,"filterExpression",null),(0,i._)([(0,y.Cb)({readOnly:!0})],te.prototype,"filterExpressions",null),(0,i._)([(0,y.Cb)(Y.q)],te.prototype,"updatingProgress",void 0),(0,i._)([(0,y.Cb)({readOnly:!0,dependsOn:[]})],te.prototype,"updatingProgressValue",null),te=(0,i._)([(0,h.j)("esri.views.3d.layers.BuildingSceneLayerView3D")],te);const ie=te}}]);
//# sourceMappingURL=926.e99c2d33.js.map