{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.25/esri/copyright.txt for details.\n*/\nimport t from \"../../../../../core/Error.js\";\nimport e from \"../../../../../core/Logger.js\";\nimport { isNone as i } from \"../../../../../core/maybe.js\";\nimport { create as s } from \"../../../../../geometry/support/aaBoundingRect.js\";\nimport { getBoundsXY as r } from \"../../../../../geometry/support/boundsUtils.js\";\nimport { getSpatialQueryOperator as o } from \"../../../../../layers/graphics/data/spatialQuerySupport.js\";\nimport { getTimeOperator as h } from \"../../../../../layers/graphics/data/timeSupport.js\";\nimport { normalizeQueryLike as a } from \"../../../../../layers/graphics/data/utils.js\";\nimport l from \"../../../../../rest/support/Query.js\";\nimport { featureAdapter as n } from \"../FeatureStore2D.js\";\nimport { createWhereClause as d } from \"./whereUtils.js\";\nconst m = 1,\n      _ = 2;\n\nclass p {\n  constructor(t) {\n    this._geometryBounds = s(), this._idToVisibility = new Map(), this._serviceInfo = t;\n  }\n\n  get hash() {\n    return this._hash;\n  }\n\n  check(t) {\n    return this._applyFilter(t);\n  }\n\n  clear() {\n    const t = this._resetAllHiddenIds();\n\n    return this.update(), {\n      show: t,\n      hide: []\n    };\n  }\n\n  invalidate() {\n    this._idToVisibility.forEach((t, e) => {\n      this._idToVisibility.set(e, 0);\n    });\n  }\n\n  setKnownIds(t) {\n    for (const e of t) this._idToVisibility.set(e, m);\n  }\n\n  setTrue(t) {\n    const e = [],\n          i = [],\n          s = new Set(t);\n    return this._idToVisibility.forEach((t, r) => {\n      const o = !!(this._idToVisibility.get(r) & m),\n            h = s.has(r);\n      !o && h ? e.push(r) : o && !h && i.push(r), this._idToVisibility.set(r, h ? m | _ : 0);\n    }), {\n      show: e,\n      hide: i\n    };\n  }\n\n  createQuery() {\n    const {\n      geometry: t,\n      spatialRel: e,\n      where: i,\n      timeExtent: s,\n      objectIds: r\n    } = this;\n    return l.fromJSON({\n      geometry: t,\n      spatialRel: e,\n      where: i,\n      timeExtent: s,\n      objectIds: r\n    });\n  }\n\n  async update(t, e) {\n    this._hash = JSON.stringify(t);\n    const i = await a(t, null, e);\n    await Promise.all([this._setGeometryFilter(i), this._setIdFilter(i), this._setAttributeFilter(i), this._setTimeFilter(i)]);\n  }\n\n  async _setAttributeFilter(t) {\n    if (!t || !t.where) return this._clause = null, void (this.where = null);\n    this._clause = await d(t.where, this._serviceInfo.fieldsIndex), this.where = t.where;\n  }\n\n  _setIdFilter(t) {\n    this._idsToShow = t && t.objectIds && new Set(t.objectIds), this._idsToHide = t && t.hiddenIds && new Set(t.hiddenIds), this.objectIds = t && t.objectIds;\n  }\n\n  async _setGeometryFilter(t) {\n    if (!t || !t.geometry) return this._spatialQueryOperator = null, this.geometry = null, void (this.spatialRel = null);\n    const e = t.geometry,\n          i = t.spatialRel || \"esriSpatialRelIntersects\",\n          s = await o(i, e, this._serviceInfo.geometryType, this._serviceInfo.hasZ, this._serviceInfo.hasM);\n    r(this._geometryBounds, e), this._spatialQueryOperator = s, this.geometry = e, this.spatialRel = i;\n  }\n\n  _setTimeFilter(i) {\n    if (this.timeExtent = this._timeOperator = null, i && i.timeExtent) if (this._serviceInfo.timeInfo) this.timeExtent = i.timeExtent, this._timeOperator = h(this._serviceInfo.timeInfo, i.timeExtent, n);else {\n      const s = new t(\"feature-layer-view:time-filter-not-available\", \"Unable to apply time filter, as layer doesn't have time metadata.\", i.timeExtent);\n      e.getLogger(\"esri.views.2d.layers.features.controllers.FeatureFilter\").error(s);\n    }\n  }\n\n  _applyFilter(t) {\n    return this._filterByGeometry(t) && this._filterById(t) && this._filterByTime(t) && this._filterByExpression(t);\n  }\n\n  _filterByExpression(t) {\n    return !this.where || this._clause(t);\n  }\n\n  _filterById(t) {\n    return (!this._idsToHide || !this._idsToHide.size || !this._idsToHide.has(t.getObjectId())) && (!this._idsToShow || !this._idsToShow.size || this._idsToShow.has(t.getObjectId()));\n  }\n\n  _filterByGeometry(t) {\n    if (!this.geometry) return !0;\n    const e = t.readHydratedGeometry();\n    return !!e && this._spatialQueryOperator(e);\n  }\n\n  _filterByTime(t) {\n    return !!i(this._timeOperator) || this._timeOperator(t);\n  }\n\n  _resetAllHiddenIds() {\n    const t = [];\n    return this._idToVisibility.forEach((e, i) => {\n      e & m || (this._idToVisibility.set(i, m), t.push(i));\n    }), t;\n  }\n\n}\n\nexport { p as default };","map":{"version":3,"names":["t","e","isNone","i","create","s","getBoundsXY","r","getSpatialQueryOperator","o","getTimeOperator","h","normalizeQueryLike","a","l","featureAdapter","n","createWhereClause","d","m","_","p","constructor","_geometryBounds","_idToVisibility","Map","_serviceInfo","hash","_hash","check","_applyFilter","clear","_resetAllHiddenIds","update","show","hide","invalidate","forEach","set","setKnownIds","setTrue","Set","get","has","push","createQuery","geometry","spatialRel","where","timeExtent","objectIds","fromJSON","JSON","stringify","Promise","all","_setGeometryFilter","_setIdFilter","_setAttributeFilter","_setTimeFilter","_clause","fieldsIndex","_idsToShow","_idsToHide","hiddenIds","_spatialQueryOperator","geometryType","hasZ","hasM","_timeOperator","timeInfo","getLogger","error","_filterByGeometry","_filterById","_filterByTime","_filterByExpression","size","getObjectId","readHydratedGeometry","default"],"sources":["E:/各个学科/论文/毕业论文/Atmosphere/eco-friendly/node_modules/@arcgis/core/views/2d/layers/features/support/FeatureFilter.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.25/esri/copyright.txt for details.\n*/\nimport t from\"../../../../../core/Error.js\";import e from\"../../../../../core/Logger.js\";import{isNone as i}from\"../../../../../core/maybe.js\";import{create as s}from\"../../../../../geometry/support/aaBoundingRect.js\";import{getBoundsXY as r}from\"../../../../../geometry/support/boundsUtils.js\";import{getSpatialQueryOperator as o}from\"../../../../../layers/graphics/data/spatialQuerySupport.js\";import{getTimeOperator as h}from\"../../../../../layers/graphics/data/timeSupport.js\";import{normalizeQueryLike as a}from\"../../../../../layers/graphics/data/utils.js\";import l from\"../../../../../rest/support/Query.js\";import{featureAdapter as n}from\"../FeatureStore2D.js\";import{createWhereClause as d}from\"./whereUtils.js\";const m=1,_=2;class p{constructor(t){this._geometryBounds=s(),this._idToVisibility=new Map,this._serviceInfo=t}get hash(){return this._hash}check(t){return this._applyFilter(t)}clear(){const t=this._resetAllHiddenIds();return this.update(),{show:t,hide:[]}}invalidate(){this._idToVisibility.forEach(((t,e)=>{this._idToVisibility.set(e,0)}))}setKnownIds(t){for(const e of t)this._idToVisibility.set(e,m)}setTrue(t){const e=[],i=[],s=new Set(t);return this._idToVisibility.forEach(((t,r)=>{const o=!!(this._idToVisibility.get(r)&m),h=s.has(r);!o&&h?e.push(r):o&&!h&&i.push(r),this._idToVisibility.set(r,h?m|_:0)})),{show:e,hide:i}}createQuery(){const{geometry:t,spatialRel:e,where:i,timeExtent:s,objectIds:r}=this;return l.fromJSON({geometry:t,spatialRel:e,where:i,timeExtent:s,objectIds:r})}async update(t,e){this._hash=JSON.stringify(t);const i=await a(t,null,e);await Promise.all([this._setGeometryFilter(i),this._setIdFilter(i),this._setAttributeFilter(i),this._setTimeFilter(i)])}async _setAttributeFilter(t){if(!t||!t.where)return this._clause=null,void(this.where=null);this._clause=await d(t.where,this._serviceInfo.fieldsIndex),this.where=t.where}_setIdFilter(t){this._idsToShow=t&&t.objectIds&&new Set(t.objectIds),this._idsToHide=t&&t.hiddenIds&&new Set(t.hiddenIds),this.objectIds=t&&t.objectIds}async _setGeometryFilter(t){if(!t||!t.geometry)return this._spatialQueryOperator=null,this.geometry=null,void(this.spatialRel=null);const e=t.geometry,i=t.spatialRel||\"esriSpatialRelIntersects\",s=await o(i,e,this._serviceInfo.geometryType,this._serviceInfo.hasZ,this._serviceInfo.hasM);r(this._geometryBounds,e),this._spatialQueryOperator=s,this.geometry=e,this.spatialRel=i}_setTimeFilter(i){if(this.timeExtent=this._timeOperator=null,i&&i.timeExtent)if(this._serviceInfo.timeInfo)this.timeExtent=i.timeExtent,this._timeOperator=h(this._serviceInfo.timeInfo,i.timeExtent,n);else{const s=new t(\"feature-layer-view:time-filter-not-available\",\"Unable to apply time filter, as layer doesn't have time metadata.\",i.timeExtent);e.getLogger(\"esri.views.2d.layers.features.controllers.FeatureFilter\").error(s)}}_applyFilter(t){return this._filterByGeometry(t)&&this._filterById(t)&&this._filterByTime(t)&&this._filterByExpression(t)}_filterByExpression(t){return!this.where||this._clause(t)}_filterById(t){return(!this._idsToHide||!this._idsToHide.size||!this._idsToHide.has(t.getObjectId()))&&(!this._idsToShow||!this._idsToShow.size||this._idsToShow.has(t.getObjectId()))}_filterByGeometry(t){if(!this.geometry)return!0;const e=t.readHydratedGeometry();return!!e&&this._spatialQueryOperator(e)}_filterByTime(t){return!!i(this._timeOperator)||this._timeOperator(t)}_resetAllHiddenIds(){const t=[];return this._idToVisibility.forEach(((e,i)=>{e&m||(this._idToVisibility.set(i,m),t.push(i))})),t}}export{p as default};\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}