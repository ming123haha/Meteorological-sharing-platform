{"ast":null,"code":"import \"core-js/modules/es.error.cause.js\";\n\n/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.25/esri/copyright.txt for details.\n*/\nimport { id as t } from \"../../kernel.js\";\nimport r from \"../../request.js\";\nimport { isNone as e, isSome as a } from \"../../core/maybe.js\";\nimport { throwIfAbortError as i } from \"../../core/promiseUtils.js\";\nimport s from \"../FeatureLayer.js\";\nimport n from \"../../portal/Portal.js\";\nimport o from \"../../portal/PortalItem.js\";\n\nclass l {\n  constructor(t, r, e, a) {\n    this._parsedUrl = t, this._portalItem = r, this._apiKey = e, this.signal = a, this._rootDocument = null;\n    const i = this._parsedUrl?.path.match(/^(.*)\\/SceneServer\\/layers\\/([\\d]*)\\/?$/i);\n    i && (this._urlParts = {\n      root: i[1],\n      layerId: parseInt(i[2], 10)\n    });\n  }\n\n  async fetch() {\n    if (!this._urlParts) return null;\n    const t = this._portalItem ?? (await this._portalItemFromServiceItemId());\n    if (e(t)) return this._loadFromUrl();\n    const r = await this._findAndLoadRelatedPortalItem(t);\n    return e(r) ? null : this._loadFeatureLayerFromPortalItem(r);\n  }\n\n  async fetchPortalItem() {\n    if (!this._urlParts) return null;\n    const t = this._portalItem ?? (await this._portalItemFromServiceItemId());\n    return e(t) ? null : this._findAndLoadRelatedPortalItem(t);\n  }\n\n  async _fetchRootDocument() {\n    if (a(this._rootDocument)) return this._rootDocument;\n    if (e(this._urlParts)) return this._rootDocument = {}, {};\n    const t = {\n      query: {\n        f: \"json\",\n        token: this._apiKey\n      },\n      responseType: \"json\",\n      signal: this.signal\n    },\n          i = `${this._urlParts.root}/SceneServer`;\n\n    try {\n      const e = await r(i, t);\n      this._rootDocument = e.data;\n    } catch {\n      this._rootDocument = {};\n    }\n\n    return this._rootDocument;\n  }\n\n  async _fetchServiceOwningPortalUrl() {\n    const e = this._parsedUrl?.path,\n          a = e ? t?.findServerInfo(e) : null;\n    if (a?.owningSystemUrl) return a.owningSystemUrl;\n    const s = e ? e.replace(/(.*\\/rest)\\/.*/i, \"$1\") + \"/info\" : null;\n\n    try {\n      const t = (await r(s, {\n        query: {\n          f: \"json\"\n        },\n        responseType: \"json\",\n        signal: this.signal\n      })).data.owningSystemUrl;\n      if (t) return t;\n    } catch (n) {\n      i(n);\n    }\n\n    return null;\n  }\n\n  async _findAndLoadRelatedPortalItem(t) {\n    try {\n      return (await t.fetchRelatedItems({\n        relationshipType: \"Service2Service\",\n        direction: \"reverse\"\n      }, {\n        signal: this.signal\n      })).find(t => \"Feature Service\" === t.type) || null;\n    } catch (r) {\n      return i(r), null;\n    }\n  }\n\n  async _loadFeatureLayerFromPortalItem(t) {\n    await t.load({\n      signal: this.signal\n    });\n    const r = await this._findMatchingAssociatedSublayerUrl(t.url ?? \"\");\n    return new s({\n      url: r,\n      portalItem: t\n    }).load({\n      signal: this.signal\n    });\n  }\n\n  async _loadFromUrl() {\n    const t = await this._findMatchingAssociatedSublayerUrl(`${this._urlParts?.root}/FeatureServer`);\n    return new s({\n      url: t\n    }).load({\n      signal: this.signal\n    });\n  }\n\n  async _findMatchingAssociatedSublayerUrl(t) {\n    const e = t.replace(/^(.*FeatureServer)(\\/[\\d]*\\/?)?$/i, \"$1\"),\n          a = {\n      query: {\n        f: \"json\"\n      },\n      responseType: \"json\",\n      authMode: \"no-prompt\",\n      signal: this.signal\n    },\n          i = this._urlParts?.layerId,\n          s = this._fetchRootDocument(),\n          n = r(e, a),\n          [o, l] = await Promise.all([n, s]),\n          c = l && l.layers,\n          u = o.data && o.data.layers;\n\n    if (!Array.isArray(u)) throw new Error(\"expected layers array\");\n    if (Array.isArray(c)) for (let r = 0; r < Math.min(c.length, u.length); r++) {\n      if (c[r].id === i) return `${e}/${u[r].id}`;\n    } else if (null != i && i < u.length) return `${e}/${u[i].id}`;\n    throw new Error(\"could not find matching associated sublayer\");\n  }\n\n  async _portalItemFromServiceItemId() {\n    const t = (await this._fetchRootDocument()).serviceItemId;\n    if (!t) return null;\n    const r = new o({\n      id: t,\n      apiKey: this._apiKey\n    }),\n          e = await this._fetchServiceOwningPortalUrl();\n    a(e) && (r.portal = new n({\n      url: e\n    }));\n\n    try {\n      return r.load({\n        signal: this.signal\n      });\n    } catch (s) {\n      return i(s), null;\n    }\n  }\n\n}\n\nexport { l as FetchAssociatedFeatureLayer };","map":{"version":3,"names":["id","t","r","isNone","e","isSome","a","throwIfAbortError","i","s","n","o","l","constructor","_parsedUrl","_portalItem","_apiKey","signal","_rootDocument","path","match","_urlParts","root","layerId","parseInt","fetch","_portalItemFromServiceItemId","_loadFromUrl","_findAndLoadRelatedPortalItem","_loadFeatureLayerFromPortalItem","fetchPortalItem","_fetchRootDocument","query","f","token","responseType","data","_fetchServiceOwningPortalUrl","findServerInfo","owningSystemUrl","replace","fetchRelatedItems","relationshipType","direction","find","type","load","_findMatchingAssociatedSublayerUrl","url","portalItem","authMode","Promise","all","c","layers","u","Array","isArray","Error","Math","min","length","serviceItemId","apiKey","portal","FetchAssociatedFeatureLayer"],"sources":["E:/各个学科/论文/毕业论文/Atmosphere/eco-friendly/node_modules/@arcgis/core/layers/support/FetchAssociatedFeatureLayer.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.25/esri/copyright.txt for details.\n*/\nimport{id as t}from\"../../kernel.js\";import r from\"../../request.js\";import{isNone as e,isSome as a}from\"../../core/maybe.js\";import{throwIfAbortError as i}from\"../../core/promiseUtils.js\";import s from\"../FeatureLayer.js\";import n from\"../../portal/Portal.js\";import o from\"../../portal/PortalItem.js\";class l{constructor(t,r,e,a){this._parsedUrl=t,this._portalItem=r,this._apiKey=e,this.signal=a,this._rootDocument=null;const i=this._parsedUrl?.path.match(/^(.*)\\/SceneServer\\/layers\\/([\\d]*)\\/?$/i);i&&(this._urlParts={root:i[1],layerId:parseInt(i[2],10)})}async fetch(){if(!this._urlParts)return null;const t=this._portalItem??await this._portalItemFromServiceItemId();if(e(t))return this._loadFromUrl();const r=await this._findAndLoadRelatedPortalItem(t);return e(r)?null:this._loadFeatureLayerFromPortalItem(r)}async fetchPortalItem(){if(!this._urlParts)return null;const t=this._portalItem??await this._portalItemFromServiceItemId();return e(t)?null:this._findAndLoadRelatedPortalItem(t)}async _fetchRootDocument(){if(a(this._rootDocument))return this._rootDocument;if(e(this._urlParts))return this._rootDocument={},{};const t={query:{f:\"json\",token:this._apiKey},responseType:\"json\",signal:this.signal},i=`${this._urlParts.root}/SceneServer`;try{const e=await r(i,t);this._rootDocument=e.data}catch{this._rootDocument={}}return this._rootDocument}async _fetchServiceOwningPortalUrl(){const e=this._parsedUrl?.path,a=e?t?.findServerInfo(e):null;if(a?.owningSystemUrl)return a.owningSystemUrl;const s=e?e.replace(/(.*\\/rest)\\/.*/i,\"$1\")+\"/info\":null;try{const t=(await r(s,{query:{f:\"json\"},responseType:\"json\",signal:this.signal})).data.owningSystemUrl;if(t)return t}catch(n){i(n)}return null}async _findAndLoadRelatedPortalItem(t){try{return(await t.fetchRelatedItems({relationshipType:\"Service2Service\",direction:\"reverse\"},{signal:this.signal})).find((t=>\"Feature Service\"===t.type))||null}catch(r){return i(r),null}}async _loadFeatureLayerFromPortalItem(t){await t.load({signal:this.signal});const r=await this._findMatchingAssociatedSublayerUrl(t.url??\"\");return new s({url:r,portalItem:t}).load({signal:this.signal})}async _loadFromUrl(){const t=await this._findMatchingAssociatedSublayerUrl(`${this._urlParts?.root}/FeatureServer`);return new s({url:t}).load({signal:this.signal})}async _findMatchingAssociatedSublayerUrl(t){const e=t.replace(/^(.*FeatureServer)(\\/[\\d]*\\/?)?$/i,\"$1\"),a={query:{f:\"json\"},responseType:\"json\",authMode:\"no-prompt\",signal:this.signal},i=this._urlParts?.layerId,s=this._fetchRootDocument(),n=r(e,a),[o,l]=await Promise.all([n,s]),c=l&&l.layers,u=o.data&&o.data.layers;if(!Array.isArray(u))throw new Error(\"expected layers array\");if(Array.isArray(c))for(let r=0;r<Math.min(c.length,u.length);r++){if(c[r].id===i)return`${e}/${u[r].id}`}else if(null!=i&&i<u.length)return`${e}/${u[i].id}`;throw new Error(\"could not find matching associated sublayer\")}async _portalItemFromServiceItemId(){const t=(await this._fetchRootDocument()).serviceItemId;if(!t)return null;const r=new o({id:t,apiKey:this._apiKey}),e=await this._fetchServiceOwningPortalUrl();a(e)&&(r.portal=new n({url:e}));try{return r.load({signal:this.signal})}catch(s){return i(s),null}}}export{l as FetchAssociatedFeatureLayer};\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}