{"ast":null,"code":"import \"core-js/modules/es.array.includes.js\";\n\n/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.25/esri/copyright.txt for details.\n*/\nimport { _ as t } from \"../../chunks/tslib.es6.js\";\nimport { id as e } from \"../../kernel.js\";\nimport r from \"../../request.js\";\nimport { result as s } from \"../../core/asyncUtils.js\";\nimport o from \"../../core/Error.js\";\nimport i from \"../../core/Logger.js\";\nimport { destroyMaybe as a, isNone as l, isSome as p } from \"../../core/maybe.js\";\nimport { throwIfAborted as n, isAbortError as m, throwIfAbortError as c } from \"../../core/promiseUtils.js\";\nimport { normalize as u, hasSamePortal as d } from \"../../core/urlUtils.js\";\nimport { property as h } from \"../../core/accessorSupport/decorators/property.js\";\nimport \"../../core/arrayUtils.js\";\nimport \"../../core/accessorSupport/ensureType.js\";\nimport { reader as f } from \"../../core/accessorSupport/decorators/reader.js\";\nimport { subclass as y } from \"../../core/accessorSupport/decorators/subclass.js\";\nimport { writer as g } from \"../../core/accessorSupport/decorators/writer.js\";\nimport I from \"../../portal/Portal.js\";\nimport j from \"../../portal/PortalItem.js\";\nimport w from \"../../portal/PortalUser.js\";\n\nconst v = v => {\n  let U = class extends v {\n    constructor() {\n      super(...arguments), this.resourceReferences = {\n        portalItem: null,\n        paths: []\n      }, this.userHasEditingPrivileges = !0;\n    }\n\n    destroy() {\n      this.portalItem = a(this.portalItem);\n    }\n\n    set portalItem(t) {\n      t !== this._get(\"portalItem\") && (this.removeOrigin(\"portal-item\"), this._set(\"portalItem\", t));\n    }\n\n    readPortalItem(t, e, r) {\n      if (e.itemId) return new j({\n        id: e.itemId,\n        portal: r && r.portal\n      });\n    }\n\n    writePortalItem(t, e) {\n      t && t.id && (e.itemId = t.id);\n    }\n\n    async loadFromPortal(t, e) {\n      if (this.portalItem && this.portalItem.id) try {\n        const r = await import(\"../../portal/support/layersLoader.js\");\n        return n(e), await r.load({\n          instance: this,\n          supportedTypes: t.supportedTypes,\n          validateItem: t.validateItem,\n          supportsData: t.supportsData,\n          layerModuleTypeMap: t.layerModuleTypeMap\n        }, e);\n      } catch (r) {\n        throw m(r) || i.getLogger(this.declaredClass).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})\\n  ${r}`), r;\n      }\n    }\n\n    async finishLoadEditablePortalLayer(t) {\n      this._set(\"userHasEditingPrivileges\", await this._fetchUserHasEditingPrivileges(t).catch(t => (c(t), !0)));\n    }\n\n    async _fetchUserHasEditingPrivileges(t) {\n      const r = this.url ? e?.findCredential(this.url) : null;\n      if (!r) return !0;\n      const s = P.credential === r ? P.user : await this._fetchEditingUser(t);\n      return P.credential = r, P.user = s, l(s) || null == s.privileges || s.privileges.includes(\"features:user:edit\");\n    }\n\n    async _fetchEditingUser(t) {\n      const o = this.portalItem?.portal?.user;\n      if (o) return o;\n      const i = e.findServerInfo(this.url ?? \"\");\n      if (!i?.owningSystemUrl) return null;\n      const a = `${i.owningSystemUrl}/sharing/rest`,\n            l = I.getDefault();\n      if (l && l.loaded && u(l.restUrl) === u(a)) return l.user;\n      const n = `${a}/community/self`,\n            m = p(t) ? t.signal : null,\n            c = await s(r(n, {\n        authMode: \"no-prompt\",\n        query: {\n          f: \"json\"\n        },\n        signal: m\n      }));\n      return c.ok ? w.fromJSON(c.value.data) : null;\n    }\n\n    read(t, e) {\n      e && (e.layer = this), super.read(t, e);\n    }\n\n    write(t, e) {\n      const r = e && e.portal,\n            s = this.portalItem && this.portalItem.id && (this.portalItem.portal || I.getDefault());\n      return r && s && !d(s.restUrl, r.restUrl) ? (e.messages && e.messages.push(new o(\"layer:cross-portal\", `The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`, {\n        layer: this\n      })), null) : super.write(t, { ...e,\n        layer: this\n      });\n    }\n\n  };\n  return t([h({\n    type: j\n  })], U.prototype, \"portalItem\", null), t([f(\"web-document\", \"portalItem\", [\"itemId\"])], U.prototype, \"readPortalItem\", null), t([g(\"web-document\", \"portalItem\", {\n    itemId: {\n      type: String\n    }\n  })], U.prototype, \"writePortalItem\", null), t([h({\n    clonable: !1\n  })], U.prototype, \"resourceReferences\", void 0), t([h({\n    readOnly: !0\n  })], U.prototype, \"userHasEditingPrivileges\", void 0), U = t([y(\"esri.layers.mixins.PortalLayer\")], U), U;\n},\n      P = {\n  credential: null,\n  user: null\n};\n\nexport { v as PortalLayer };","map":{"version":3,"names":["_","t","id","e","r","result","s","o","i","destroyMaybe","a","isNone","l","isSome","p","throwIfAborted","n","isAbortError","m","throwIfAbortError","c","normalize","u","hasSamePortal","d","property","h","reader","f","subclass","y","writer","g","I","j","w","v","U","constructor","arguments","resourceReferences","portalItem","paths","userHasEditingPrivileges","destroy","_get","removeOrigin","_set","readPortalItem","itemId","portal","writePortalItem","loadFromPortal","load","instance","supportedTypes","validateItem","supportsData","layerModuleTypeMap","getLogger","declaredClass","warn","title","finishLoadEditablePortalLayer","_fetchUserHasEditingPrivileges","catch","url","findCredential","P","credential","user","_fetchEditingUser","privileges","includes","findServerInfo","owningSystemUrl","getDefault","loaded","restUrl","signal","authMode","query","ok","fromJSON","value","data","read","layer","write","messages","push","type","prototype","String","clonable","readOnly","PortalLayer"],"sources":["E:/各个学科/论文/毕业论文/Atmosphere/eco-friendly/node_modules/@arcgis/core/layers/mixins/PortalLayer.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.25/esri/copyright.txt for details.\n*/\nimport{_ as t}from\"../../chunks/tslib.es6.js\";import{id as e}from\"../../kernel.js\";import r from\"../../request.js\";import{result as s}from\"../../core/asyncUtils.js\";import o from\"../../core/Error.js\";import i from\"../../core/Logger.js\";import{destroyMaybe as a,isNone as l,isSome as p}from\"../../core/maybe.js\";import{throwIfAborted as n,isAbortError as m,throwIfAbortError as c}from\"../../core/promiseUtils.js\";import{normalize as u,hasSamePortal as d}from\"../../core/urlUtils.js\";import{property as h}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/arrayUtils.js\";import\"../../core/accessorSupport/ensureType.js\";import{reader as f}from\"../../core/accessorSupport/decorators/reader.js\";import{subclass as y}from\"../../core/accessorSupport/decorators/subclass.js\";import{writer as g}from\"../../core/accessorSupport/decorators/writer.js\";import I from\"../../portal/Portal.js\";import j from\"../../portal/PortalItem.js\";import w from\"../../portal/PortalUser.js\";const v=v=>{let U=class extends v{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0}destroy(){this.portalItem=a(this.portalItem)}set portalItem(t){t!==this._get(\"portalItem\")&&(this.removeOrigin(\"portal-item\"),this._set(\"portalItem\",t))}readPortalItem(t,e,r){if(e.itemId)return new j({id:e.itemId,portal:r&&r.portal})}writePortalItem(t,e){t&&t.id&&(e.itemId=t.id)}async loadFromPortal(t,e){if(this.portalItem&&this.portalItem.id)try{const r=await import(\"../../portal/support/layersLoader.js\");return n(e),await r.load({instance:this,supportedTypes:t.supportedTypes,validateItem:t.validateItem,supportsData:t.supportsData,layerModuleTypeMap:t.layerModuleTypeMap},e)}catch(r){throw m(r)||i.getLogger(this.declaredClass).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})\\n  ${r}`),r}}async finishLoadEditablePortalLayer(t){this._set(\"userHasEditingPrivileges\",await this._fetchUserHasEditingPrivileges(t).catch((t=>(c(t),!0))))}async _fetchUserHasEditingPrivileges(t){const r=this.url?e?.findCredential(this.url):null;if(!r)return!0;const s=P.credential===r?P.user:await this._fetchEditingUser(t);return P.credential=r,P.user=s,l(s)||null==s.privileges||s.privileges.includes(\"features:user:edit\")}async _fetchEditingUser(t){const o=this.portalItem?.portal?.user;if(o)return o;const i=e.findServerInfo(this.url??\"\");if(!i?.owningSystemUrl)return null;const a=`${i.owningSystemUrl}/sharing/rest`,l=I.getDefault();if(l&&l.loaded&&u(l.restUrl)===u(a))return l.user;const n=`${a}/community/self`,m=p(t)?t.signal:null,c=await s(r(n,{authMode:\"no-prompt\",query:{f:\"json\"},signal:m}));return c.ok?w.fromJSON(c.value.data):null}read(t,e){e&&(e.layer=this),super.read(t,e)}write(t,e){const r=e&&e.portal,s=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||I.getDefault());return r&&s&&!d(s.restUrl,r.restUrl)?(e.messages&&e.messages.push(new o(\"layer:cross-portal\",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,{layer:this})),null):super.write(t,{...e,layer:this})}};return t([h({type:j})],U.prototype,\"portalItem\",null),t([f(\"web-document\",\"portalItem\",[\"itemId\"])],U.prototype,\"readPortalItem\",null),t([g(\"web-document\",\"portalItem\",{itemId:{type:String}})],U.prototype,\"writePortalItem\",null),t([h({clonable:!1})],U.prototype,\"resourceReferences\",void 0),t([h({readOnly:!0})],U.prototype,\"userHasEditingPrivileges\",void 0),U=t([y(\"esri.layers.mixins.PortalLayer\")],U),U},P={credential:null,user:null};export{v as PortalLayer};\n"],"mappings":";;AAAA;AACA;AACA;AACA;AACA,SAAOA,CAAC,IAAIC,CAAZ,QAAkB,2BAAlB;AAA8C,SAAOC,EAAE,IAAIC,CAAb,QAAmB,iBAAnB;AAAqC,OAAOC,CAAP,MAAa,kBAAb;AAAgC,SAAOC,MAAM,IAAIC,CAAjB,QAAuB,0BAAvB;AAAkD,OAAOC,CAAP,MAAa,qBAAb;AAAmC,OAAOC,CAAP,MAAa,sBAAb;AAAoC,SAAOC,YAAY,IAAIC,CAAvB,EAAyBC,MAAM,IAAIC,CAAnC,EAAqCC,MAAM,IAAIC,CAA/C,QAAqD,qBAArD;AAA2E,SAAOC,cAAc,IAAIC,CAAzB,EAA2BC,YAAY,IAAIC,CAA3C,EAA6CC,iBAAiB,IAAIC,CAAlE,QAAwE,4BAAxE;AAAqG,SAAOC,SAAS,IAAIC,CAApB,EAAsBC,aAAa,IAAIC,CAAvC,QAA6C,wBAA7C;AAAsE,SAAOC,QAAQ,IAAIC,CAAnB,QAAyB,mDAAzB;AAA6E,OAAM,0BAAN;AAAiC,OAAM,0CAAN;AAAiD,SAAOC,MAAM,IAAIC,CAAjB,QAAuB,iDAAvB;AAAyE,SAAOC,QAAQ,IAAIC,CAAnB,QAAyB,mDAAzB;AAA6E,SAAOC,MAAM,IAAIC,CAAjB,QAAuB,iDAAvB;AAAyE,OAAOC,CAAP,MAAa,wBAAb;AAAsC,OAAOC,CAAP,MAAa,4BAAb;AAA0C,OAAOC,CAAP,MAAa,4BAAb;;AAA0C,MAAMC,CAAC,GAACA,CAAC,IAAE;EAAC,IAAIC,CAAC,GAAC,cAAcD,CAAd,CAAe;IAACE,WAAW,GAAE;MAAC,MAAM,GAAGC,SAAT,GAAoB,KAAKC,kBAAL,GAAwB;QAACC,UAAU,EAAC,IAAZ;QAAiBC,KAAK,EAAC;MAAvB,CAA5C,EAAuE,KAAKC,wBAAL,GAA8B,CAAC,CAAtG;IAAwG;;IAAAC,OAAO,GAAE;MAAC,KAAKH,UAAL,GAAgB/B,CAAC,CAAC,KAAK+B,UAAN,CAAjB;IAAmC;;IAAc,IAAVA,UAAU,CAACxC,CAAD,EAAG;MAACA,CAAC,KAAG,KAAK4C,IAAL,CAAU,YAAV,CAAJ,KAA8B,KAAKC,YAAL,CAAkB,aAAlB,GAAiC,KAAKC,IAAL,CAAU,YAAV,EAAuB9C,CAAvB,CAA/D;IAA0F;;IAAA+C,cAAc,CAAC/C,CAAD,EAAGE,CAAH,EAAKC,CAAL,EAAO;MAAC,IAAGD,CAAC,CAAC8C,MAAL,EAAY,OAAO,IAAIf,CAAJ,CAAM;QAAChC,EAAE,EAACC,CAAC,CAAC8C,MAAN;QAAaC,MAAM,EAAC9C,CAAC,IAAEA,CAAC,CAAC8C;MAAzB,CAAN,CAAP;IAA+C;;IAAAC,eAAe,CAAClD,CAAD,EAAGE,CAAH,EAAK;MAACF,CAAC,IAAEA,CAAC,CAACC,EAAL,KAAUC,CAAC,CAAC8C,MAAF,GAAShD,CAAC,CAACC,EAArB;IAAyB;;IAAoB,MAAdkD,cAAc,CAACnD,CAAD,EAAGE,CAAH,EAAK;MAAC,IAAG,KAAKsC,UAAL,IAAiB,KAAKA,UAAL,CAAgBvC,EAApC,EAAuC,IAAG;QAAC,MAAME,CAAC,GAAC,MAAM,OAAO,sCAAP,CAAd;QAA6D,OAAOY,CAAC,CAACb,CAAD,CAAD,EAAK,MAAMC,CAAC,CAACiD,IAAF,CAAO;UAACC,QAAQ,EAAC,IAAV;UAAeC,cAAc,EAACtD,CAAC,CAACsD,cAAhC;UAA+CC,YAAY,EAACvD,CAAC,CAACuD,YAA9D;UAA2EC,YAAY,EAACxD,CAAC,CAACwD,YAA1F;UAAuGC,kBAAkB,EAACzD,CAAC,CAACyD;QAA5H,CAAP,EAAuJvD,CAAvJ,CAAlB;MAA4K,CAA7O,CAA6O,OAAMC,CAAN,EAAQ;QAAC,MAAMc,CAAC,CAACd,CAAD,CAAD,IAAMI,CAAC,CAACmD,SAAF,CAAY,KAAKC,aAAjB,EAAgCC,IAAhC,CAAsC,yBAAwB,KAAKC,KAAM,KAAI,KAAK5D,EAAG,kBAAiB,KAAKuC,UAAL,CAAgBvC,EAAG,QAAOE,CAAE,EAAlI,CAAN,EAA2IA,CAAjJ;MAAmJ;IAAC;;IAAmC,MAA7B2D,6BAA6B,CAAC9D,CAAD,EAAG;MAAC,KAAK8C,IAAL,CAAU,0BAAV,EAAqC,MAAM,KAAKiB,8BAAL,CAAoC/D,CAApC,EAAuCgE,KAAvC,CAA8ChE,CAAC,KAAGmB,CAAC,CAACnB,CAAD,CAAD,EAAK,CAAC,CAAT,CAA/C,CAA3C;IAAyG;;IAAoC,MAA9B+D,8BAA8B,CAAC/D,CAAD,EAAG;MAAC,MAAMG,CAAC,GAAC,KAAK8D,GAAL,GAAS/D,CAAC,EAAEgE,cAAH,CAAkB,KAAKD,GAAvB,CAAT,GAAqC,IAA7C;MAAkD,IAAG,CAAC9D,CAAJ,EAAM,OAAM,CAAC,CAAP;MAAS,MAAME,CAAC,GAAC8D,CAAC,CAACC,UAAF,KAAejE,CAAf,GAAiBgE,CAAC,CAACE,IAAnB,GAAwB,MAAM,KAAKC,iBAAL,CAAuBtE,CAAvB,CAAtC;MAAgE,OAAOmE,CAAC,CAACC,UAAF,GAAajE,CAAb,EAAegE,CAAC,CAACE,IAAF,GAAOhE,CAAtB,EAAwBM,CAAC,CAACN,CAAD,CAAD,IAAM,QAAMA,CAAC,CAACkE,UAAd,IAA0BlE,CAAC,CAACkE,UAAF,CAAaC,QAAb,CAAsB,oBAAtB,CAAzD;IAAqG;;IAAuB,MAAjBF,iBAAiB,CAACtE,CAAD,EAAG;MAAC,MAAMM,CAAC,GAAC,KAAKkC,UAAL,EAAiBS,MAAjB,EAAyBoB,IAAjC;MAAsC,IAAG/D,CAAH,EAAK,OAAOA,CAAP;MAAS,MAAMC,CAAC,GAACL,CAAC,CAACuE,cAAF,CAAiB,KAAKR,GAAL,IAAU,EAA3B,CAAR;MAAuC,IAAG,CAAC1D,CAAC,EAAEmE,eAAP,EAAuB,OAAO,IAAP;MAAY,MAAMjE,CAAC,GAAE,GAAEF,CAAC,CAACmE,eAAgB,eAA7B;MAAA,MAA4C/D,CAAC,GAACqB,CAAC,CAAC2C,UAAF,EAA9C;MAA6D,IAAGhE,CAAC,IAAEA,CAAC,CAACiE,MAAL,IAAavD,CAAC,CAACV,CAAC,CAACkE,OAAH,CAAD,KAAexD,CAAC,CAACZ,CAAD,CAAhC,EAAoC,OAAOE,CAAC,CAAC0D,IAAT;MAAc,MAAMtD,CAAC,GAAE,GAAEN,CAAE,iBAAb;MAAA,MAA8BQ,CAAC,GAACJ,CAAC,CAACb,CAAD,CAAD,GAAKA,CAAC,CAAC8E,MAAP,GAAc,IAA9C;MAAA,MAAmD3D,CAAC,GAAC,MAAMd,CAAC,CAACF,CAAC,CAACY,CAAD,EAAG;QAACgE,QAAQ,EAAC,WAAV;QAAsBC,KAAK,EAAC;UAACrD,CAAC,EAAC;QAAH,CAA5B;QAAuCmD,MAAM,EAAC7D;MAA9C,CAAH,CAAF,CAA5D;MAAoH,OAAOE,CAAC,CAAC8D,EAAF,GAAK/C,CAAC,CAACgD,QAAF,CAAW/D,CAAC,CAACgE,KAAF,CAAQC,IAAnB,CAAL,GAA8B,IAArC;IAA0C;;IAAAC,IAAI,CAACrF,CAAD,EAAGE,CAAH,EAAK;MAACA,CAAC,KAAGA,CAAC,CAACoF,KAAF,GAAQ,IAAX,CAAD,EAAkB,MAAMD,IAAN,CAAWrF,CAAX,EAAaE,CAAb,CAAlB;IAAkC;;IAAAqF,KAAK,CAACvF,CAAD,EAAGE,CAAH,EAAK;MAAC,MAAMC,CAAC,GAACD,CAAC,IAAEA,CAAC,CAAC+C,MAAb;MAAA,MAAoB5C,CAAC,GAAC,KAAKmC,UAAL,IAAiB,KAAKA,UAAL,CAAgBvC,EAAjC,KAAsC,KAAKuC,UAAL,CAAgBS,MAAhB,IAAwBjB,CAAC,CAAC2C,UAAF,EAA9D,CAAtB;MAAoG,OAAOxE,CAAC,IAAEE,CAAH,IAAM,CAACkB,CAAC,CAAClB,CAAC,CAACwE,OAAH,EAAW1E,CAAC,CAAC0E,OAAb,CAAR,IAA+B3E,CAAC,CAACsF,QAAF,IAAYtF,CAAC,CAACsF,QAAF,CAAWC,IAAX,CAAgB,IAAInF,CAAJ,CAAM,oBAAN,EAA4B,cAAa,KAAKuD,KAAM,KAAI,KAAK5D,EAAG,+MAAhE,EAA+Q;QAACqF,KAAK,EAAC;MAAP,CAA/Q,CAAhB,CAAZ,EAA0T,IAAzV,IAA+V,MAAMC,KAAN,CAAYvF,CAAZ,EAAc,EAAC,GAAGE,CAAJ;QAAMoF,KAAK,EAAC;MAAZ,CAAd,CAAtW;IAAuY;;EAAhsE,CAArB;EAAutE,OAAOtF,CAAC,CAAC,CAACyB,CAAC,CAAC;IAACiE,IAAI,EAACzD;EAAN,CAAD,CAAF,CAAD,EAAeG,CAAC,CAACuD,SAAjB,EAA2B,YAA3B,EAAwC,IAAxC,CAAD,EAA+C3F,CAAC,CAAC,CAAC2B,CAAC,CAAC,cAAD,EAAgB,YAAhB,EAA6B,CAAC,QAAD,CAA7B,CAAF,CAAD,EAA6CS,CAAC,CAACuD,SAA/C,EAAyD,gBAAzD,EAA0E,IAA1E,CAAhD,EAAgI3F,CAAC,CAAC,CAAC+B,CAAC,CAAC,cAAD,EAAgB,YAAhB,EAA6B;IAACiB,MAAM,EAAC;MAAC0C,IAAI,EAACE;IAAN;EAAR,CAA7B,CAAF,CAAD,EAAyDxD,CAAC,CAACuD,SAA3D,EAAqE,iBAArE,EAAuF,IAAvF,CAAjI,EAA8N3F,CAAC,CAAC,CAACyB,CAAC,CAAC;IAACoE,QAAQ,EAAC,CAAC;EAAX,CAAD,CAAF,CAAD,EAAoBzD,CAAC,CAACuD,SAAtB,EAAgC,oBAAhC,EAAqD,KAAK,CAA1D,CAA/N,EAA4R3F,CAAC,CAAC,CAACyB,CAAC,CAAC;IAACqE,QAAQ,EAAC,CAAC;EAAX,CAAD,CAAF,CAAD,EAAoB1D,CAAC,CAACuD,SAAtB,EAAgC,0BAAhC,EAA2D,KAAK,CAAhE,CAA7R,EAAgWvD,CAAC,GAACpC,CAAC,CAAC,CAAC6B,CAAC,CAAC,gCAAD,CAAF,CAAD,EAAuCO,CAAvC,CAAnW,EAA6YA,CAApZ;AAAsZ,CAAznF;AAAA,MAA0nF+B,CAAC,GAAC;EAACC,UAAU,EAAC,IAAZ;EAAiBC,IAAI,EAAC;AAAtB,CAA5nF;;AAAwpF,SAAOlC,CAAC,IAAI4D,WAAZ"},"metadata":{},"sourceType":"module"}