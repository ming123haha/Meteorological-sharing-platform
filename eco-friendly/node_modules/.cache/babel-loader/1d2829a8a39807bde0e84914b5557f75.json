{"ast":null,"code":"/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.25/esri/copyright.txt for details.\n*/\nimport e from \"../../../../../core/Error.js\";\nimport t from \"../../../../../core/Logger.js\";\nimport { isSome as r } from \"../../../../../core/maybe.js\";\nimport { isAbortError as a, throwIfAborted as s, throwIfNotAbortError as i } from \"../../../../../core/promiseUtils.js\";\nimport { BaseFeatureSource as o } from \"./BaseFeatureSource.js\";\n\nclass n extends o {\n  constructor(e) {\n    super(e);\n  }\n\n  async _fetchDataTile(r) {\n    const i = 6,\n          o = 20,\n          n = this._subscriptions.get(r.key.id);\n\n    let d = !1,\n        c = 0,\n        u = 0;\n\n    const p = (e, t) => {\n      u--, s(n);\n      const a = r.id,\n            i = e.reader,\n            o = e.query;\n\n      if (!i.exceededTransferLimit) {\n        if (d = !0, 0 !== t && !i.hasFeatures) {\n          const e = {\n            id: a,\n            addOrUpdate: i,\n            end: 0 === u,\n            type: \"append\"\n          };\n          return n.add({\n            message: e,\n            query: o\n          }), void this._onMessage(e);\n        }\n\n        const e = {\n          id: a,\n          addOrUpdate: i,\n          end: 0 === u,\n          type: \"append\"\n        };\n        return n.add({\n          message: e,\n          query: o\n        }), void this._onMessage(e);\n      }\n\n      const c = {\n        id: a,\n        addOrUpdate: i,\n        end: d && 0 === u,\n        type: \"append\"\n      };\n      n.add({\n        message: c,\n        query: o\n      }), this._onMessage(c);\n    };\n\n    let h = 0,\n        m = 0;\n\n    for (; !d && m++ < o;) {\n      let o;\n\n      for (let s = 0; s < h + 1; s++) {\n        const s = c++;\n        u++, o = this._fetchDataTilePage(r, s, n).then(e => e && p(e, s)).catch(s => {\n          d = !0, a(s) || (t.getLogger(\"esri.views.2d.layers.features.sources.PagedFeatureSource\").error(new e(\"mapview-query-error\", \"Encountered error when fetching tile\", {\n            tile: r,\n            error: s\n          })), this._onMessage({\n            id: r.id,\n            addOrUpdate: null,\n            end: d,\n            type: \"append\"\n          }));\n        });\n      }\n\n      await o, s(n), h = Math.min(h + 2, i);\n    }\n  }\n\n  async _fetchDataTilePage(e, t, a) {\n    s(a);\n    const o = this._queryInfo,\n          n = {\n      start: this.pageSize * t,\n      num: this.pageSize,\n      returnExceededLimitFeatures: !0,\n      quantizationParameters: e.getQuantizationParameters()\n    };\n    r(this.maxRecordCountFactor) && (n.maxRecordCountFactor = this.maxRecordCountFactor);\n    const d = this.createTileQuery(e, n);\n\n    try {\n      const r = a.signal,\n            i = await this._queue.push({\n        tile: e,\n        query: d,\n        signal: r,\n        depth: t\n      });\n      return s(a), i ? o !== this._queryInfo ? this._fetchDataTilePage(e, t, a) : {\n        reader: i,\n        query: d\n      } : null;\n    } catch (c) {\n      return i(c), null;\n    }\n  }\n\n}\n\nexport { n as PagedFeatureSource };","map":{"version":3,"names":["e","t","isSome","r","isAbortError","a","throwIfAborted","s","throwIfNotAbortError","i","BaseFeatureSource","o","n","constructor","_fetchDataTile","_subscriptions","get","key","id","d","c","u","p","reader","query","exceededTransferLimit","hasFeatures","addOrUpdate","end","type","add","message","_onMessage","h","m","_fetchDataTilePage","then","catch","getLogger","error","tile","Math","min","_queryInfo","start","pageSize","num","returnExceededLimitFeatures","quantizationParameters","getQuantizationParameters","maxRecordCountFactor","createTileQuery","signal","_queue","push","depth","PagedFeatureSource"],"sources":["E:/各个学科/论文/毕业论文/Atmosphere/eco-friendly/node_modules/@arcgis/core/views/2d/layers/features/sources/PagedFeatureSource.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.25/esri/copyright.txt for details.\n*/\nimport e from\"../../../../../core/Error.js\";import t from\"../../../../../core/Logger.js\";import{isSome as r}from\"../../../../../core/maybe.js\";import{isAbortError as a,throwIfAborted as s,throwIfNotAbortError as i}from\"../../../../../core/promiseUtils.js\";import{BaseFeatureSource as o}from\"./BaseFeatureSource.js\";class n extends o{constructor(e){super(e)}async _fetchDataTile(r){const i=6,o=20,n=this._subscriptions.get(r.key.id);let d=!1,c=0,u=0;const p=(e,t)=>{u--,s(n);const a=r.id,i=e.reader,o=e.query;if(!i.exceededTransferLimit){if(d=!0,0!==t&&!i.hasFeatures){const e={id:a,addOrUpdate:i,end:0===u,type:\"append\"};return n.add({message:e,query:o}),void this._onMessage(e)}const e={id:a,addOrUpdate:i,end:0===u,type:\"append\"};return n.add({message:e,query:o}),void this._onMessage(e)}const c={id:a,addOrUpdate:i,end:d&&0===u,type:\"append\"};n.add({message:c,query:o}),this._onMessage(c)};let h=0,m=0;for(;!d&&m++<o;){let o;for(let s=0;s<h+1;s++){const s=c++;u++,o=this._fetchDataTilePage(r,s,n).then((e=>e&&p(e,s))).catch((s=>{d=!0,a(s)||(t.getLogger(\"esri.views.2d.layers.features.sources.PagedFeatureSource\").error(new e(\"mapview-query-error\",\"Encountered error when fetching tile\",{tile:r,error:s})),this._onMessage({id:r.id,addOrUpdate:null,end:d,type:\"append\"}))}))}await o,s(n),h=Math.min(h+2,i)}}async _fetchDataTilePage(e,t,a){s(a);const o=this._queryInfo,n={start:this.pageSize*t,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:e.getQuantizationParameters()};r(this.maxRecordCountFactor)&&(n.maxRecordCountFactor=this.maxRecordCountFactor);const d=this.createTileQuery(e,n);try{const r=a.signal,i=await this._queue.push({tile:e,query:d,signal:r,depth:t});return s(a),i?o!==this._queryInfo?this._fetchDataTilePage(e,t,a):{reader:i,query:d}:null}catch(c){return i(c),null}}}export{n as PagedFeatureSource};\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA,OAAOA,CAAP,MAAa,8BAAb;AAA4C,OAAOC,CAAP,MAAa,+BAAb;AAA6C,SAAOC,MAAM,IAAIC,CAAjB,QAAuB,8BAAvB;AAAsD,SAAOC,YAAY,IAAIC,CAAvB,EAAyBC,cAAc,IAAIC,CAA3C,EAA6CC,oBAAoB,IAAIC,CAArE,QAA2E,qCAA3E;AAAiH,SAAOC,iBAAiB,IAAIC,CAA5B,QAAkC,wBAAlC;;AAA2D,MAAMC,CAAN,SAAgBD,CAAhB,CAAiB;EAACE,WAAW,CAACb,CAAD,EAAG;IAAC,MAAMA,CAAN;EAAS;;EAAoB,MAAdc,cAAc,CAACX,CAAD,EAAG;IAAC,MAAMM,CAAC,GAAC,CAAR;IAAA,MAAUE,CAAC,GAAC,EAAZ;IAAA,MAAeC,CAAC,GAAC,KAAKG,cAAL,CAAoBC,GAApB,CAAwBb,CAAC,CAACc,GAAF,CAAMC,EAA9B,CAAjB;;IAAmD,IAAIC,CAAC,GAAC,CAAC,CAAP;IAAA,IAASC,CAAC,GAAC,CAAX;IAAA,IAAaC,CAAC,GAAC,CAAf;;IAAiB,MAAMC,CAAC,GAAC,CAACtB,CAAD,EAAGC,CAAH,KAAO;MAACoB,CAAC,IAAGd,CAAC,CAACK,CAAD,CAAL;MAAS,MAAMP,CAAC,GAACF,CAAC,CAACe,EAAV;MAAA,MAAaT,CAAC,GAACT,CAAC,CAACuB,MAAjB;MAAA,MAAwBZ,CAAC,GAACX,CAAC,CAACwB,KAA5B;;MAAkC,IAAG,CAACf,CAAC,CAACgB,qBAAN,EAA4B;QAAC,IAAGN,CAAC,GAAC,CAAC,CAAH,EAAK,MAAIlB,CAAJ,IAAO,CAACQ,CAAC,CAACiB,WAAlB,EAA8B;UAAC,MAAM1B,CAAC,GAAC;YAACkB,EAAE,EAACb,CAAJ;YAAMsB,WAAW,EAAClB,CAAlB;YAAoBmB,GAAG,EAAC,MAAIP,CAA5B;YAA8BQ,IAAI,EAAC;UAAnC,CAAR;UAAqD,OAAOjB,CAAC,CAACkB,GAAF,CAAM;YAACC,OAAO,EAAC/B,CAAT;YAAWwB,KAAK,EAACb;UAAjB,CAAN,GAA2B,KAAK,KAAKqB,UAAL,CAAgBhC,CAAhB,CAAvC;QAA0D;;QAAA,MAAMA,CAAC,GAAC;UAACkB,EAAE,EAACb,CAAJ;UAAMsB,WAAW,EAAClB,CAAlB;UAAoBmB,GAAG,EAAC,MAAIP,CAA5B;UAA8BQ,IAAI,EAAC;QAAnC,CAAR;QAAqD,OAAOjB,CAAC,CAACkB,GAAF,CAAM;UAACC,OAAO,EAAC/B,CAAT;UAAWwB,KAAK,EAACb;QAAjB,CAAN,GAA2B,KAAK,KAAKqB,UAAL,CAAgBhC,CAAhB,CAAvC;MAA0D;;MAAA,MAAMoB,CAAC,GAAC;QAACF,EAAE,EAACb,CAAJ;QAAMsB,WAAW,EAAClB,CAAlB;QAAoBmB,GAAG,EAACT,CAAC,IAAE,MAAIE,CAA/B;QAAiCQ,IAAI,EAAC;MAAtC,CAAR;MAAwDjB,CAAC,CAACkB,GAAF,CAAM;QAACC,OAAO,EAACX,CAAT;QAAWI,KAAK,EAACb;MAAjB,CAAN,GAA2B,KAAKqB,UAAL,CAAgBZ,CAAhB,CAA3B;IAA8C,CAA3b;;IAA4b,IAAIa,CAAC,GAAC,CAAN;IAAA,IAAQC,CAAC,GAAC,CAAV;;IAAY,OAAK,CAACf,CAAD,IAAIe,CAAC,KAAGvB,CAAb,GAAgB;MAAC,IAAIA,CAAJ;;MAAM,KAAI,IAAIJ,CAAC,GAAC,CAAV,EAAYA,CAAC,GAAC0B,CAAC,GAAC,CAAhB,EAAkB1B,CAAC,EAAnB,EAAsB;QAAC,MAAMA,CAAC,GAACa,CAAC,EAAT;QAAYC,CAAC,IAAGV,CAAC,GAAC,KAAKwB,kBAAL,CAAwBhC,CAAxB,EAA0BI,CAA1B,EAA4BK,CAA5B,EAA+BwB,IAA/B,CAAqCpC,CAAC,IAAEA,CAAC,IAAEsB,CAAC,CAACtB,CAAD,EAAGO,CAAH,CAA5C,EAAoD8B,KAApD,CAA2D9B,CAAC,IAAE;UAACY,CAAC,GAAC,CAAC,CAAH,EAAKd,CAAC,CAACE,CAAD,CAAD,KAAON,CAAC,CAACqC,SAAF,CAAY,0DAAZ,EAAwEC,KAAxE,CAA8E,IAAIvC,CAAJ,CAAM,qBAAN,EAA4B,sCAA5B,EAAmE;YAACwC,IAAI,EAACrC,CAAN;YAAQoC,KAAK,EAAChC;UAAd,CAAnE,CAA9E,GAAoK,KAAKyB,UAAL,CAAgB;YAACd,EAAE,EAACf,CAAC,CAACe,EAAN;YAASS,WAAW,EAAC,IAArB;YAA0BC,GAAG,EAACT,CAA9B;YAAgCU,IAAI,EAAC;UAArC,CAAhB,CAA3K,CAAL;QAAiP,CAAhT,CAAN;MAAyT;;MAAA,MAAMlB,CAAN,EAAQJ,CAAC,CAACK,CAAD,CAAT,EAAaqB,CAAC,GAACQ,IAAI,CAACC,GAAL,CAAST,CAAC,GAAC,CAAX,EAAaxB,CAAb,CAAf;IAA+B;EAAC;;EAAwB,MAAlB0B,kBAAkB,CAACnC,CAAD,EAAGC,CAAH,EAAKI,CAAL,EAAO;IAACE,CAAC,CAACF,CAAD,CAAD;IAAK,MAAMM,CAAC,GAAC,KAAKgC,UAAb;IAAA,MAAwB/B,CAAC,GAAC;MAACgC,KAAK,EAAC,KAAKC,QAAL,GAAc5C,CAArB;MAAuB6C,GAAG,EAAC,KAAKD,QAAhC;MAAyCE,2BAA2B,EAAC,CAAC,CAAtE;MAAwEC,sBAAsB,EAAChD,CAAC,CAACiD,yBAAF;IAA/F,CAA1B;IAAwJ9C,CAAC,CAAC,KAAK+C,oBAAN,CAAD,KAA+BtC,CAAC,CAACsC,oBAAF,GAAuB,KAAKA,oBAA3D;IAAiF,MAAM/B,CAAC,GAAC,KAAKgC,eAAL,CAAqBnD,CAArB,EAAuBY,CAAvB,CAAR;;IAAkC,IAAG;MAAC,MAAMT,CAAC,GAACE,CAAC,CAAC+C,MAAV;MAAA,MAAiB3C,CAAC,GAAC,MAAM,KAAK4C,MAAL,CAAYC,IAAZ,CAAiB;QAACd,IAAI,EAACxC,CAAN;QAAQwB,KAAK,EAACL,CAAd;QAAgBiC,MAAM,EAACjD,CAAvB;QAAyBoD,KAAK,EAACtD;MAA/B,CAAjB,CAAzB;MAA6E,OAAOM,CAAC,CAACF,CAAD,CAAD,EAAKI,CAAC,GAACE,CAAC,KAAG,KAAKgC,UAAT,GAAoB,KAAKR,kBAAL,CAAwBnC,CAAxB,EAA0BC,CAA1B,EAA4BI,CAA5B,CAApB,GAAmD;QAACkB,MAAM,EAACd,CAAR;QAAUe,KAAK,EAACL;MAAhB,CAApD,GAAuE,IAApF;IAAyF,CAA1K,CAA0K,OAAMC,CAAN,EAAQ;MAAC,OAAOX,CAAC,CAACW,CAAD,CAAD,EAAK,IAAZ;IAAiB;EAAC;;AAAr8C;;AAAs8C,SAAOR,CAAC,IAAI4C,kBAAZ"},"metadata":{},"sourceType":"module"}